<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeLo ç›´æ’­å¹³å° - å°ˆæ¥­ç›´æ’­è§£æ±ºæ–¹æ¡ˆ</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/vibelo-logo.png">
    <link rel="shortcut icon" type="image/png" href="images/vibelo-logo.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="livestream-platform.css">
    
    <style>
        /* ç”¨æˆ¶ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .user-avatar {
            position: relative;
            cursor: pointer;
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            padding: 1rem 0;
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .user-dropdown.show {
            opacity: 1;
            transform: translateY(0);
        }

        .menu-user-info {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            margin-bottom: 0.5rem;
        }

        .menu-user-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .menu-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: #666;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .menu-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .menu-link.logout {
            border-top: 1px solid #f0f0f0;
            margin-top: 0.5rem;
            color: #e74c3c;
        }

        .menu-link.logout:hover {
            background: rgba(231, 76, 60, 0.1);
        }
    </style>
</head>

<body>
    <svg class="lightning-filter-defs" aria-hidden="true" focusable="false"
        style="position: absolute; width: 0; height: 0;">
        <defs>
            <filter id="turbulent-displace" color-interpolation-filters="sRGB" x="-20%" y="-20%" width="140%" height="140%">
                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise1" seed="1" />
                <feOffset in="noise1" dx="0" dy="0" result="offsetNoise1">
                    <animate attributeName="dy" values="700;0" dur="6s" repeatCount="indefinite" calcMode="linear" />
                </feOffset>

                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise2" seed="1" />
                <feOffset in="noise2" dx="0" dy="0" result="offsetNoise2">
                    <animate attributeName="dy" values="0;-700" dur="6s" repeatCount="indefinite" calcMode="linear" />
                </feOffset>

                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise3" seed="2" />
                <feOffset in="noise3" dx="0" dy="0" result="offsetNoise3">
                    <animate attributeName="dx" values="490;0" dur="6s" repeatCount="indefinite" calcMode="linear" />
                </feOffset>

                <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise4" seed="2" />
                <feOffset in="noise4" dx="0" dy="0" result="offsetNoise4">
                    <animate attributeName="dx" values="0;-490" dur="6s" repeatCount="indefinite" calcMode="linear" />
                </feOffset>

                <feComposite in="offsetNoise1" in2="offsetNoise2" result="part1" />
                <feComposite in="offsetNoise3" in2="offsetNoise4" result="part2" />
                <feBlend in="part1" in2="part2" mode="color-dodge" result="combinedNoise" />

                <feDisplacementMap in="SourceGraphic" in2="combinedNoise" scale="30" xChannelSelector="R" yChannelSelector="B" />
            </filter>
        </defs>
    </svg>
    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="images/vibelo-logo.png" alt="VibeLo" style="height: 45px; width: auto; margin-bottom: 0px;">
                <h2 class="logo-text" style="display: none;">VibeLo</h2>
            </a>

            <div class="nav-links">
                <a href="index.html" class="nav-link">é¦–é </a>
                <a href="browse.html" class="nav-link">ç€è¦½ç›´æ’­</a>
                <a href="livestream_platform.html" class="nav-link active">é–‹å§‹ç›´æ’­</a>
                <a href="contact.html" class="nav-link">è¯çµ¡æˆ‘å€‘</a>
            </div>

            <div class="user-menu">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">ä¸Šç·š</span>
                </div>
                <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="main-content">
        <!-- ç‰¹æ•ˆé¢æ¿ -->
        <div class="effects-panel">
            <div class="effects-header">
                <i class="fas fa-magic"></i>
                <h3>è¦–è¦ºç‰¹æ•ˆ</h3>
            </div>

            <div class="effect-category">
                <h4><i class="fas fa-palette"></i> æ¿¾é¡æ•ˆæœ</h4>
                <div class="effect-grid">
                    <button class="effect-btn" data-effect="blur">
                        <i class="fas fa-tint"></i><br>æ¨¡ç³Š
                    </button>
                    <button class="effect-btn" data-effect="rainbow">
                        <i class="fas fa-rainbow"></i><br>å½©è™¹
                    </button>
                    <button class="effect-btn" data-effect="bw">
                        <i class="fas fa-eye"></i><br>é»‘ç™½
                    </button>
                    <button class="effect-btn" data-effect="sepia">
                        <i class="fas fa-sun"></i><br>æ‡·èˆŠ
                    </button>
                    <button class="effect-btn" data-effect="warm">
                        <i class="fas fa-palette"></i><br>æš–è‰²èª¿
                    </button>
                    <button class="effect-btn" data-effect="invert">
                        <i class="fas fa-adjust"></i><br>åç›¸
                    </button>
                </div>
            </div>

            <div class="effect-category">
                <h4><i class="fas fa-sparkles"></i> ç¾é¡ç‰¹æ•ˆ</h4>
                <div class="effect-grid">
                    <button class="effect-btn" data-effect="glasses">
                        <i class="fas fa-glasses"></i><br>æˆ´çœ¼é¡
                    </button>
                    <button class="effect-btn" data-effect="dog">
                        <i class="fas fa-dog"></i><br>ç‹—ç‹—
                    </button>
                    <button class="effect-btn" data-effect="pingo">
                        <i class="fas fa-drum"></i><br>çš®é¼“
                    </button>
                    <button class="effect-btn" data-effect="sech">
                        <i class="fas fa-theater-masks"></i><br>ä¸–é–“
                    </button>
                    <button class="effect-btn" data-effect="laixiong">
                        <i class="fas fa-user-ninja"></i><br>è³´å…„
                    </button>
                    <button class="effect-btn" data-effect="maoZed">
                        <i class="fas fa-user-tie"></i><br>æ¯›ä¸»å¸­
                    </button>
                    <button class="effect-btn" data-effect="laogao">
                        <i class="fas fa-user-astronaut"></i><br>è€é«˜
                    </button>
                    <button class="effect-btn" data-effect="guodong">
                        <i class="fas fa-user-graduate"></i><br>åœ‹æ£Ÿ
                    </button>
                    <button class="effect-btn" data-effect="huoguo">
                        <i class="fas fa-hot-tub"></i><br>ç«é‹
                    </button>
                    <button class="effect-btn" data-effect="hsinchu">
                        <i class="fas fa-city"></i><br>æ–°ç«¹
                    </button>
                    <button class="effect-btn" data-effect="car">
                        <i class="fas fa-car"></i><br>è»Š
                    </button>
                    <button class="effect-btn" data-effect="car2">
                        <i class="fas fa-car-side"></i><br>ä¸Šè»Š
                    </button>
                    <button class="effect-btn" data-effect="look">
                        <i class="fas fa-mask"></i><br>å›ç­”æˆ‘
                    </button>
                    <button class="effect-btn" data-effect="lumumu">
                        <i class="fas fa-user-ninja"></i><br>ç§€ç‡•
                    </button>
                    <button class="effect-btn" data-effect="chiikawa">
                        <i class="fas fa-cat"></i><br>å‰ä¼Šå¡å“‡
                    </button>
                    <button class="effect-btn" data-effect="cat">
                        <i class="fas fa-paw"></i><br>å“ˆåŸºç±³
                    </button>
                    <button class="effect-btn" data-effect="polar">
                        <i class="fas fa-icicles"></i><br>åŒ—æ¥µç†Š
                    </button>
                    <button class="effect-btn" data-effect="bright">
                        <i class="fas fa-sun"></i><br>ç¾ç™½
                    </button>
                </div>
            </div>

            <div class="effect-category">
                <h4><i class="fas fa-sparkles"></i> å‹•ç•«ç‰¹æ•ˆ</h4>
                <div class="effect-grid">
                    <button class="effect-btn" data-effect="particles">
                        <i class="fas fa-star"></i><br>ç²’å­
                    </button>
                    <button class="effect-btn" data-effect="hearts">
                        <i class="fas fa-heart"></i><br>æ„›å¿ƒ
                    </button>
                    <button class="effect-btn" data-effect="confetti">
                        <i class="fas fa-star-and-crescent"></i><br>å½©å¸¶
                    </button>
                    <button class="effect-btn" data-effect="snow">
                        <i class="fas fa-snowflake"></i><br>é›ªèŠ±
                    </button>
                </div>
            </div>

            <div class="effect-category">
                <h4><i class="fas fa-border-all"></i> é‚Šæ¡†æ¨£å¼</h4>
                <div class="effect-grid">
                    <button class="effect-btn" data-effect="neon">
                        <i class="fas fa-highlighter"></i><br>éœ“è™¹
                    </button>
                    <button class="effect-btn" data-effect="glow">
                        <i class="fas fa-bolt"></i><br>é–ƒé›»
                    </button>
                    <button class="effect-btn" data-effect="rainbowBorder">
                        <i class="fas fa-border-style"></i><br>å½©è™¹
                    </button>
                    <button class="effect-btn" data-effect="clear">
                        <i class="fas fa-times"></i><br>æ¸…é™¤
                    </button>
                </div>
            </div>
        </div>

        <!-- ç›´æ’­ç•«é¢å€åŸŸ -->
        <div class="stream-area">
            <div class="stream-header">
                <h3><i class="fas fa-video"></i> ç›´æ’­ç•«é¢</h3>
                <div class="status-indicator">
                    <div class="status-dot" id="streamStatusDot"></div>
                    <span id="streamStatusText">æº–å‚™ä¸­</span>
                </div>
            </div>

            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                <div id="previewPlaceholder" class="video-placeholder">
                    <div class="placeholder-content">
                        <i class="fas fa-video"></i>
                        <h4>æº–å‚™é–‹å§‹ç›´æ’­</h4>
                        <p>é»æ“Šå³å´æ§åˆ¶é¢æ¿çš„ã€Œé–‹å§‹ç›´æ’­ã€æŒ‰éˆ•</p>
                    </div>
                </div>
                <div class="video-overlay" id="videoOverlay" style="display: none;">
                    <span class="live-indicator">
                        <i class="fas fa-circle"></i> ç›´æ’­ä¸­
                    </span>
                    <span class="quality-indicator">
                        ç•«è³ª: <span id="currentQuality">720p</span>
                    </span>
                </div>
            </div>

            <div class="quality-controls">
                <label><i class="fas fa-cog"></i> ç•«è³ªè¨­å®š:</label>
                <select id="qualitySelect" onchange="changeQuality()">
                    <option value="480">480p</option>
                    <option value="720" selected>720p</option>
                    <option value="1080">1080p</option>
                </select>
            </div>

            <!-- ç›´æ’­æ¨™é¡Œè¨­å®š -->
            <div class="stream-title-section">
                <label><i class="fas fa-edit"></i> ç›´æ’­æ¨™é¡Œ:</label>
                <input type="text" id="streamTitleInput" class="stream-title-input" placeholder="è¼¸å…¥ä½ çš„ç›´æ’­æ¨™é¡Œ..."
                    maxlength="100" oninput="onTitleInput()" onchange="updateStreamTitle()"
                    onkeypress="handleTitleKeyPress(event)">
                <div class="current-title" id="currentTitle">
                    ç›®å‰æ¨™é¡Œ: æœªè¨­å®š
                </div>
            </div>
        </div>

        <!-- ç›´æ’­æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h3><i class="fas fa-sliders-h"></i> ç›´æ’­æ§åˆ¶</h3>

            <button class="btn-primary" id="streamBtn">
                <i class="fas fa-play-circle"></i> é–‹å§‹ç›´æ’­
            </button>

            <div class="control-buttons">
                <button class="btn-control" id="videoBtn">
                    <i class="fas fa-video"></i>
                </button>
                <button class="btn-control" id="audioBtn">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="btn-control" id="screenBtn">
                    <i class="fas fa-desktop"></i>
                </button>
                <button class="btn-control" id="tabAudioBtn" title="èƒŒæ™¯éŸ³æ¨‚åˆ†äº« - é»æ“Šåˆ†äº«åˆ†é éŸ³è¨Šçµ¦è§€çœ¾">
                    <i class="fas fa-volume-off"></i>
                </button>
            </div>

            <div class="device-selection">
                <div class="select-group">
                    <label><i class="fas fa-camera"></i> æ”å½±æ©Ÿ</label>
                    <select id="cameraSelect" onchange="switchVideoDevice()">
                        <option>è¼‰å…¥ä¸­...</option>
                    </select>
                </div>

                <div class="select-group">
                    <label><i class="fas fa-microphone"></i> éº¥å…‹é¢¨</label>
                    <select id="microphoneSelect" onchange="switchAudioDevice()">
                        <option>è¼‰å…¥ä¸­...</option>
                    </select>
                </div>

                <div class="select-group">
                    <label><i class="fas fa-volume-up"></i> éŸ³è¨Šè¼¸å‡º</label>
                    <select id="audioOutputSelect" onchange="switchAudioOutput()">
                        <option>è¼‰å…¥ä¸­...</option>
                    </select>
                </div>
            </div>

            <div class="stream-status">
                <div class="status-row">
                    <span><i class="fas fa-eye"></i> è§€çœ‹äººæ•¸:</span>
                    <span id="viewerCount">0</span>
                </div>
                <div class="status-row">
                    <span><i class="fas fa-clock"></i> ç›´æ’­æ™‚é–“:</span>
                    <span id="duration">00:00:00</span>
                </div>
            </div>
            
            <!-- å¤šä¸»æ’­ç‹€æ…‹ -->
            <div class="multi-broadcaster-status">
                <h4><i class="fas fa-users"></i> å…¶ä»–ä¸»æ’­</h4>
                <div class="broadcaster-list" id="otherBroadcastersList">
                    <div class="no-broadcasters">æš«ç„¡å…¶ä»–ä¸»æ’­åœ¨ç·š</div>
                </div>
            </div>
        </div>

        <!-- èŠå¤©å®¤ -->
        <div class="chat-panel">
            <div class="chat-header">
                <h3><i class="fas fa-comments"></i> å³æ™‚èŠå¤©å®¤</h3>
                <span class="viewer-badge">
                    <i class="fas fa-users"></i> <span id="chatViewerCount">0</span>
                </span>
            </div>
            <!-- æ–°å¢èŠå¤©å®¤ç‹€æ…‹åˆ— -->
            <div id="chatStatusBar" class="chat-status-bar" data-state="disconnected"
                style="display:flex;align-items:center;gap:8px;font-size:12px;padding:6px 10px;margin:-4px 0 8px 0;border:1px solid rgba(102,126,234,0.25);border-radius:8px;background:linear-gradient(135deg,rgba(255,255,255,0.4),rgba(255,255,255,0.25));backdrop-filter:blur(8px);">
                <span class="status-dot"
                    style="width:8px;height:8px;border-radius:50%;background:#1eff69;display:inline-block;"></span>
                <span class="status-text">å·²é€£ç·š</span>
                <span class="retry-hint" style="margin-left:auto;opacity:0.7;">è‡ªå‹•é€£æ¥ä¸­...</span>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    <div class="message-avatar">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="message-content-wrapper">
                        <div class="message-header">
                            <span class="username">ç³»çµ±</span>
                            <span class="timestamp">å‰›å‰›</span>
                        </div>
                        <div class="message-content">
                            æ­¡è¿ä¾†åˆ° VibeLo ç›´æ’­é–“ï¼é–‹å§‹ä½ çš„ç›´æ’­ä¹‹æ—…å§ ğŸš€
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="èªªé»ä»€éº¼...">
                <button class="btn-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- ç™»å…¥æ¬Šé™æª¢æ¸¬å½ˆçª— -->
    <div id="loginPermissionModal" class="login-permission-modal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-user-lock"></i>
            </div>
            <h2 class="modal-title">éœ€è¦ç™»å…¥æ¬Šé™</h2>
            <p class="modal-message">
                é–‹å§‹ç›´æ’­éœ€è¦ç™»å…¥å¸³è™Ÿï¼Œé€™æ¨£å¯ä»¥ç¢ºä¿å¹³å°å®‰å…¨ä¸¦æä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—ã€‚
                <br><br>
                è«‹å…ˆç™»å…¥æ‚¨çš„å¸³è™Ÿï¼Œæˆ–è€…å‰µå»ºä¸€å€‹æ–°å¸³è™Ÿä¾†é–‹å§‹ç›´æ’­ã€‚
            </p>
            <div class="modal-buttons">
                <a href="/login.html" class="modal-btn primary">
                    <i class="fas fa-sign-in-alt"></i>
                    ç«‹å³ç™»å…¥
                </a>
                <a href="/register.html" class="modal-btn secondary">
                    <i class="fas fa-user-plus"></i>
                    å…è²»è¨»å†Š
                </a>
            </div>
        </div>
    </div>

    <!-- JavaScript æ–‡ä»¶ - æŒ‰ä¾è³´é †åºåŠ è¼‰ -->
    <script>
        window.FACE_API_MODEL_BASE = 'webrtc-filters-tutorial-master/public/weights';
        window.FACE_API_MODEL_PATH_FORMAT = 'manifest';
        window.FACE_API_MODEL_SOURCES = [
            { base: 'webrtc-filters-tutorial-master/public/weights', type: 'manifest', label: 'local tutorial weights' }
        ];
    </script>
    <script src="webrtc-filters-tutorial-master/public/lib/face-api.min.js"></script>
    <script src="glasses-tracker.js"></script>
    <script src="livestream-platform.js"></script>
    <script src="script.js"></script>
    <script src="video-effects.js"></script>
    <script src="network-monitor.js"></script>
    <script src="webrtc-sync-fix.js"></script>
    <script src="chat-system.js"></script>
    <script src="webrtc-diagnostics.js"></script>
    <script src="connection-test.js"></script>

    <!-- è°ƒè¯•è„šæœ¬ -->
    <script>
        // å¿½ç•¥æµè§ˆå™¨æ‰©å±•ç›¸å…³çš„é”™è¯¯
        window.addEventListener('error', function (e) {
            // å¿½ç•¥ç€è¦½å™¨æ“´å±•ç›¸é—œçš„éŒ¯èª¤
            const extensionErrors = [
                'message channel closed',
                'Extension context invalidated',
                'Immersive Translate',
                'waitPluginDone timeout',
                'inject.js'
            ];
            
            if (e.message && extensionErrors.some(err => e.message.includes(err))) {
                console.log('å¿½ç•¥æµè§ˆå™¨æ‰©å±•é”™è¯¯:', e.message);
                e.preventDefault();
                return false;
            }
            
            // å¿½ç•¥ä¾†è‡ªæ“´å±•è…³æœ¬çš„éŒ¯èª¤
            if (e.filename && (e.filename.includes('extension://') || e.filename.includes('inject.js'))) {
                console.log('å¿½ç•¥æ“´å±•è…³æœ¬éŒ¯èª¤:', e.filename);
                e.preventDefault();
                return false;
            }
        });

        window.addEventListener('unhandledrejection', function (e) {
            if (e.reason && e.reason.message) {
                const extensionErrors = [
                    'message channel closed',
                    'Extension context invalidated',
                    'Immersive Translate',
                    'waitPluginDone timeout'
                ];
                
                if (extensionErrors.some(err => e.reason.message.includes(err))) {
                console.log('å¿½ç•¥æµè§ˆå™¨æ‰©å±•Promiseé”™è¯¯:', e.reason.message);
                e.preventDefault();
                return false;
                }
            }
        });

        // æ£€æŸ¥è„šæœ¬åŠ è½½çŠ¶æ€
        window.addEventListener('load', function () {
            console.log('=== VibeLo ç›´æ’­å¹³å°åˆå§‹åŒ– ===');

            // ç®€å•ç›´æ¥çš„å‡½æ•°æ£€æŸ¥
            function checkAndSetup() {
                console.log('æ£€æŸ¥å‡½æ•°çŠ¶æ€:');
                console.log('- toggleStream:', typeof toggleStream);
                console.log('- toggleVideo:', typeof toggleVideo);
                console.log('- toggleAudio:', typeof toggleAudio);
                console.log('- shareScreen:', typeof shareScreen);
                console.log('- toggleTabAudio:', typeof toggleTabAudio);

                const allFunctionsLoaded = typeof toggleStream === 'function' &&
                    typeof toggleVideo === 'function' &&
                    typeof toggleAudio === 'function' &&
                    typeof shareScreen === 'function' &&
                    typeof toggleTabAudio === 'function';

                if (allFunctionsLoaded) {
                    console.log('âœ… æ‰€æœ‰å‡½æ•°å·²åŠ è½½ï¼Œè®¾ç½®äº‹ä»¶ç›‘å¬å™¨');
                    setupEventListeners();
                } else {
                    console.log('âŒ éƒ¨åˆ†å‡½æ•°æœªåŠ è½½ï¼Œç­‰å¾…é‡è¯•...');
                    setTimeout(checkAndSetup, 1000);
                }
            }

            // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿è„šæœ¬å®Œå…¨åŠ è½½
            setTimeout(checkAndSetup, 500);

            function setupEventListeners() {
                // è®¾ç½®ç›´æ’­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const streamBtn = document.getElementById('streamBtn');
                if (streamBtn) {
                    console.log('è®¾ç½®ç›´æ’­æŒ‰é’®ç‚¹å‡»äº‹ä»¶');

                    streamBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        console.log('ğŸ¬ ç›´æ’­æŒ‰é’®è¢«ç‚¹å‡»');

                        try {
                            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ï¼Œå¦‚æœæ²’æœ‰ç™»å…¥å‰‡è·³è½‰åˆ°ç™»å…¥é é¢
                            if (!window.currentUser) {
                                console.log('âš ï¸ ç”¨æˆ¶æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é é¢');
                                window.location.href = '/login.html';
                                return;
                            }

                            if (typeof secureToggleStream === 'function') {
                                console.log('âœ… è°ƒç”¨ secureToggleStream å‡½æ•°');
                                secureToggleStream();
                            } else if (typeof toggleStream === 'function') {
                                console.log('âœ… è°ƒç”¨ toggleStream å‡½æ•° (å¤‡ç”¨)');
                                toggleStream();
                            } else {
                                console.error('âŒ æ‰¾ä¸åˆ°ç›´æ’­åˆ‡æ›å‡½æ•¸');
                                alert('ç›´æ’­åŠŸèƒ½æš‚æ—¶æ— æ³•ä½¿ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                            }
                        } catch (error) {
                            console.error('ç›´æ’­æŒ‰é’®ç‚¹å‡»é”™è¯¯:', error);
                            alert('ç›´æ’­åŠŸèƒ½å‡ºç°é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                        }
                    });
                }

                // è®¾ç½®å…¶ä»–æ§åˆ¶æŒ‰é’®çš„äº‹ä»¶
                const videoBtn = document.getElementById('videoBtn');
                if (videoBtn) {
                    videoBtn.addEventListener('click', function () {
                        if (typeof toggleVideo === 'function') {
                            toggleVideo();
                        } else {
                            console.log('toggleVideo å‡½æ•°æœªåŠ è½½');
                        }
                    });
                }

                const audioBtn = document.getElementById('audioBtn');
                if (audioBtn) {
                    audioBtn.addEventListener('click', function () {
                        if (typeof toggleAudio === 'function') {
                            toggleAudio();
                        } else {
                            console.log('toggleAudio å‡½æ•°æœªåŠ è½½');
                        }
                    });
                }

                const screenBtn = document.getElementById('screenBtn');
                if (screenBtn) {
                    screenBtn.addEventListener('click', function () {
                        if (typeof shareScreen === 'function') {
                            shareScreen();
                        } else {
                            console.log('shareScreen å‡½æ•°æœªåŠ è½½');
                        }
                    });
                }

                const tabAudioBtn = document.getElementById('tabAudioBtn');
                if (tabAudioBtn) {
                    tabAudioBtn.addEventListener('click', function () {
                        if (typeof toggleTabAudio === 'function') {
                            toggleTabAudio();
                        } else {
                            console.log('toggleTabAudio å‡½æ•°æœªåŠ è½½');
                        }
                    });
                }

                console.log('âœ… æ‰€æœ‰æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®å®Œæˆ');

                // ç”¨æˆ¶é ­åƒçš„é»æ“Šäº‹ä»¶å·²åœ¨ livestream-platform.js ä¸­è¨­ç½®

                // è®¾ç½®ç‰¹æ•ˆæŒ‰é’®äº‹ä»¶ - ä½¿ç”¨æ–°çš„è¦–é »ç‰¹æ•ˆè™•ç†å™¨
                const effectBtns = document.querySelectorAll('.effect-btn');
                effectBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const effect = this.getAttribute('data-effect');
                        console.log('ğŸ¨ ç‰¹æ•ˆæŒ‰éˆ•è¢«é»æ“Š:', effect);

                        if (typeof applyEffect === 'function') {
                            applyEffect(effect, this);
                        } else if (effect === 'invert' && typeof toggleBackgroundBlur === 'function') {
                            toggleBackgroundBlur(this);
                        } else {
                            console.log('applyEffect å‡½æ•¸æœªè¼‰å…¥');
                        }
                    });
                });

                console.log('âœ… æ‰€æœ‰ç‰¹æ•ˆæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨å·²è¨­å®š');
                
                // åŸ·è¡Œç¶²è·¯ç’°å¢ƒæª¢æ¸¬
                setTimeout(() => {
                    checkNetworkEnvironment();
                }, 2000);
            }
        });
        
        // ç¶²è·¯ç’°å¢ƒæª¢æ¸¬åŠŸèƒ½
        function checkNetworkEnvironment() {
            console.log('ğŸ” æ­£åœ¨æª¢æ¸¬ç¶²è·¯ç’°å¢ƒ...');
            
            // å‰µå»ºè‡¨æ™‚çš„ RTCPeerConnection ä¾†æª¢æ¸¬ NAT é¡å‹
            const tempConfig = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun.stunprotocol.org:3478' }
                ]
            };
            
            const tempPc = new RTCPeerConnection(tempConfig);
            let hostCandidates = 0;
            let srflxCandidates = 0;
            let relayCandidates = 0;
            
            tempPc.onicecandidate = function(event) {
                if (event.candidate) {
                    const candidate = event.candidate;
                    console.log('ğŸ” ç¶²è·¯æª¢æ¸¬å€™é¸:', candidate.type, candidate.candidate);
                    
                    if (candidate.type === 'host') {
                        hostCandidates++;
                    } else if (candidate.type === 'srflx') {
                        srflxCandidates++;
                    } else if (candidate.type === 'relay') {
                        relayCandidates++;
                    }
                } else {
                    // ICE æ”¶é›†å®Œæˆï¼Œåˆ†æçµæœ
                    console.log('ğŸ“Š ç¶²è·¯ç’°å¢ƒåˆ†æçµæœ:');
                    console.log(`   æœ¬åœ°å€™é¸: ${hostCandidates}`);
                    console.log(`   STUNå€™é¸: ${srflxCandidates}`);
                    console.log(`   TURNå€™é¸: ${relayCandidates}`);
                    
                    let networkType = '';
                    let recommendation = '';
                    
                    if (hostCandidates > 0 && srflxCandidates > 0) {
                        networkType = 'âœ… é–‹æ”¾ç¶²è·¯ç’°å¢ƒ';
                        recommendation = 'ç¶²è·¯ç’°å¢ƒè‰¯å¥½ï¼Œæ”¯æ´é»å°é»ç›´é€£';
                    } else if (srflxCandidates > 0) {
                        networkType = 'ğŸ”„ NAT ç¶²è·¯ç’°å¢ƒ';
                        recommendation = 'é€é NAT é€£æ¥ï¼ŒSTUN ä¼ºæœå™¨å¯å”åŠ©ç©¿é€';
                    } else if (hostCandidates > 0) {
                        networkType = 'ğŸŒ æœ¬åœ°ç¶²è·¯ç’°å¢ƒ';
                        recommendation = 'å¯èƒ½åœ¨å…§ç¶²ç’°å¢ƒï¼Œå»ºè­°ç¢ºèªé˜²ç«ç‰†è¨­ç½®';
                    } else {
                        networkType = 'âš ï¸ å—é™ç¶²è·¯ç’°å¢ƒ';
                        recommendation = 'ç¶²è·¯ç’°å¢ƒè¼ƒåš´æ ¼ï¼Œå¯èƒ½éœ€è¦ TURN ä¸­ç¹¼ä¼ºæœå™¨';
                    }
                    
                    console.log(`ğŸŒ ç¶²è·¯é¡å‹: ${networkType}`);
                    console.log(`ğŸ’¡ å»ºè­°: ${recommendation}`);
                    
                    // åœ¨èŠå¤©ä¸­é¡¯ç¤ºæª¢æ¸¬çµæœ
                    if (typeof addMessage === 'function') {
                        addMessage('ç³»çµ±', `${networkType} - ${recommendation}`);
                    }
                    
                    // æ¸…ç†è‡¨æ™‚é€£æ¥
                    tempPc.close();
                }
            };
            
            // å‰µå»ºæ•¸æ“šé€šé“ä¾†è§¸ç™¼ ICE æ”¶é›†
            tempPc.createDataChannel('test');
            tempPc.createOffer().then(offer => {
                return tempPc.setLocalDescription(offer);
            }).catch(err => {
                console.error('ç¶²è·¯æª¢æ¸¬å¤±æ•—:', err);
                tempPc.close();
            });
            
            // 10ç§’å¾Œè¶…æ™‚
            setTimeout(() => {
                if (tempPc.iceConnectionState !== 'closed') {
                    console.log('â° ç¶²è·¯æª¢æ¸¬è¶…æ™‚');
                    tempPc.close();
                }
            }, 10000);
        }

        // ç”¨æˆ¶ä¸‹æ‹‰é¸å–®åŠŸèƒ½
        function toggleUserMenu() {
            console.log('toggleUserMenu è¢«èª¿ç”¨');
            
            // ç§»é™¤ç¾æœ‰é¸å–®
            const existingMenu = document.querySelector('.user-dropdown');
            if (existingMenu) {
                console.log('ç§»é™¤ç¾æœ‰é¸å–®');
                existingMenu.style.opacity = '0';
                existingMenu.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (existingMenu.parentNode) {
                        existingMenu.remove();
                    }
                }, 150);
                return;
            }

            // å‰µå»ºæ–°é¸å–®
            const userAvatar = document.getElementById('userAvatar');
            if (!userAvatar) {
                console.error('æ‰¾ä¸åˆ° userAvatar å…ƒç´ ');
                return;
            }
            
            console.log('å‰µå»ºæ–°é¸å–®');
            const currentUser = JSON.parse(localStorage.getItem('currentUser')) || window.currentUser;
            const currentUserName = currentUser ? currentUser.displayName : 'è¨ªå®¢';
            console.log('ç•¶å‰ç”¨æˆ¶:', currentUserName);

            const dropdown = document.createElement('div');
            dropdown.className = 'user-dropdown';
            dropdown.innerHTML = `
                <div class="menu-user-info">
                    <div class="menu-user-name">${currentUserName}</div>
                </div>
                <a href="index.html" class="menu-link">
                    <i class="fas fa-home"></i>
                    é¦–é 
                </a>
                <a href="browse.html" class="menu-link">
                    <i class="fas fa-eye"></i>
                    ç€è¦½ç›´æ’­
                </a>
                <a href="about.html" class="menu-link">
                    <i class="fas fa-info-circle"></i>
                    é—œæ–¼å¹³å°
                </a>
                ${currentUser ? `
                <a href="#" onclick="logout(); event.preventDefault();" class="menu-link logout">
                    <i class="fas fa-sign-out-alt"></i>
                    ç™»å‡º
                </a>
                ` : `
                <a href="login.html" class="menu-link">
                    <i class="fas fa-sign-in-alt"></i>
                    ç™»å…¥
                </a>
                `}
            `;

            userAvatar.appendChild(dropdown);
            console.log('é¸å–®å·²æ·»åŠ åˆ° DOM');

            // é¡¯ç¤ºå‹•ç•«
            setTimeout(() => {
                dropdown.classList.add('show');
                console.log('é¸å–®é¡¯ç¤ºå‹•ç•«å·²è§¸ç™¼');
            }, 10);

            // é»æ“Šå¤–éƒ¨é—œé–‰é¸å–®
            document.addEventListener('click', function closeMenu(e) {
                if (!userAvatar.contains(e.target)) {
                    console.log('é»æ“Šå¤–éƒ¨ï¼Œé—œé–‰é¸å–®');
                    dropdown.style.opacity = '0';
                    dropdown.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        if (dropdown.parentNode) {
                            dropdown.remove();
                        }
                    }, 150);
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
            } catch (error) {
                console.error('ç™»å‡ºè«‹æ±‚å¤±æ•—:', error);
            }
            
            localStorage.removeItem('currentUser');
            window.location.href = 'preview.html';
        }
    </script>
</body>

</html>