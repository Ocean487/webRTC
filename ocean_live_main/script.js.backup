// å…¨å±€è®Šæ•¸
let localStream = null;
let isStreaming = false;
let isVideoEnabled = true;
let isAudioEnabled = true;
let currentFacingMode = 'user'; // 'user' or 'environment'
let streamStartTime = null;
let durationInterval = null;
let messageCount = 0;
let viewerCount = 0;
let currentQuality = '720';
let dataTransferInterval = null;
let currentAudioOutput = null; // ç•¶å‰éŸ³è¨Šè¼¸å‡ºç«¯

// ä¸»æ’­IDç›¸é—œ
let myBroadcasterId = null;

// ç²å–ä¸»æ’­IDçš„å‡½æ•¸
function getBroadcasterId() {
    if (!myBroadcasterId) {
        // å…ˆå˜—è©¦å¾URLåƒæ•¸ç²å–
        const urlParams = new URLSearchParams(window.location.search);
        const urlBroadcasterId = urlParams.get('broadcaster');
        
        if (urlBroadcasterId) {
            myBroadcasterId = urlBroadcasterId;
        } else if (window.currentUser && window.currentUser.id) {
            // åŸºæ–¼ç•¶å‰ç”¨æˆ¶IDç”Ÿæˆ
            myBroadcasterId = `broadcaster_${window.currentUser.id}`;
        } else {
            // æœ€å¾Œå‚™ä»½ï¼šä½¿ç”¨æ™‚é–“æˆ³
            myBroadcasterId = `broadcaster_${Date.now()}`;
        }
    }
    return myBroadcasterId;
}

// åˆ†é éŸ³è¨Šç›¸é—œè®Šæ•¸
let tabAudioStream = null;
let isTabAudioEnabled = false;
let audioContext = null;
let mixedAudioStream = null;

// WebSocket é€£æ¥
let streamingSocket = null;
let peerConnections = new Map(); // viewerId -> RTCPeerConnection

// WebRTC é…ç½® - å„ªåŒ–è¦–é »ç·¨ç¢¼å…¼å®¹æ€§
const constraints = {
    video: {
        width: { ideal: 1280, max: 1920 },
        height: { ideal: 720, max: 1080 },
        frameRate: { ideal: 30, max: 60 },
        facingMode: 'user'
    },
    audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true,
        sampleRate: { ideal: 48000 },
        channelCount: { ideal: 2 }
    }
};

// WebRTC é€£æ¥é…ç½® - å¢å¼·ç·¨è§£ç¢¼å™¨æ”¯æ´
const rtcConfiguration = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun.services.mozilla.com' },
        { urls: 'stun:stun.l.google.com:19305' }
    ],
    iceCandidatePoolSize: 10,
    bundlePolicy: 'max-bundle',
    rtcpMuxPolicy: 'require'
};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadDevices();
    checkAudioOutputSupport();
    simulateInitialActivity();
    // åœ¨é é¢è¼‰å…¥æ™‚å°±å»ºç«‹ WebSocket é€£æ¥ä»¥æ”¯æ´èŠå¤©åŠŸèƒ½
    connectToStreamingServer();
});

// ç¢ºä¿éŸ³è¨Šè»Œé“æ­£ç¢ºå•Ÿç”¨
function ensureAudioTracksEnabled(stream) {
    if (!stream) return;
    
    const audioTracks = stream.getAudioTracks();
    audioTracks.forEach(track => {
        if (track.readyState === 'live') {
            track.enabled = true;
            console.log('éŸ³è¨Šè»Œé“å·²å•Ÿç”¨:', track.id, 'ç‹€æ…‹:', track.readyState);
        } else {
            console.warn('éŸ³è¨Šè»Œé“ç‹€æ…‹ç•°å¸¸:', track.id, 'ç‹€æ…‹:', track.readyState);
        }
    });
}

// æª¢æŸ¥éŸ³è¨Šè¼¸å‡ºç«¯æ”¯æ´
function checkAudioOutputSupport() {
    const localVideo = document.getElementById('localVideo');
    if (!localVideo.setSinkId) {
        addMessage('ç³»çµ±', 'âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³è¨Šè¼¸å‡ºç«¯åˆ‡æ›åŠŸèƒ½ï¼Œå°‡ä½¿ç”¨é è¨­è¼¸å‡ºç«¯');
        console.warn('ç€è¦½å™¨ä¸æ”¯æ´ setSinkId API');
        return false;
    }
    
    // æª¢æŸ¥æ˜¯å¦æ”¯æ´éŸ³è¨Šè¼¸å‡ºç«¯åˆ—èˆ‰
    if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
        addMessage('ç³»çµ±', 'âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è£ç½®åˆ—èˆ‰åŠŸèƒ½');
        console.warn('ç€è¦½å™¨ä¸æ”¯æ´ enumerateDevices API');
        return false;
    }
    
    console.log('éŸ³è¨Šè¼¸å‡ºç«¯åŠŸèƒ½æ”¯æ´æ­£å¸¸');
    return true;
}

// è¼‰å…¥å¯ç”¨è£ç½®
async function loadDevices() {
    try {
        // å…ˆè«‹æ±‚æ¬Šé™ä»¥ç²å–è£ç½®æ¨™ç±¤
        await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        const cameras = devices.filter(device => device.kind === 'videoinput');
        const microphones = devices.filter(device => device.kind === 'audioinput');
        const speakers = devices.filter(device => device.kind === 'audiooutput');

        const cameraSelect = document.getElementById('cameraSelect');
        const microphoneSelect = document.getElementById('microphoneSelect');
        const audioOutputSelect = document.getElementById('audioOutputSelect');

        // è¼‰å…¥æ”å½±æ©Ÿ
        cameraSelect.innerHTML = '';
        cameras.forEach((camera, index) => {
            const option = document.createElement('option');
            option.value = camera.deviceId;
            option.textContent = camera.label || `æ”å½±æ©Ÿ ${index + 1}`;
            cameraSelect.appendChild(option);
        });

        // è¼‰å…¥éº¥å…‹é¢¨
        microphoneSelect.innerHTML = '';
        microphones.forEach((mic, index) => {
            const option = document.createElement('option');
            option.value = mic.deviceId;
            option.textContent = mic.label || `éº¥å…‹é¢¨ ${index + 1}`;
            microphoneSelect.appendChild(option);
        });

        // è¼‰å…¥éŸ³è¨Šè¼¸å‡ºç«¯
        audioOutputSelect.innerHTML = '';
        
        // æ·»åŠ é è¨­é¸é …
        const defaultOption = document.createElement('option');
        defaultOption.value = 'default';
        defaultOption.textContent = 'é è¨­éŸ³è¨Šè¼¸å‡ºç«¯';
        audioOutputSelect.appendChild(defaultOption);
        
        // æ·»åŠ æª¢æ¸¬åˆ°çš„éŸ³è¨Šè¼¸å‡ºç«¯
        speakers.forEach((speaker, index) => {
            const option = document.createElement('option');
            option.value = speaker.deviceId;
            option.textContent = speaker.label || `éŸ³è¨Šè¼¸å‡ºç«¯ ${index + 1}`;
            audioOutputSelect.appendChild(option);
        });

        console.log('æª¢æ¸¬åˆ°çš„éŸ³è¨Šè¼¸å‡ºç«¯:', speakers.length, speakers.map(s => s.label));

    } catch (error) {
        console.error('ç„¡æ³•è¼‰å…¥è£ç½®åˆ—è¡¨:', error);
        addMessage('ç³»çµ±', 'âš ï¸ ç„¡æ³•æª¢æ¸¬éŸ³è¦–è¨Šè£ç½®ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™');
    }
}

// é–‹å§‹/åœæ­¢ç›´æ’­
async function toggleStream() {
    if (!isStreaming) {
        await startStream();
    } else {
        stopStream();
    }
}

// é–‹å§‹ç›´æ’­
async function startStream() {
    try {
        // ç°¡åŒ–çš„æµç²å– - åªç²å–æ”å½±æ©Ÿå’Œéº¥å…‹é¢¨
        // YouTubeéŸ³è¨Šå°‡é€šéç³»çµ±éŸ³æ•ˆæ··å…¥
        const userStream = await navigator.mediaDevices.getUserMedia(getConstraints());
        
        // ç›´æ¥ä½¿ç”¨ç”¨æˆ¶åª’é«”æµï¼Œä¸é€²è¡Œè¤‡é›œçš„éŸ³è¨Šæ··åˆ
        localStream = userStream;
        
        // é¡¯ç¤ºæœ¬åœ°è¦–è¨Š
        const localVideo = document.getElementById('localVideo');
        const placeholder = document.getElementById('previewPlaceholder');
        
        localVideo.srcObject = localStream;
        localVideo.style.display = 'block';
        placeholder.style.display = 'none';

        // ç¢ºä¿éŸ³è¨Šè»Œé“æ­£ç¢ºå•Ÿç”¨
        ensureAudioTracksEnabled(localStream);

        console.log('ç›´æ’­æµå·²å•Ÿå‹•ï¼ŒYouTubeéŸ³è¨Šå°‡é€šéç³»çµ±éŸ³æ•ˆæ··å…¥');

        // è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯ï¼ˆå¦‚æœå·²é¸æ“‡ï¼‰
        if (currentAudioOutput && currentAudioOutput !== 'default') {
            try {
                if (localVideo.setSinkId) {
                    await localVideo.setSinkId(currentAudioOutput);
                    console.log('å·²è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯:', currentAudioOutput);
                    
                    // ç²å–è£ç½®åç¨±ä¸¦é¡¯ç¤º
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const selectedDevice = devices.find(device => 
                        device.kind === 'audiooutput' && device.deviceId === currentAudioOutput
                    );
                    const deviceName = selectedDevice ? selectedDevice.label : 'é è¨­éŸ³è¨Šè¼¸å‡ºç«¯';
                    addMessage('ç³»çµ±', `ğŸ”Š éŸ³è¨Šè¼¸å‡ºç«¯å·²è¨­ç½®ç‚º: ${deviceName}`);
                    
                    // ç¢ºä¿éŸ³è¨Šæ’­æ”¾
                    try {
                        await localVideo.play();
                        console.log('éŸ³è¨Šå·²é–‹å§‹æ’­æ”¾');
                    } catch (playError) {
                        console.warn('è‡ªå‹•æ’­æ”¾å¤±æ•—:', playError);
                        addMessage('ç³»çµ±', 'âš ï¸ è«‹é»æ“Šè¦–è¨Šç•«é¢ä»¥é–‹å§‹æ’­æ”¾éŸ³è¨Š');
                    }
                }
            } catch (error) {
                console.warn('è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯å¤±æ•—:', error);
                addMessage('ç³»çµ±', 'âš ï¸ éŸ³è¨Šè¼¸å‡ºç«¯è¨­ç½®å¤±æ•—ï¼Œä½¿ç”¨é è¨­è¼¸å‡ºç«¯');
            }
        } else {
            addMessage('ç³»çµ±', 'ğŸ”Š ä½¿ç”¨é è¨­éŸ³è¨Šè¼¸å‡ºç«¯');
            
            // ç¢ºä¿éŸ³è¨Šæ’­æ”¾
            try {
                await localVideo.play();
                console.log('éŸ³è¨Šå·²é–‹å§‹æ’­æ”¾');
            } catch (playError) {
                console.warn('è‡ªå‹•æ’­æ”¾å¤±æ•—:', playError);
                addMessage('ç³»çµ±', 'âš ï¸ è«‹é»æ“Šè¦–è¨Šç•«é¢ä»¥é–‹å§‹æ’­æ”¾éŸ³è¨Š');
            }
        }

        // æ›´æ–° UI ç‹€æ…‹
        isStreaming = true;
        window.isStreaming = isStreaming; // ç¢ºä¿å…¨å±€å¯è¨ªå•
        window.localStream = localStream; // ç¢ºä¿å…¨å±€å¯è¨ªå•
        updateStreamStatus(true);
        startStreamTimer();
        // simulateViewers();

        addMessage('ç³»çµ±', 'ğŸ‰ ç›´æ’­å·²é–‹å§‹ï¼è§€çœ¾å¯ä»¥çœ‹åˆ°ä½ çš„ç•«é¢äº†');

        // æ¨¡æ“¬æ•¸æ“šå‚³è¼¸
        simulateDataTransfer();
        
        // ç¢ºä¿ WebSocket é€£æ¥å·²å»ºç«‹ï¼ˆé€šå¸¸å·²åœ¨é é¢è¼‰å…¥æ™‚å»ºç«‹ï¼‰
        if (!streamingSocket || streamingSocket.readyState !== WebSocket.OPEN) {
            connectToStreamingServer();
        }
        
        // ç­‰å¾… WebSocket é€£æ¥å»ºç«‹å¾Œé€šçŸ¥æœå‹™å™¨ç›´æ’­å·²é–‹å§‹
        setTimeout(() => {
            if (streamingSocket && streamingSocket.readyState === WebSocket.OPEN) {
                // ç²å–ç›´æ’­æ¨™é¡Œ
                const titleInput = document.getElementById('streamTitleInput');
                const streamTitle = titleInput ? titleInput.value.trim() : '';
                const finalTitle = streamTitle || 'ç²¾å½©ç›´æ’­ä¸­';
                
                // ç¢ºä¿ä¸»æ’­ç«¯çš„æ¨™é¡Œé¡¯ç¤ºä¹Ÿæ›´æ–°
                if (titleInput && !streamTitle) {
                    titleInput.value = finalTitle;
                }
                
                // æ›´æ–°ä¸»æ’­ç«¯æ¨™é¡Œé¡¯ç¤º
                updateStreamTitle();
                
                console.log('ç™¼é€ç›´æ’­é–‹å§‹äº‹ä»¶ï¼Œæ¨™é¡Œ:', finalTitle);
                
                // é€šçŸ¥æœå‹™å™¨ç›´æ’­é–‹å§‹ï¼Œä¸¦è«‹æ±‚å·²åœ¨ç·šè§€çœ¾åˆ—è¡¨
                streamingSocket.send(JSON.stringify({
                    type: 'stream_start',
                    title: finalTitle,
                    message: 'ä¸»æ’­å·²é–‹å§‹ç›´æ’­',
                    timestamp: Date.now(),
                    requestViewers: true // è«‹æ±‚ç•¶å‰åœ¨ç·šè§€çœ¾åˆ—è¡¨
                }));
                
                addMessage('ç³»çµ±', `ğŸ”„ ç›´æ’­å·²é–‹å§‹ï¼Œæ¨™é¡Œ: ${finalTitle}`);
                addMessage('ç³»çµ±', 'ğŸ”„ æ­£åœ¨ç‚ºç¾æœ‰è§€çœ¾å»ºç«‹é€£æ¥...');
            }
        }, 1000);

    } catch (error) {
        console.error('ç„¡æ³•å•Ÿå‹•ç›´æ’­:', error);
        
        let errorMessage = 'ç„¡æ³•å•Ÿå‹•ç›´æ’­: ';
        if (error.name === 'NotAllowedError') {
            errorMessage += 'è«‹å…è¨±å­˜å–æ”å½±æ©Ÿå’Œéº¥å…‹é¢¨æ¬Šé™';
        } else if (error.name === 'NotFoundError') {
            errorMessage += 'æ‰¾ä¸åˆ°æ”å½±æ©Ÿæˆ–éº¥å…‹é¢¨è£ç½®';
        } else {
            errorMessage += error.message;
        }
        
        addMessage('ç³»çµ±', 'âŒ ' + errorMessage);
        
        // é¡¯ç¤ºæ¬Šé™è«‹æ±‚æç¤º
        showPermissionRequest();
    }
}

// åœæ­¢ç›´æ’­
function stopStream() {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }

    // éš±è—è¦–è¨Šï¼Œé¡¯ç¤ºé è¦½
    const localVideo = document.getElementById('localVideo');
    const placeholder = document.getElementById('previewPlaceholder');
    
    localVideo.style.display = 'none';
    placeholder.style.display = 'flex';

    // é‡ç½®ç‹€æ…‹
    isStreaming = false;
    updateStreamStatus(false);
    stopStreamTimer();
    resetStats();
    
    // é—œé–‰æ‰€æœ‰ WebRTC é€£æ¥
    peerConnections.forEach(connection => {
        connection.close();
    });
    peerConnections.clear();
    
    // é€šçŸ¥æœå‹™å™¨ç›´æ’­çµæŸ
    if (streamingSocket) {
        streamingSocket.send(JSON.stringify({
            type: 'stream_end',
            broadcasterId: getBroadcasterId()
        }));
    }

    addMessage('ç³»çµ±', 'ğŸ“º ç›´æ’­å·²çµæŸï¼Œæ„Ÿè¬è§€çœ‹ï¼');
}

// ç²å–ç´„æŸæ¢ä»¶
function getConstraints() {
    const quality = getQualitySettings(currentQuality);
    return {
        video: {
            ...quality,
            facingMode: currentFacingMode,
            deviceId: document.getElementById('cameraSelect').value || undefined
        },
        audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            deviceId: document.getElementById('microphoneSelect').value || undefined
        }
    };
}

// ç²å–ç•«è³ªè¨­å®š
function getQualitySettings(quality) {
    const settings = {
        '480': { width: { ideal: 854 }, height: { ideal: 480 } },
        '720': { width: { ideal: 1280 }, height: { ideal: 720 } },
        '1080': { width: { ideal: 1920 }, height: { ideal: 1080 } }
    };
    return settings[quality] || settings['720'];
}

// åˆ‡æ›è¦–è¨Š
async function toggleVideo() {
    if (!localStream) return;

    const videoTracks = localStream.getVideoTracks();
    videoTracks.forEach(track => {
        track.enabled = !track.enabled;
    });

    isVideoEnabled = !isVideoEnabled;
    const btn = document.getElementById('videoBtn');
    btn.textContent = isVideoEnabled ? 'ğŸ“¹ é—œé–‰è¦–è¨Š' : 'ğŸ“¹ é–‹å•Ÿè¦–è¨Š';

    addMessage('ç³»çµ±', isVideoEnabled ? 'ğŸ“¹ è¦–è¨Šå·²é–‹å•Ÿ' : 'ğŸ“¹ è¦–è¨Šå·²é—œé–‰');
    
    // æ›´æ–°æ‰€æœ‰è§€çœ¾çš„è»Œé“ç‹€æ…‹
    if (isStreaming) {
        const viewerIds = Array.from(peerConnections.keys());
        for (const viewerId of viewerIds) {
            await updatePeerConnectionTracks(viewerId);
        }
    }
}

// åˆ‡æ›éŸ³è¨Š
async function toggleAudio() {
    if (!localStream) return;

    const audioTracks = localStream.getAudioTracks();
    audioTracks.forEach(track => {
        track.enabled = !track.enabled;
    });

    isAudioEnabled = !isAudioEnabled;
    const btn = document.getElementById('audioBtn');
    btn.textContent = isAudioEnabled ? 'ğŸ¤ é—œé–‰éŸ³è¨Š' : 'ğŸ¤ é–‹å•ŸéŸ³è¨Š';

    addMessage('ç³»çµ±', isAudioEnabled ? 'ğŸ¤ éŸ³è¨Šå·²é–‹å•Ÿ' : 'ğŸ¤ éŸ³è¨Šå·²é—œé–‰');
    
    // æ›´æ–°æ‰€æœ‰è§€çœ¾çš„è»Œé“ç‹€æ…‹
    if (isStreaming) {
        const viewerIds = Array.from(peerConnections.keys());
        for (const viewerId of viewerIds) {
            await updatePeerConnectionTracks(viewerId);
        }
    }
}

// åˆ‡æ›é¡é ­
async function switchCamera() {
    if (!isStreaming) return;

    try {
        currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
        
        // ä¿å­˜ç•¶å‰çš„éŸ³è¨Šè»Œé“
        const currentAudioTrack = localStream ? localStream.getAudioTracks()[0] : null;
        
        // åªåœæ­¢è¦–è¨Šè»Œé“ï¼Œä¿æŒéŸ³è¨Šè»Œé“
        if (localStream) {
            const videoTracks = localStream.getVideoTracks();
            videoTracks.forEach(track => track.stop());
        }

        // é‡æ–°å–å¾—åª’é«”ä¸²æµï¼ˆåªåŒ…å«è¦–è¨Šï¼‰
        const videoConstraints = getConstraints();
        const newVideoStream = await navigator.mediaDevices.getUserMedia(videoConstraints);
        
        // å‰µå»ºæ–°çš„ä¸²æµï¼ŒåŒ…å«æ–°çš„è¦–è¨Šè»Œé“å’ŒåŸæœ‰çš„éŸ³è¨Šè»Œé“
        const newStream = new MediaStream();
        
        // æ·»åŠ æ–°çš„è¦–è¨Šè»Œé“
        newVideoStream.getVideoTracks().forEach(track => {
            newStream.addTrack(track);
        });
        
        // ä¿æŒåŸæœ‰çš„éŸ³è¨Šè»Œé“
        if (currentAudioTrack && currentAudioTrack.readyState === 'live') {
            newStream.addTrack(currentAudioTrack);
            console.log('ä¿æŒåŸæœ‰éŸ³è¨Šè»Œé“ï¼Œè»Œé“ID:', currentAudioTrack.id);
        }
        
        // æ›´æ–°æœ¬åœ°ä¸²æµ
        localStream = newStream;
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;
        
        // ç¢ºä¿éŸ³è¨Šè»Œé“å•Ÿç”¨
        const newAudioTracks4 = localStream.getAudioTracks();
        newAudioTracks4.forEach(track => {
            track.enabled = true;
            console.log('éŸ³è¨Šè»Œé“å·²å•Ÿç”¨:', track.id, 'ç‹€æ…‹:', track.readyState);
        });

        // é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯
        if (currentAudioOutput && currentAudioOutput !== 'default') {
            try {
                const localVideo = document.getElementById('localVideo');
                if (localVideo.setSinkId) {
                    await localVideo.setSinkId(currentAudioOutput);
                    console.log('å·²é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯:', currentAudioOutput);
                }
            } catch (error) {
                console.warn('é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯å¤±æ•—:', error);
            }
        }

        const cameraType = currentFacingMode === 'user' ? 'å‰é¡é ­' : 'å¾Œé¡é ­';
        addMessage('ç³»çµ±', `ğŸ”„ å·²åˆ‡æ›åˆ°${cameraType}ï¼ŒéŸ³è¨Šä¿æŒä¸è®Š`);
        
        // æ›´æ–°æ‰€æœ‰ WebRTC é€£æ¥çš„è»Œé“
        await updateAllPeerConnections();
    } catch (error) {
        console.error('åˆ‡æ›é¡é ­å¤±æ•—:', error);
        addMessage('ç³»çµ±', 'âŒ é¡é ­åˆ‡æ›å¤±æ•—');
    }
}

// åˆ†äº«è¢å¹•
async function shareScreen() {
    try {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({
            video: { 
                cursor: 'always',
                displaySurface: 'monitor'
            },
            audio: true
        });

        // ä¿å­˜ç•¶å‰çš„éŸ³è¨Šè»Œé“ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        const currentAudioTrack = localStream ? localStream.getAudioTracks()[0] : null;
        
        // åªåœæ­¢è¦–è¨Šè»Œé“ï¼Œä¿æŒéŸ³è¨Šè»Œé“
        if (localStream) {
            const videoTracks = localStream.getVideoTracks();
            videoTracks.forEach(track => track.stop());
        }

        // å‰µå»ºæ–°çš„ä¸²æµï¼ŒåŒ…å«è¢å¹•åˆ†äº«çš„è¦–è¨Šè»Œé“å’ŒåŸæœ‰çš„éŸ³è¨Šè»Œé“
        const newStream = new MediaStream();
        
        // æ·»åŠ è¢å¹•åˆ†äº«çš„è¦–è¨Šè»Œé“
        screenStream.getVideoTracks().forEach(track => {
            newStream.addTrack(track);
        });
        
        // ä¿æŒåŸæœ‰çš„éŸ³è¨Šè»Œé“ï¼ˆå¦‚æœå­˜åœ¨ä¸”æœ‰æ•ˆï¼‰
        if (currentAudioTrack && currentAudioTrack.readyState === 'live') {
            newStream.addTrack(currentAudioTrack);
            console.log('ä¿æŒåŸæœ‰éŸ³è¨Šè»Œé“ï¼Œè»Œé“ID:', currentAudioTrack.id);
        } else {
            // å¦‚æœæ²’æœ‰åŸæœ‰éŸ³è¨Šè»Œé“ï¼Œæ·»åŠ è¢å¹•åˆ†äº«çš„éŸ³è¨Šè»Œé“
            screenStream.getAudioTracks().forEach(track => {
                newStream.addTrack(track);
            });
        }

        // æ›´æ–°æœ¬åœ°ä¸²æµä¸¦è¨­ç½®åˆ°è¦–è¨Šå…ƒç´ 
        localStream = newStream;
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;
        
        // ç¢ºä¿éŸ³è¨Šè»Œé“å•Ÿç”¨
        const newAudioTracks = localStream.getAudioTracks();
        newAudioTracks.forEach(track => {
            track.enabled = true;
            console.log('éŸ³è¨Šè»Œé“å·²å•Ÿç”¨:', track.id, 'ç‹€æ…‹:', track.readyState);
        });

        // é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯
        if (currentAudioOutput && currentAudioOutput !== 'default') {
            try {
                const localVideo = document.getElementById('localVideo');
                if (localVideo.setSinkId) {
                    await localVideo.setSinkId(currentAudioOutput);
                    console.log('å·²é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯:', currentAudioOutput);
                }
            } catch (error) {
                console.warn('é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯å¤±æ•—:', error);
            }
        }

        addMessage('ç³»çµ±', 'ğŸ–¥ï¸ è¢å¹•åˆ†äº«å·²é–‹å§‹ï¼ŒéŸ³è¨Šä¿æŒä¸è®Š');

        // ç›£è½è¢å¹•åˆ†äº«çµæŸ
        screenStream.getVideoTracks()[0].onended = () => {
            addMessage('ç³»çµ±', 'ğŸ–¥ï¸ è¢å¹•åˆ†äº«å·²çµæŸ');
            // å¯ä»¥é¸æ“‡åˆ‡å›æ”å½±æ©Ÿæˆ–çµæŸç›´æ’­
        };

        // æ›´æ–°æ‰€æœ‰è§€çœ¾çš„è»Œé“
        if (isStreaming) {
            await updateAllPeerConnections();
        }

    } catch (error) {
        console.error('è¢å¹•åˆ†äº«å¤±æ•—:', error);
        addMessage('ç³»çµ±', 'âŒ è¢å¹•åˆ†äº«å¤±æ•—');
    }
}

// åˆ‡æ›ç•«è³ª
async function changeQuality() {
    if (!isStreaming) {
        currentQuality = document.getElementById('qualitySelect').value;
        document.getElementById('currentQuality').textContent = currentQuality + 'p';
        return;
    }

    try {
        currentQuality = document.getElementById('qualitySelect').value;
        
        // ä¿å­˜ç•¶å‰çš„éŸ³è¨Šè»Œé“
        const currentAudioTrack = localStream ? localStream.getAudioTracks()[0] : null;
        
        // åªé‡æ–°é…ç½®è¦–è¨Šè»Œé“
        const videoTracks = localStream.getVideoTracks();
        if (videoTracks.length > 0) {
            const quality = getQualitySettings(currentQuality);
            await videoTracks[0].applyConstraints(quality);
            document.getElementById('currentQuality').textContent = currentQuality + 'p';
            addMessage('ç³»çµ±', `ğŸ“º ç•«è³ªå·²åˆ‡æ›ç‚º ${currentQuality}pï¼ŒéŸ³è¨Šä¿æŒä¸è®Š`);
        }

    } catch (error) {
        console.error('ç•«è³ªåˆ‡æ›å¤±æ•—:', error);
        addMessage('ç³»çµ±', 'âŒ ç•«è³ªåˆ‡æ›å¤±æ•—');
    }
}

// åˆ‡æ›è¦–è¨Šè£ç½®
async function switchVideoDevice() {
    if (!isStreaming) return;

    try {
        // ä¿å­˜ç•¶å‰çš„éŸ³è¨Šè»Œé“
        const currentAudioTrack = localStream ? localStream.getAudioTracks()[0] : null;
        
        // åªåœæ­¢è¦–è¨Šè»Œé“
        const videoTracks = localStream.getVideoTracks();
        videoTracks.forEach(track => track.stop());

        const newStream = await navigator.mediaDevices.getUserMedia({
            video: {
                ...getQualitySettings(currentQuality),
                deviceId: document.getElementById('cameraSelect').value
            },
            audio: false
        });

        // å‰µå»ºæ–°çš„ä¸²æµï¼ŒåŒ…å«æ–°çš„è¦–è¨Šè»Œé“å’ŒåŸæœ‰çš„éŸ³è¨Šè»Œé“
        const combinedStream = new MediaStream();
        
        // æ·»åŠ æ–°çš„è¦–è¨Šè»Œé“
        newStream.getVideoTracks().forEach(track => {
            combinedStream.addTrack(track);
        });
        
        // ä¿æŒåŸæœ‰çš„éŸ³è¨Šè»Œé“
        if (currentAudioTrack && currentAudioTrack.readyState === 'live') {
            combinedStream.addTrack(currentAudioTrack);
            console.log('ä¿æŒåŸæœ‰éŸ³è¨Šè»Œé“ï¼Œè»Œé“ID:', currentAudioTrack.id);
        }

        // æ›´æ–°æœ¬åœ°ä¸²æµ
        localStream = combinedStream;
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;
        
        // ç¢ºä¿éŸ³è¨Šè»Œé“å•Ÿç”¨
        const newAudioTracks2 = localStream.getAudioTracks();
        newAudioTracks2.forEach(track => {
            track.enabled = true;
            console.log('éŸ³è¨Šè»Œé“å·²å•Ÿç”¨:', track.id, 'ç‹€æ…‹:', track.readyState);
        });

        // é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯
        if (currentAudioOutput && currentAudioOutput !== 'default') {
            try {
                const localVideo = document.getElementById('localVideo');
                if (localVideo.setSinkId) {
                    await localVideo.setSinkId(currentAudioOutput);
                    console.log('å·²é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯:', currentAudioOutput);
                }
            } catch (error) {
                console.warn('é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯å¤±æ•—:', error);
            }
        }
        
        addMessage('ç³»çµ±', 'ğŸ“¹ æ”å½±æ©Ÿå·²åˆ‡æ›ï¼ŒéŸ³è¨Šä¿æŒä¸è®Š');

        // æ›´æ–°æ‰€æœ‰è§€çœ¾çš„è»Œé“
        if (isStreaming) {
            await updateAllPeerConnections();
        }

    } catch (error) {
        console.error('æ”å½±æ©Ÿåˆ‡æ›å¤±æ•—:', error);
        addMessage('ç³»çµ±', 'âŒ æ”å½±æ©Ÿåˆ‡æ›å¤±æ•—');
    }
}

// æª¢æŸ¥ç•¶å‰éŸ³è¨Šè¼¸å‡ºç«¯ç‹€æ…‹
async function checkAudioOutputStatus() {
    try {
        const localVideo = document.getElementById('localVideo');
        
        if (!localVideo.setSinkId) {
            addMessage('ç³»çµ±', 'âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´éŸ³è¨Šè¼¸å‡ºç«¯åˆ‡æ›');
            return;
        }
        
        // ç²å–ç•¶å‰éŸ³è¨Šè¼¸å‡ºç«¯
        const currentSinkId = localVideo.sinkId || 'default';
        
        // ç²å–æ‰€æœ‰éŸ³è¨Šè¼¸å‡ºç«¯
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audioOutputs = devices.filter(device => device.kind === 'audiooutput');
        
        // æ‰¾åˆ°ç•¶å‰ä½¿ç”¨çš„è¼¸å‡ºç«¯
        const currentDevice = audioOutputs.find(device => device.deviceId === currentSinkId);
        const deviceName = currentDevice ? currentDevice.label : 'é è¨­éŸ³è¨Šè¼¸å‡ºç«¯';
        
        // æª¢æŸ¥éŸ³è¨Šè»Œé“ç‹€æ…‹
        const audioTracks = localStream ? localStream.getAudioTracks() : [];
        const enabledTracks = audioTracks.filter(track => track.enabled);
        
        let statusMessage = `ğŸ”Š ç•¶å‰éŸ³è¨Šè¼¸å‡ºç«¯: ${deviceName}\n`;
        statusMessage += `ğŸ“Š éŸ³è¨Šè»Œé“: ${audioTracks.length} å€‹ (${enabledTracks.length} å€‹å•Ÿç”¨)\n`;
        statusMessage += `â–¶ï¸ æ’­æ”¾ç‹€æ…‹: ${localVideo.paused ? 'æš«åœ' : 'æ’­æ”¾ä¸­'}\n`;
        statusMessage += `ğŸ”Š éŸ³é‡: ${Math.round(localVideo.volume * 100)}%`;
        
        addMessage('ç³»çµ±', statusMessage);
        
        console.log('éŸ³è¨Šè¼¸å‡ºç«¯ç‹€æ…‹:', {
            sinkId: currentSinkId,
            deviceName: deviceName,
            audioTracks: audioTracks.length,
            enabledTracks: enabledTracks.length,
            paused: localVideo.paused,
            volume: localVideo.volume
        });
        
    } catch (error) {
        console.error('æª¢æŸ¥éŸ³è¨Šè¼¸å‡ºç«¯ç‹€æ…‹å¤±æ•—:', error);
        addMessage('ç³»çµ±', 'âŒ æª¢æŸ¥éŸ³è¨Šè¼¸å‡ºç«¯ç‹€æ…‹å¤±æ•—');
    }
}

// æ¸¬è©¦éŸ³è¨Šè¼¸å‡ºç«¯
async function testAudioOutput() {
    try {
        const selectedOutputId = document.getElementById('audioOutputSelect').value;
        const localVideo = document.getElementById('localVideo');
        
        if (!localVideo.setSinkId) {
            addMessage('ç³»çµ±', 'âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³è¨Šè¼¸å‡ºç«¯åˆ‡æ›åŠŸèƒ½');
            return;
        }

        // å¦‚æœæ­£åœ¨ç›´æ’­ï¼Œä½¿ç”¨å¯¦éš›çš„è¦–è¨Šå…ƒç´ æ¸¬è©¦
        if (isStreaming && localStream) {
            try {
                // åˆ‡æ›åˆ°é¸æ“‡çš„éŸ³è¨Šè¼¸å‡ºç«¯
                await localVideo.setSinkId(selectedOutputId);
                
                // ç²å–è£ç½®åç¨±
                const devices = await navigator.mediaDevices.enumerateDevices();
                const selectedDevice = devices.find(device => 
                    device.kind === 'audiooutput' && device.deviceId === selectedOutputId
                );
                const deviceName = selectedDevice ? selectedDevice.label : 'é è¨­éŸ³è¨Šè¼¸å‡ºç«¯';
                
                addMessage('ç³»çµ±', `ğŸ”Š æ­£åœ¨æ¸¬è©¦éŸ³è¨Šè¼¸å‡ºç«¯: ${deviceName}`);
                
                // ç¢ºä¿è¦–è¨Šæ’­æ”¾
                if (localVideo.paused) {
                    await localVideo.play();
                }
                
                // 3ç§’å¾Œæ¢å¾©åŸä¾†çš„è¼¸å‡ºç«¯
                setTimeout(async () => {
                    if (currentAudioOutput && currentAudioOutput !== 'default') {
                        await localVideo.setSinkId(currentAudioOutput);
                    }
                    addMessage('ç³»çµ±', 'ğŸ”Š éŸ³è¨Šæ¸¬è©¦å®Œæˆï¼Œå·²æ¢å¾©åŸè¼¸å‡ºç«¯');
                }, 3000);
                
            } catch (error) {
                console.error('éŸ³è¨Šæ¸¬è©¦å¤±æ•—:', error);
                addMessage('ç³»çµ±', 'âŒ éŸ³è¨Šæ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        } else {
            // å¦‚æœæ²’æœ‰ç›´æ’­ï¼Œå‰µå»ºæ¸¬è©¦éŸ³è¨Š
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 éŸ³ç¬¦
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime); // é™ä½éŸ³é‡
            
            oscillator.start();
            
            // æ’­æ”¾ 1 ç§’å¾Œåœæ­¢
            setTimeout(() => {
                oscillator.stop();
                addMessage('ç³»çµ±', 'ğŸ”Š éŸ³è¨Šæ¸¬è©¦å®Œæˆ');
            }, 1000);
        }
        
    } catch (error) {
        console.error('éŸ³è¨Šæ¸¬è©¦å¤±æ•—:', error);
        addMessage('ç³»çµ±', 'âŒ éŸ³è¨Šæ¸¬è©¦å¤±æ•—');
    }
}

// åˆ‡æ›éŸ³è¨Šè¼¸å‡ºç«¯
async function switchAudioOutput() {
    try {
        const selectedOutputId = document.getElementById('audioOutputSelect').value;
        const localVideo = document.getElementById('localVideo');
        
        // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ setSinkId
        if (!localVideo.setSinkId) {
            addMessage('ç³»çµ±', 'âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³è¨Šè¼¸å‡ºç«¯åˆ‡æ›åŠŸèƒ½');
            return;
        }

        if (!isStreaming) {
            currentAudioOutput = selectedOutputId;
            addMessage('ç³»çµ±', 'ğŸ”Š éŸ³è¨Šè¼¸å‡ºç«¯å·²è¨­å®šï¼Œé–‹å§‹ç›´æ’­å¾Œç”Ÿæ•ˆ');
            return;
        }

        // åˆ‡æ›éŸ³è¨Šè¼¸å‡ºç«¯
        await localVideo.setSinkId(selectedOutputId);
        currentAudioOutput = selectedOutputId;
        
        // ç²å–è£ç½®åç¨±
        const devices = await navigator.mediaDevices.enumerateDevices();
        const selectedDevice = devices.find(device => 
            device.kind === 'audiooutput' && device.deviceId === selectedOutputId
        );
        const deviceName = selectedDevice ? selectedDevice.label : 'é è¨­éŸ³è¨Šè¼¸å‡ºç«¯';
        
        addMessage('ç³»çµ±', `ğŸ”Š éŸ³è¨Šè¼¸å‡ºç«¯å·²åˆ‡æ›è‡³: ${deviceName}`);
        
        console.log('éŸ³è¨Šè¼¸å‡ºç«¯å·²åˆ‡æ›è‡³:', deviceName, 'ID:', selectedOutputId);
        
        // ç¢ºä¿éŸ³è¨Šæ’­æ”¾
        if (localVideo.paused) {
            try {
                await localVideo.play();
                console.log('éŸ³è¨Šå·²é–‹å§‹æ’­æ”¾');
                addMessage('ç³»çµ±', 'â–¶ï¸ éŸ³è¨Šå·²é–‹å§‹æ’­æ”¾');
            } catch (error) {
                console.warn('è‡ªå‹•æ’­æ”¾å¤±æ•—:', error);
                addMessage('ç³»çµ±', 'âš ï¸ è«‹é»æ“Šè¦–è¨Šç•«é¢ä»¥é–‹å§‹æ’­æ”¾éŸ³è¨Š');
            }
        } else {
            console.log('è¦–è¨Šå·²åœ¨æ’­æ”¾ä¸­');
        }
        
        // æª¢æŸ¥éŸ³è¨Šè»Œé“ç‹€æ…‹
        const audioTracks = localStream ? localStream.getAudioTracks() : [];
        const enabledTracks = audioTracks.filter(track => track.enabled);
        console.log('éŸ³è¨Šè»Œé“ç‹€æ…‹:', {
            total: audioTracks.length,
            enabled: enabledTracks.length,
            tracks: audioTracks.map(track => ({
                id: track.id,
                enabled: track.enabled,
                readyState: track.readyState
            }))
        });
        
    } catch (error) {
        console.error('åˆ‡æ›éŸ³è¨Šè¼¸å‡ºç«¯å¤±æ•—:', error);
        
        let errorMessage = 'åˆ‡æ›éŸ³è¨Šè¼¸å‡ºç«¯å¤±æ•—: ';
        if (error.name === 'NotAllowedError') {
            errorMessage += 'è«‹å…è¨±å­˜å–éŸ³è¨Šè¼¸å‡ºç«¯æ¬Šé™';
        } else if (error.name === 'NotFoundError') {
            errorMessage += 'æ‰¾ä¸åˆ°æŒ‡å®šçš„éŸ³è¨Šè¼¸å‡ºç«¯';
        } else {
            errorMessage += error.message;
        }
        
        addMessage('ç³»çµ±', 'âŒ ' + errorMessage);
    }
}

// åˆ‡æ›éŸ³è¨Šè£ç½®
async function switchAudioDevice() {
    if (!isStreaming) return;

    try {
        // ä¿å­˜ç•¶å‰çš„è¦–è¨Šè»Œé“
        const currentVideoTrack = localStream ? localStream.getVideoTracks()[0] : null;
        
        // åªåœæ­¢éŸ³è¨Šè»Œé“
        const audioTracks = localStream.getAudioTracks();
        audioTracks.forEach(track => track.stop());

        const newStream = await navigator.mediaDevices.getUserMedia({
            video: false,
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                deviceId: document.getElementById('microphoneSelect').value
            }
        });

        // å‰µå»ºæ–°çš„ä¸²æµï¼ŒåŒ…å«æ–°çš„éŸ³è¨Šè»Œé“å’ŒåŸæœ‰çš„è¦–è¨Šè»Œé“
        const combinedStream = new MediaStream();
        
        // æ·»åŠ æ–°çš„éŸ³è¨Šè»Œé“
        newStream.getAudioTracks().forEach(track => {
            combinedStream.addTrack(track);
        });
        
        // ä¿æŒåŸæœ‰çš„è¦–è¨Šè»Œé“
        if (currentVideoTrack && currentVideoTrack.readyState === 'live') {
            combinedStream.addTrack(currentVideoTrack);
            console.log('ä¿æŒåŸæœ‰è¦–è¨Šè»Œé“ï¼Œè»Œé“ID:', currentVideoTrack.id);
        }

        // æ›´æ–°æœ¬åœ°ä¸²æµ
        localStream = combinedStream;
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;
        
        // ç¢ºä¿éŸ³è¨Šè»Œé“å•Ÿç”¨
        const newAudioTracks3 = localStream.getAudioTracks();
        newAudioTracks3.forEach(track => {
            track.enabled = true;
            console.log('éŸ³è¨Šè»Œé“å·²å•Ÿç”¨:', track.id, 'ç‹€æ…‹:', track.readyState);
        });

        // é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯
        if (currentAudioOutput && currentAudioOutput !== 'default') {
            try {
                const localVideo = document.getElementById('localVideo');
                if (localVideo.setSinkId) {
                    await localVideo.setSinkId(currentAudioOutput);
                    console.log('å·²é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯:', currentAudioOutput);
                }
            } catch (error) {
                console.warn('é‡æ–°è¨­ç½®éŸ³è¨Šè¼¸å‡ºç«¯å¤±æ•—:', error);
            }
        }
        
        addMessage('ç³»çµ±', 'ğŸ¤ éº¥å…‹é¢¨å·²åˆ‡æ›ï¼Œè¦–è¨Šä¿æŒä¸è®Š');

        // æ›´æ–°æ‰€æœ‰è§€çœ¾çš„è»Œé“
        if (isStreaming) {
            await updateAllPeerConnections();
        }

    } catch (error) {
        console.error('éº¥å…‹é¢¨åˆ‡æ›å¤±æ•—:', error);
        addMessage('ç³»çµ±', 'âŒ éº¥å…‹é¢¨åˆ‡æ›å¤±æ•—');
    }
}

// æˆªåœ–åŠŸèƒ½
function takeScreenshot() {
    if (!localStream) return;

    const canvas = document.createElement('canvas');
    const video = document.getElementById('localVideo');
    const ctx = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    // ä¸‹è¼‰æˆªåœ–
    const link = document.createElement('a');
    link.download = `screenshot_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.png`;
    link.href = canvas.toDataURL();
    link.click();

    addMessage('ç³»çµ±', 'ğŸ“¸ æˆªåœ–å·²ä¸‹è¼‰');
}

// å…¨è¢å¹•åˆ‡æ›
function toggleFullscreen() {
    const videoContainer = document.querySelector('.video-container');
    
    if (!document.fullscreenElement) {
        videoContainer.requestFullscreen().catch(err => {
            console.error('å…¨è¢å¹•å¤±æ•—:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

// æ›´æ–°ç›´æ’­ç‹€æ…‹
function updateStreamStatus(isLive) {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const streamBtn = document.getElementById('streamBtn');

    // æ·»åŠ nullæª¢æŸ¥
    if (!statusDot || !statusText || !streamBtn) {
        console.error('ç„¡æ³•æ‰¾åˆ°å¿…è¦çš„UIå…ƒç´ :', {
            statusDot: !!statusDot,
            statusText: !!statusText,
            streamBtn: !!streamBtn
        });
        return;
    }

    if (isLive) {
        statusDot.classList.add('live');
        statusText.textContent = 'ç›´æ’­ä¸­';
        statusText.classList.add('live-status'); // æ·»åŠ ç›´æ’­ç‹€æ…‹é¡
        streamBtn.textContent = 'â¹ï¸ åœæ­¢ç›´æ’­';
        streamBtn.classList.add('streaming');
        
        // ä¹Ÿæ›´æ–°ç›´æ’­ç•«é¢å€åŸŸçš„ç‹€æ…‹
        const streamStatusDot = document.getElementById('streamStatusDot');
        const streamStatusText = document.getElementById('streamStatusText');
        if (streamStatusDot && streamStatusText) {
            streamStatusDot.classList.add('live');
            streamStatusText.textContent = 'ç›´æ’­ä¸­';
            streamStatusText.classList.add('live-status');
        }
    } else {
        statusDot.classList.remove('live');
        statusText.classList.remove('live-status'); // ç§»é™¤ç›´æ’­ç‹€æ…‹é¡
        streamBtn.textContent = 'ğŸ”´ é–‹å§‹ç›´æ’­';
        streamBtn.classList.remove('streaming');
        
        // ä¹Ÿæ›´æ–°ç›´æ’­ç•«é¢å€åŸŸçš„ç‹€æ…‹
        const streamStatusDot = document.getElementById('streamStatusDot');
        const streamStatusText = document.getElementById('streamStatusText');
        if (streamStatusDot && streamStatusText) {
            streamStatusDot.classList.remove('live');
            streamStatusText.classList.remove('live-status');
        }
    }
}

// é–‹å§‹ç›´æ’­è¨ˆæ™‚å™¨
function startStreamTimer() {
    streamStartTime = Date.now();
    durationInterval = setInterval(updateDuration, 1000);
}

// åœæ­¢ç›´æ’­è¨ˆæ™‚å™¨
function stopStreamTimer() {
    if (durationInterval) {
        clearInterval(durationInterval);
        durationInterval = null;
    }
    streamStartTime = null;
}

// æ›´æ–°ç›´æ’­æ™‚é•·
function updateDuration() {
    if (!streamStartTime) return;

    const elapsed = Date.now() - streamStartTime;
    const minutes = Math.floor(elapsed / 60000);
    const seconds = Math.floor((elapsed % 60000) / 1000);
    
    const durationElement = document.getElementById('duration');
    if (durationElement) {
        durationElement.textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

// æ¨¡æ“¬è§€çœ¾æ•¸é‡
function simulateViewers() {
    if (!isStreaming) return;

    // éš¨æ©Ÿå¢åŠ è§€çœ¾
    const viewerIncrease = Math.floor(Math.random() * 3) + 1;
    viewerCount += viewerIncrease;
    
    const viewerCountElement = document.getElementById('viewerCount');
    const chatViewerCountElement = document.getElementById('chatViewerCount');
    
    if (viewerCountElement) {
        viewerCountElement.textContent = viewerCount;
    }
    if (chatViewerCountElement) {
        chatViewerCountElement.textContent = viewerCount;
    }

    // éš¨æ©Ÿç™¼é€è§€çœ¾è¨Šæ¯
    if (Math.random() < 0.3) {
        const messages = [
            'ä¸»æ’­å¥½ï¼',
            'ç•«é¢å¾ˆæ¸…æ™°å‘¢',
            'æ”¯æŒä¸»æ’­ï¼',
            'è«‹å•ä¸»æ’­åœ¨ç©ä»€éº¼éŠæˆ²ï¼Ÿ',
            'ä¸»æ’­çš„è²éŸ³å¾ˆå¥½è½',
            'é€™å€‹ç›´æ’­é–“å¾ˆæ£’ï¼',
            'ä¸»æ’­åŠ æ²¹ï¼',
            'è«‹å•ä¸»æ’­å¹¾æ­²ï¼Ÿ',
            'ä¸»æ’­çš„æŠ€è¡“å¾ˆæ£’',
            'é€™å€‹ç›´æ’­å¾ˆæœ‰è¶£'
        ];
        
        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
        const usernames = ['è§€çœ¾A', 'è§€çœ¾B', 'è§€çœ¾C', 'è§€çœ¾D', 'è§€çœ¾E', 'è§€çœ¾F'];
        const randomUsername = usernames[Math.floor(Math.random() * usernames.length)];
        
        addMessage(randomUsername, randomMessage);
    }

    // ç¹¼çºŒæ¨¡æ“¬
    setTimeout(simulateViewers, Math.random() * 5000 + 3000);
}

// æ¨¡æ“¬æ•¸æ“šå‚³è¼¸
function simulateDataTransfer() {
    if (!isStreaming) return;

    const dataRate = Math.floor(Math.random() * 1000) + 100;
    const dataRateElement = document.getElementById('dataRate');
    if (dataRateElement) {
        dataRateElement.textContent = `${dataRate} KB/s`;
    }

    dataTransferInterval = setTimeout(simulateDataTransfer, 2000);
}

// é‡ç½®çµ±è¨ˆæ•¸æ“š
function resetStats() {
    viewerCount = 0;
    messageCount = 0;
    
    // å®‰å…¨åœ°é‡ç½®æ‰€æœ‰çµ±è¨ˆå…ƒç´ 
    const elements = {
        'viewerCount': '0',
        'chatViewerCount': '0',
        'messageCount': '0',
        'duration': '00:00',
        'dataRate': '0 KB/s'
    };
    
    for (const [id, value] of Object.entries(elements)) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        }
    }

    if (dataTransferInterval) {
        clearTimeout(dataTransferInterval);
        dataTransferInterval = null;
    }
}

// æ·»åŠ èŠå¤©è¨Šæ¯
function addMessage(username, content) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message';
    
    // æ ¹æ“šç”¨æˆ¶é¡å‹è¨­ç½®ä¸åŒçš„æ¨£å¼
    if (username === 'ç³»çµ±') {
        messageDiv.classList.add('system');
    } else if (username === 'ä¸»æ’­' || username === getCurrentUser()) {
        messageDiv.classList.add('broadcaster');
    }
    
    const timestamp = new Date().toLocaleTimeString('zh-TW', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    // ç²å–ç”¨æˆ¶é ­åƒ
    const avatar = getUserAvatar(username);
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            ${avatar}
        </div>
        <div class="message-content-wrapper">
            <div class="message-bubble">
                <div class="message-header">
                    <span class="username">${username}</span>
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div class="message-content">${content}</div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    
    // å¼·åˆ¶è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨ - ä½¿ç”¨å¤šç¨®æ–¹æ³•ç¢ºä¿æ»¾å‹•
    scrollChatToBottom();
    
    // å»¶é²å†æ¬¡æ»¾å‹•ï¼Œç¢ºä¿ DOM å®Œå…¨æ›´æ–°
    setTimeout(() => {
        scrollChatToBottom();
    }, 50);
    
    // å†æ¬¡å»¶é²æ»¾å‹•ï¼Œè™•ç†å¯èƒ½çš„å‹•ç•«æˆ–ä½ˆå±€è®ŠåŒ–
    setTimeout(() => {
        scrollChatToBottom();
    }, 100);
    
    // æ›´æ–°è¨Šæ¯è¨ˆæ•¸
    if (username !== 'ç³»çµ±') {
        messageCount++;
        const messageCountElement = document.getElementById('messageCount');
        if (messageCountElement) {
            messageCountElement.textContent = messageCount;
        }
    }
}

// ç²å–ç”¨æˆ¶é ­åƒ
function getUserAvatar(username) {
    if (username === 'ç³»çµ±') {
        return '<i class="fas fa-cog"></i>';
    } else if (username === 'ä¸»æ’­' || username === getCurrentUser()) {
        // ä½¿ç”¨ç•¶å‰ç”¨æˆ¶çš„é ­åƒ
        if (window.getCurrentUserAvatar) {
            return window.getCurrentUserAvatar();
        } else {
            return '<i class="fas fa-star"></i>';
        }
    } else {
        // æ™®é€šç”¨æˆ¶é¡¯ç¤ºç”¨æˆ¶åçš„ç¬¬ä¸€å€‹å­—æ¯
        return username.charAt(0).toUpperCase();
    }
}

// ç²å–ç•¶å‰ç”¨æˆ¶åç¨±
function getCurrentUser() {
    // å¾å…¨åŸŸè®Šæ•¸æˆ–é é¢å‡½æ•¸ç²å–ç”¨æˆ¶å
    if (window.currentUser && window.currentUser.displayName) {
        return window.currentUser.displayName;
    } else if (window.getCurrentUser) {
        return window.getCurrentUser();
    } else {
        return 'ä¸»æ’­'; // é è¨­å€¼
    }
}

// ç²å–ç•¶å‰ç”¨æˆ¶å®Œæ•´ä¿¡æ¯
function getCurrentUserInfo() {
    // é¦–å…ˆæª¢æŸ¥å…¨å±€è®Šæ•¸ currentUser (å¯èƒ½æ˜¯å¾APIè¼‰å…¥æˆ–è¨­ç½®çš„è¨ªå®¢èº«ä»½)
    if (window.currentUser || currentUser) {
        const user = window.currentUser || currentUser;
        return {
            displayName: user.displayName || user.username,
            avatarUrl: user.avatarUrl || user.avatar || null,
            isLoggedIn: !user.isGuest,
            isGuest: user.isGuest || false
        };
    }
    
    // å…¶æ¬¡æª¢æŸ¥localStorageä¸­çš„ç”¨æˆ¶ä¿¡æ¯
    const storedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    if (storedUser) {
        return {
            displayName: storedUser.username,
            avatarUrl: storedUser.avatar || null,
            isLoggedIn: true,
            isGuest: false
        };
    } 
    
    // æœ€å¾Œè¿”å›é è¨­çš„ä¸»æ’­èº«ä»½
    return {
        displayName: 'ä¸»æ’­',
        avatarUrl: null,
        isLoggedIn: false,
        isGuest: false
    };
}

// ç™¼é€è¨Šæ¯ - åƒ…ä½œç‚ºå¾Œå‚™ï¼Œå„ªå…ˆä½¿ç”¨ChatSystem
function sendMessage() {
    console.log('[SCRIPT] sendMessageè¢«èª¿ç”¨');
    
    // æª¢æŸ¥ChatSystemæ˜¯å¦å¯ç”¨ï¼Œå¦‚æœå¯ç”¨å‰‡å§”è¨—çµ¦ChatSystemè™•ç†
    if (window.chatSystem && 
        window.chatSystem.isReady && 
        typeof window.chatSystem.sendMessage === 'function') {
        console.log('[SCRIPT] æª¢æ¸¬åˆ°ChatSystemå¯ç”¨ï¼Œå§”è¨—çµ¦ChatSystemè™•ç†');
        window.chatSystem.sendMessage();
        return;
    }
    
    console.log('[SCRIPT] ChatSystemä¸å¯ç”¨ï¼Œä½¿ç”¨å¾Œå‚™è™•ç†');
    
    const messageInput = document.getElementById('messageInput');
    if (!messageInput) {
        console.error('[SCRIPT] æ‰¾ä¸åˆ°messageInputå…ƒç´ ');
        return;
    }
    
    const message = messageInput.value.trim();
    
    if (!message) {
        console.warn('[SCRIPT] æ¶ˆæ¯ç‚ºç©ºï¼Œå¿½ç•¥ç™¼é€');
        return;
    }

    console.log('[SCRIPT] sendMessage invoked. socketState=', streamingSocket? streamingSocket.readyState : 'null', 'raw=', message);
    
    // ç²å–ç•¶å‰ç”¨æˆ¶åç¨±
    const currentUserName = getCurrentUser();
    
    // é€šé WebSocket ç™¼é€è¨Šæ¯çµ¦æ‰€æœ‰è§€çœ¾
    if (streamingSocket && streamingSocket.readyState === WebSocket.OPEN) {
        const messageData = {
            type: 'chat',  // ä½¿ç”¨çµ±ä¸€çš„èŠå¤©æ¶ˆæ¯é¡å‹
            role: 'broadcaster',
            username: currentUserName,
            message: message,
            timestamp: new Date().toISOString()
        };
        
        streamingSocket.send(JSON.stringify(messageData));
        console.log('[SCRIPT] å·²ç™¼é€è¨Šæ¯çµ¦æ‰€æœ‰è§€çœ¾ payload=', messageData);
        
        // ä¸ç«‹å³åœ¨æœ¬åœ°é¡¯ç¤ºæ¶ˆæ¯ï¼Œè®“ ChatSystem è™•ç†æœå‹™å™¨å›å‚³çš„æ¶ˆæ¯
        // addMessage(currentUserName, message, 'broadcaster');
        
    } else {
        console.warn('[SCRIPT] WebSocket æœªé€£æ¥ï¼Œç„¡æ³•ç™¼é€è¨Šæ¯');
        addMessage('ç³»çµ±', 'âš ï¸ ç¶²è·¯é€£æ¥ç•°å¸¸ï¼Œè¨Šæ¯ç„¡æ³•ç™¼é€', 'system');
    }
    
    messageInput.value = '';
}

// æ»¾å‹•èŠå¤©å®¤åˆ°åº•éƒ¨
function scrollChatToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        // å¼·åˆ¶æ»¾å‹•åˆ°åº•éƒ¨ï¼ˆæœ€ç›´æ¥çš„æ–¹æ³•ï¼‰
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        console.log('èŠå¤©å®¤å¼·åˆ¶æ»¾å‹• - scrollTop:', chatMessages.scrollTop, 'scrollHeight:', chatMessages.scrollHeight);
        
        // é©—è­‰æ»¾å‹•æ˜¯å¦æˆåŠŸ
        setTimeout(() => {
            if (chatMessages.scrollTop < chatMessages.scrollHeight - chatMessages.clientHeight - 10) {
                console.warn('èŠå¤©å®¤æ»¾å‹•å¯èƒ½å¤±æ•—ï¼Œå†æ¬¡å˜—è©¦');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }, 100);
    }
}

// è™•ç†Enteréµç™¼é€
function handleEnter(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
    }
}

// é¡¯ç¤ºæ¬Šé™è«‹æ±‚æç¤º
function showPermissionRequest() {
    const videoContainer = document.querySelector('.video-container');
    
    // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æç¤º
    if (videoContainer.querySelector('.permission-request')) return;
    
    const permissionDiv = document.createElement('div');
    permissionDiv.className = 'permission-request';
    permissionDiv.innerHTML = `
        <h3>ğŸ” éœ€è¦æ¬Šé™</h3>
        <p>è«‹å…è¨±ç€è¦½å™¨å­˜å–æ‚¨çš„æ”å½±æ©Ÿå’Œéº¥å…‹é¢¨ä¾†é–‹å§‹ç›´æ’­</p>
        <button class="btn btn-primary" onclick="requestPermissions()">é‡æ–°è«‹æ±‚æ¬Šé™</button>
    `;
    
    videoContainer.appendChild(permissionDiv);
}

// é‡æ–°è«‹æ±‚æ¬Šé™
async function requestPermissions() {
    try {
        await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        addMessage('ç³»çµ±', 'âœ… æ¬Šé™å·²ç²å¾—ï¼Œè«‹é‡æ–°é»æ“Šé–‹å§‹ç›´æ’­');
        
        // ç§»é™¤æ¬Šé™æç¤º
        const permissionRequest = document.querySelector('.permission-request');
        if (permissionRequest) {
            permissionRequest.remove();
        }
        
    } catch (error) {
        addMessage('ç³»çµ±', 'âŒ æ¬Šé™è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š');
    }
}

// æ¨¡æ“¬åˆå§‹æ´»å‹•
function simulateInitialActivity() {
    // æ¨¡æ“¬ä¸€äº›åˆå§‹çš„èŠå¤©è¨Šæ¯
    setTimeout(() => {
        addMessage('ç³»çµ±', 'ğŸ‘‹ æ­¡è¿ä¾†åˆ°ç›´æ’­å¹³å°ï¼');
    }, 1000);
    
    setTimeout(() => {
        addMessage('ç³»çµ±', 'ğŸ’¡ æç¤ºï¼šé»æ“Šé–‹å§‹ç›´æ’­ä¾†å•Ÿå‹•æ‚¨çš„æ”å½±æ©Ÿ');
    }, 3000);
}

// é€£æ¥åˆ°ç›´æ’­æœå‹™å™¨
function connectToStreamingServer() {
    // å¦‚æœå·²ç¶“æœ‰é€£æ¥ä¸”ç‹€æ…‹æ­£å¸¸ï¼Œå‰‡ä¸é‡è¤‡é€£æ¥
    if (streamingSocket && (streamingSocket.readyState === WebSocket.OPEN || streamingSocket.readyState === WebSocket.CONNECTING)) {
        console.log('WebSocket å·²é€£æ¥æˆ–æ­£åœ¨é€£æ¥ä¸­');
        return;
    }
    
    try {
        // æ ¹æ“šç•¶å‰å”è­°é¸æ“‡WebSocketå”è­°
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}`;
        
        console.log('å˜—è©¦é€£æ¥åˆ° WebSocket æœå‹™å™¨:', wsUrl);
        streamingSocket = new WebSocket(wsUrl);
        
        streamingSocket.onopen = function() {
            console.log('âœ… å·²é€£æ¥åˆ°ç›´æ’­æœå‹™å™¨');
            addMessage('ç³»çµ±', 'ğŸ”— å·²é€£æ¥åˆ°ç›´æ’­æœå‹™å™¨');
            
            // ç²å–ä¸»æ’­ç”¨æˆ¶ä¿¡æ¯
            const userInfo = getCurrentUserInfo();
            
            // ç™¼é€ä¸»æ’­åŠ å…¥è¨Šæ¯ï¼ŒåŒ…å«ç”¨æˆ¶ä¿¡æ¯
            streamingSocket.send(JSON.stringify({
                type: 'broadcaster_join',
                broadcasterId: getBroadcasterId(),
                userInfo: userInfo
            }));
        };
        
        streamingSocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            // å¼·åˆ¶èª¿è©¦æ‰€æœ‰æ¶ˆæ¯
            console.log('ğŸš¨ [FORCE DEBUG] ä¸»æ’­ç«¯æ”¶åˆ°æ¶ˆæ¯:', data);
            
            if(data.type==='chat_message' || data.type==='chat'){
                console.log('[CHAT_DEBUG] æ”¶åˆ°èŠå¤©å°åŒ…', data);
            }
            
            // ç‰¹åˆ¥é—œæ³¨ online_viewers å’Œ viewer_join æ¶ˆæ¯
            if (data.type === 'online_viewers' || data.type === 'viewer_join') {
                console.log('ğŸ¯ [CRITICAL] WebRTCç›¸é—œæ¶ˆæ¯:', data);
                // ç§»é™¤alertï¼Œæ”¹ç”¨console logï¼Œé¿å…å½±éŸ¿ç”¨æˆ¶é«”é©—
                console.log(`ğŸ“± [WebRTC] æ”¶åˆ°é—œéµæ¶ˆæ¯: ${data.type} - è©³ç´°ä¿¡æ¯è¦‹ä¸Šæ–¹`);
            }
            
            handleServerMessage(data);
        };
        
        streamingSocket.onclose = function(event) {
            console.log('âŒ èˆ‡ç›´æ’­æœå‹™å™¨æ–·é–‹é€£æ¥', {
                code: event.code,
                reason: event.reason,
                wasClean: event.wasClean
            });
            addMessage('ç³»çµ±', `âš ï¸ èˆ‡ç›´æ’­æœå‹™å™¨æ–·é–‹é€£æ¥ (Code: ${event.code})`);
            
            // å˜—è©¦é‡æ–°é€£æ¥
            setTimeout(() => {
                console.log('ğŸ”„ å˜—è©¦é‡æ–°é€£æ¥...');
                connectToStreamingServer();
            }, 3000);
        };
        
        streamingSocket.onerror = function(error) {
            console.error('âŒ WebSocket éŒ¯èª¤:', error);
            console.error('âŒ WebSocket ç‹€æ…‹:', streamingSocket ? streamingSocket.readyState : 'undefined');
            addMessage('ç³»çµ±', 'âŒ é€£æ¥ç›´æ’­æœå‹™å™¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯é€£æ¥è¢«æ‹’çµ•
            if (streamingSocket && streamingSocket.readyState === WebSocket.CLOSED) {
                console.error('âŒ é€£æ¥è¢«é—œé–‰ï¼Œå¯èƒ½æ˜¯ä¼ºæœå™¨æœªå•Ÿå‹•');
                addMessage('ç³»çµ±', 'âŒ ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹ç¢ºèªä¼ºæœå™¨å·²å•Ÿå‹•');
            }
        };
        
        // æ·»åŠ è¶…æ™‚æª¢æ¸¬
        setTimeout(() => {
            if (streamingSocket && streamingSocket.readyState === WebSocket.CONNECTING) {
                console.warn('âš ï¸ WebSocket é€£æ¥è¶…æ™‚');
                streamingSocket.close();
                addMessage('ç³»çµ±', 'âš ï¸ é€£æ¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨ç‹€æ…‹');
            }
        }, 10000); // 10ç§’è¶…æ™‚
        
    } catch (error) {
        console.error('âŒ ç„¡æ³•å‰µå»º WebSocket é€£æ¥:', error);
        addMessage('ç³»çµ±', 'âŒ ç„¡æ³•é€£æ¥åˆ°ç›´æ’­æœå‹™å™¨: ' + error.message);
    }
}

// è™•ç†æœå‹™å™¨è¨Šæ¯
function handleServerMessage(data) {
    console.log('ğŸ”” ä¸»æ’­ç«¯æ”¶åˆ°æœå‹™å™¨æ¶ˆæ¯:', data.type, data);
    addMessage('ç³»çµ±', `ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${data.type}`);
    
    switch (data.type) {
        case 'broadcaster_joined':
            addMessage('ç³»çµ±', 'âœ… ä¸»æ’­å·²æˆåŠŸåŠ å…¥ç›´æ’­é–“');
            break;
            
        case 'viewer_join':
            handleViewerJoin(data);
            break;
            
        case 'viewers_need_connection':
            handleViewersNeedConnection(data);
            break;
            
        case 'online_viewers':
            // è™•ç†æœå‹™å™¨è¿”å›çš„åœ¨ç·šè§€çœ¾åˆ—è¡¨
            console.log('ğŸ¯ è™•ç†åœ¨ç·šè§€çœ¾åˆ—è¡¨æ¶ˆæ¯');
            addMessage('ç³»çµ±', `ğŸ¯ æ”¶åˆ°åœ¨ç·šè§€çœ¾åˆ—è¡¨: ${data.viewers ? data.viewers.length : 0} å€‹`);
            handleOnlineViewers(data);
            break;
            
        case 'answer':
            handleAnswer(data);
            break;
            
        case 'ice_candidate':
            handleIceCandidate(data);
            break;
            
        case 'chat_message':
            handleChatMessage(data);
            break;
        case 'chat': // æ–°çš„èŠå¤©å”è­°è™•ç† - å®Œå…¨å§”è¨—çµ¦ChatSystem
            console.log('[SCRIPT] æ”¶åˆ° chat æ¶ˆæ¯ï¼Œå®Œå…¨å§”è¨—çµ¦ChatSystemè™•ç†:', data);
            
            // æª¢æŸ¥ ChatSystem æ˜¯å¦å­˜åœ¨
            if (window.chatSystem) {
                console.log('[SCRIPT] ChatSystemå­˜åœ¨ï¼Œå®Œå…¨è·³éscript.jsè™•ç†');
                // è®“ChatSystemå®Œå…¨è™•ç†ï¼Œscript.jsä¸å†ä»‹å…¥
                return;
            } else {
                console.log('[SCRIPT] ChatSystemä¸å­˜åœ¨ï¼Œä½¿ç”¨å¾Œå‚™è™•ç†');
                // åªæœ‰åœ¨ChatSystemå®Œå…¨ä¸å­˜åœ¨æ™‚æ‰ä½¿ç”¨å¾Œå‚™è™•ç†
                handleChatMessage({
                    type: 'chat_message',
                    username: data.role === 'system' ? 'ç³»çµ±' : data.username,
                    message: data.text || data.message,
                    text: data.text || data.message,
                    isStreamer: data.role === 'broadcaster',
                    isSystemMessage: data.role === 'system',
                    timestamp: data.timestamp || Date.now()
                });
            }
            break;
            
        case 'viewer_count_update':
            updateViewerCount(data.count);
            break;
            
        default:
            console.log('æœªçŸ¥è¨Šæ¯é¡å‹:', data.type);
    }
}

// è™•ç†æœå‹™å™¨è¿”å›çš„åœ¨ç·šè§€çœ¾åˆ—è¡¨
function handleOnlineViewers(data) {
    console.log('ğŸš¨ [FORCE DEBUG] handleOnlineViewers è¢«èª¿ç”¨:', data);
    console.log(`ğŸ“Š [INFO] è§€çœ¾æ•¸é‡: ${data.viewers ? data.viewers.length : 0}`);
    
    console.log('æ”¶åˆ°åœ¨ç·šè§€çœ¾åˆ—è¡¨:', data.viewers);
    console.log('ç•¶å‰ç›´æ’­ç‹€æ…‹:', isStreaming, 'æœ¬åœ°åª’é«”æµ:', localStream ? 'å·²å»ºç«‹' : 'æœªå»ºç«‹');
    console.log('å…¨å±€è®Šé‡æª¢æŸ¥:', {
        'window.isStreaming': window.isStreaming,
        'window.localStream': window.localStream ? 'å·²å»ºç«‹' : 'æœªå»ºç«‹',
        'isStreaming': isStreaming,
        'localStream': localStream ? 'å·²å»ºç«‹' : 'æœªå»ºç«‹'
    });
    
    if (!isStreaming || !localStream) {
        console.log('âŒ ç„¡æ³•ç‚ºè§€çœ¾å»ºç«‹é€£æ¥ï¼šç›´æ’­æœªé–‹å§‹æˆ–åª’é«”æµæœªå»ºç«‹');
        addMessage('ç³»çµ±', 'âŒ ç„¡æ³•ç‚ºè§€çœ¾å»ºç«‹é€£æ¥ï¼šè«‹ç¢ºä¿ç›´æ’­å·²é–‹å§‹');
        console.log(`âŒ [ERROR] æ¢ä»¶æª¢æŸ¥å¤±æ•—: isStreaming=${isStreaming}, localStream=${localStream ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
        return;
    }
    
    const viewers = data.viewers || [];
    
    if (viewers.length === 0) {
        console.log('ğŸ“º ç›®å‰æ²’æœ‰è§€çœ¾åœ¨ç·š');
        addMessage('ç³»çµ±', 'ğŸ“º ç­‰å¾…è§€çœ¾åŠ å…¥...');
        return;
    }
    
    console.log(`ğŸ“º ç‚º ${viewers.length} å€‹åœ¨ç·šè§€çœ¾å»ºç«‹é€£æ¥...`);
    addMessage('ç³»çµ±', `ğŸ“º æ­£åœ¨ç‚º ${viewers.length} å€‹è§€çœ¾å»ºç«‹é€£æ¥...`);
    
    // ç‚ºæ¯å€‹åœ¨ç·šè§€çœ¾å»ºç«‹ WebRTC é€£æ¥
    viewers.forEach((viewerId, index) => {
        if (!peerConnections.has(viewerId)) {
            console.log(`ğŸ”„ ç‚ºè§€çœ¾ ${viewerId.substr(-3)} å»ºç«‹ WebRTC é€£æ¥...`);
            addMessage('ç³»çµ±', `ğŸ”„ æ­£åœ¨ç‚ºè§€çœ¾ ${viewerId.substr(-3)} å»ºç«‹é€£æ¥...`);
            
            // å»¶é²å»ºç«‹é€£æ¥ï¼Œé¿å…åŒæ™‚å»ºç«‹å¤ªå¤šé€£æ¥
            setTimeout(() => {
                try {
                    console.log(`ğŸš¨ [FORCE DEBUG] é–‹å§‹ç‚ºè§€çœ¾ ${viewerId} å»ºç«‹ PeerConnection`);
                    createPeerConnection(viewerId);
                    setTimeout(() => {
                        console.log(`ğŸš¨ [FORCE DEBUG] é–‹å§‹ç‚ºè§€çœ¾ ${viewerId} ç™¼é€ Stream`);
                        sendStreamToViewer(viewerId);
                    }, 500); // ç­‰å¾… PeerConnection å»ºç«‹å®Œæˆ
                } catch (error) {
                    console.error(`ç‚ºè§€çœ¾ ${viewerId.substr(-3)} å»ºç«‹é€£æ¥å¤±æ•—:`, error);
                    addMessage('ç³»çµ±', `âŒ ç‚ºè§€çœ¾ ${viewerId.substr(-3)} å»ºç«‹é€£æ¥å¤±æ•—`);
                }
            }, index * 500); // é †åºå»¶é²é¿å…è¡çª
        } else {
            console.log(`â„¹ï¸ è§€çœ¾ ${viewerId.substr(-3)} å·²æœ‰é€£æ¥`);
        }
    });
}

// è™•ç†è§€çœ¾åŠ å…¥
function handleViewerJoin(data) {
    console.log('è§€çœ¾åŠ å…¥:', data.viewerId);
    console.log(`ğŸ‘¥ è§€çœ¾ ${data.viewerId.substr(-3)} å·²åŠ å…¥ç›´æ’­é–“`);
    
    // è©³ç´°èª¿è©¦ä¿¡æ¯
    console.log('ç•¶å‰ç›´æ’­ç‹€æ…‹ isStreaming:', isStreaming);
    console.log('æœ¬åœ°åª’é«”æµ localStream:', localStream ? 'å·²å»ºç«‹' : 'æœªå»ºç«‹');
    console.log('å·²æœ‰çš„ PeerConnection æ•¸é‡:', peerConnections.size);
    
    // å¦‚æœæ­£åœ¨ç›´æ’­ï¼Œç‚ºæ–°è§€çœ¾å»ºç«‹é€£æ¥
    if (isStreaming && localStream) {
        // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰é€£æ¥
        if (!peerConnections.has(data.viewerId)) {
            console.log(`ğŸ”„ ç‚ºè§€çœ¾ ${data.viewerId.substr(-3)} å»ºç«‹è¦–è¨Šé€£æ¥...`);
            addMessage('ç³»çµ±', `ğŸ”„ æ­£åœ¨ç‚ºè§€çœ¾ ${data.viewerId.substr(-3)} å»ºç«‹é€£æ¥...`);
            
            // å»ºç«‹ WebRTC é€£æ¥
            createPeerConnection(data.viewerId);
            
            // ç™¼é€ç›´æ’­ä¸²æµ
            sendStreamToViewer(data.viewerId);
        } else {
            addMessage('ç³»çµ±', `â„¹ï¸ è§€çœ¾ ${data.viewerId.substr(-3)} å·²æœ‰é€£æ¥`);
        }
    } else {
        if (!isStreaming) {
            console.log('âš ï¸ ä¸»æ’­å°šæœªé–‹å§‹ç›´æ’­');
            addMessage('ç³»çµ±', `âš ï¸ è§€çœ¾ ${data.viewerId.substr(-3)} åŠ å…¥ï¼Œä½†ç›´æ’­å°šæœªé–‹å§‹`);
        }
        if (!localStream) {
            console.log('âš ï¸ æœ¬åœ°åª’é«”æµæœªå»ºç«‹');
            addMessage('ç³»çµ±', `âš ï¸ ç„¡æ³•ç‚ºè§€çœ¾å»ºç«‹é€£æ¥ï¼šæ”å½±æ©Ÿæœªå•Ÿç”¨`);
        }
    }
}

// è™•ç†è§€çœ¾éœ€è¦é€£æ¥
function handleViewersNeedConnection(data) {
    console.log('è§€çœ¾éœ€è¦é€£æ¥:', data.viewers);
    console.log('ç•¶å‰ç›´æ’­ç‹€æ…‹ isStreaming:', isStreaming);
    console.log('æœ¬åœ°åª’é«”æµ localStream:', localStream ? 'å·²å»ºç«‹' : 'æœªå»ºç«‹');
    addMessage('ç³»çµ±', data.message);
    
    if (!isStreaming) {
        console.log('âš ï¸ ç›´æ’­å°šæœªé–‹å§‹ï¼Œç„¡æ³•å»ºç«‹è§€çœ¾é€£æ¥');
        addMessage('ç³»çµ±', 'âš ï¸ ç›´æ’­å°šæœªé–‹å§‹ï¼Œç„¡æ³•å»ºç«‹è§€çœ¾é€£æ¥');
        return;
    }
    
    if (!localStream) {
        console.log('âš ï¸ æœ¬åœ°åª’é«”æµæœªå»ºç«‹ï¼Œç„¡æ³•å»ºç«‹è§€çœ¾é€£æ¥');
        addMessage('ç³»çµ±', 'âš ï¸ æ”å½±æ©Ÿæœªå•Ÿç”¨ï¼Œç„¡æ³•å»ºç«‹è§€çœ¾é€£æ¥');
        return;
    }
    
    // ç‚ºæ‰€æœ‰ç­‰å¾…çš„è§€çœ¾å»ºç«‹é€£æ¥
    data.viewers.forEach(viewerId => {
        if (!peerConnections.has(viewerId)) {
            console.log('ç‚ºè§€çœ¾', viewerId, 'å»ºç«‹é€£æ¥');
            addMessage('ç³»çµ±', `ğŸ”„ æ­£åœ¨ç‚ºç­‰å¾…çš„è§€çœ¾ ${viewerId.substr(-3)} å»ºç«‹é€£æ¥...`);
            createPeerConnection(viewerId);
            sendStreamToViewer(viewerId);
        } else {
            console.log('è§€çœ¾', viewerId, 'å·²æœ‰é€£æ¥ï¼Œè·³é');
        }
    });
}

// å»ºç«‹ WebRTC é€£æ¥
function createPeerConnection(viewerId) {
    try {
        console.log('ç‚ºè§€çœ¾', viewerId, 'å»ºç«‹ WebRTC é€£æ¥');
        const peerConnection = new RTCPeerConnection(rtcConfiguration);
        
        // æ·»åŠ æœ¬åœ°ä¸²æµè»Œé“
        if (localStream) {
            console.log('æœ¬åœ°ä¸²æµè»Œé“æ•¸é‡:', localStream.getTracks().length);
            
            // åˆ†åˆ¥è™•ç†è¦–è¨Šå’ŒéŸ³è¨Šè»Œé“
            const videoTracks = localStream.getVideoTracks();
            const audioTracks = localStream.getAudioTracks();
            
            console.log(`è¦–è¨Šè»Œé“: ${videoTracks.length}, éŸ³è¨Šè»Œé“: ${audioTracks.length}`);
            
            // æ·»åŠ è¦–è¨Šè»Œé“
            videoTracks.forEach((track, index) => {
                try {
                    const sender = peerConnection.addTrack(track, localStream);
                    console.log(`âœ… å·²æ·»åŠ è¦–è¨Šè»Œé“ ${index}:`, track.readyState, track.id);
                } catch (error) {
                    console.error(`âŒ æ·»åŠ è¦–è¨Šè»Œé“ ${index} å¤±æ•—:`, error);
                }
            });
            
            // æ·»åŠ éŸ³è¨Šè»Œé“
            audioTracks.forEach((track, index) => {
                try {
                    const sender = peerConnection.addTrack(track, localStream);
                    console.log(`âœ… å·²æ·»åŠ éŸ³è¨Šè»Œé“ ${index}:`, track.readyState, track.id);
                } catch (error) {
                    console.error(`âŒ æ·»åŠ éŸ³è¨Šè»Œé“ ${index} å¤±æ•—:`, error);
                }
            });
            
            addMessage('ç³»çµ±', `ğŸ“¹ å·²ç‚ºè§€çœ¾ ${viewerId.substr(-3)} æ·»åŠ  ${videoTracks.length} å€‹è¦–è¨Šè»Œé“å’Œ ${audioTracks.length} å€‹éŸ³è¨Šè»Œé“`);
            
        } else {
            console.error('âŒ æœ¬åœ°ä¸²æµä¸å­˜åœ¨');
            addMessage('ç³»çµ±', `âŒ ç„¡æ³•ç‚ºè§€çœ¾ ${viewerId.substr(-3)} å»ºç«‹é€£æ¥ï¼šæœ¬åœ°ä¸²æµä¸å­˜åœ¨`);
            return;
        }
        
        // è™•ç† ICE å€™é¸
        peerConnection.onicecandidate = function(event) {
            if (event.candidate && streamingSocket) {
                console.log('ç™¼é€ ICE å€™é¸çµ¦è§€çœ¾:', viewerId);
                streamingSocket.send(JSON.stringify({
                    type: 'ice_candidate',
                    candidate: event.candidate,
                    broadcasterId: getBroadcasterId(),
                    viewerId: viewerId
                }));
            }
        };
        
        // ç›£è½é€£æ¥ç‹€æ…‹
        peerConnection.onconnectionstatechange = function() {
            const state = peerConnection.connectionState;
            console.log(`è§€çœ¾ ${viewerId.substr(-3)} é€£æ¥ç‹€æ…‹:`, state);
            
            switch (state) {
                case 'connecting':
                    addMessage('ç³»çµ±', `ğŸ”„ æ­£åœ¨èˆ‡è§€çœ¾ ${viewerId.substr(-3)} å»ºç«‹é€£æ¥...`);
                    break;
                case 'connected':
                    console.log(`âœ… è§€çœ¾ ${viewerId.substr(-3)} è¦–è¨Šé€£æ¥æˆåŠŸ`);
                    addMessage('ç³»çµ±', `âœ… è§€çœ¾ ${viewerId.substr(-3)} é€£æ¥æˆåŠŸï¼`);
                    break;
                case 'disconnected':
                    console.log(`âš ï¸ è§€çœ¾ ${viewerId.substr(-3)} é€£æ¥ä¸­æ–·`);
                    addMessage('ç³»çµ±', `âš ï¸ è§€çœ¾ ${viewerId.substr(-3)} é€£æ¥ä¸­æ–·`);
                    break;
                case 'failed':
                    console.log(`âŒ è§€çœ¾ ${viewerId.substr(-3)} é€£æ¥å¤±æ•—`);
                    addMessage('ç³»çµ±', `âŒ è§€çœ¾ ${viewerId.substr(-3)} é€£æ¥å¤±æ•—ï¼Œå°‡å˜—è©¦é‡é€£...`);
                    
                    // æ¸…ç†å¤±æ•—çš„é€£æ¥ä¸¦å˜—è©¦é‡æ–°å»ºç«‹
                    setTimeout(() => {
                        if (peerConnection.connectionState === 'failed') {
                            console.log(`ğŸ”„ ç‚ºè§€çœ¾ ${viewerId.substr(-3)} é‡æ–°å»ºç«‹é€£æ¥...`);
                            peerConnections.delete(viewerId);
                            
                            // é‡æ–°å»ºç«‹é€£æ¥
                            setTimeout(() => {
                                if (isStreaming && localStream) {
                                    createPeerConnection(viewerId);
                                    setTimeout(() => sendStreamToViewer(viewerId), 1000);
                                }
                            }, 2000);
                        }
                    }, 3000);
                    break;
                case 'closed':
                    console.log(`ğŸ”’ è§€çœ¾ ${viewerId.substr(-3)} é€£æ¥å·²é—œé–‰`);
                    addMessage('ç³»çµ±', `ğŸ”’ è§€çœ¾ ${viewerId.substr(-3)} å·²é›¢é–‹`);
                    peerConnections.delete(viewerId);
                    break;
            }
        };
        
        // ç›£è½ ICE é€£æ¥ç‹€æ…‹
        peerConnection.oniceconnectionstatechange = function() {
            console.log('è§€çœ¾', viewerId, 'ICE ç‹€æ…‹:', peerConnection.iceConnectionState);
            
            if (peerConnection.iceConnectionState === 'failed') {
                console.log(`âŒ è§€çœ¾ ${viewerId.substr(-3)} ICE é€£æ¥å¤±æ•—`);
            } else if (peerConnection.iceConnectionState === 'connected') {
                console.log(`âœ… è§€çœ¾ ${viewerId.substr(-3)} ICE é€£æ¥æˆåŠŸ`);
            }
        };
        
        // ç›£è½ä¿¡ä»¤ç‹€æ…‹
        peerConnection.onsignalingstatechange = function() {
            console.log('è§€çœ¾', viewerId, 'ä¿¡ä»¤ç‹€æ…‹:', peerConnection.signalingState);
        };
        
        // å„²å­˜é€£æ¥
        peerConnections.set(viewerId, peerConnection);
        console.log('WebRTC é€£æ¥å·²å»ºç«‹ä¸¦å„²å­˜');
        
    } catch (error) {
        console.error('å»ºç«‹ WebRTC é€£æ¥å¤±æ•—:', error);
        addMessage('ç³»çµ±', `âŒ ç‚ºè§€çœ¾ ${viewerId.substr(-3)} å»ºç«‹é€£æ¥å¤±æ•—`);
    }
}

// ç™¼é€ä¸²æµçµ¦è§€çœ¾
async function sendStreamToViewer(viewerId) {
    const peerConnection = peerConnections.get(viewerId);
    if (!peerConnection) {
        console.error('æ‰¾ä¸åˆ°è§€çœ¾çš„ PeerConnection:', viewerId);
        addMessage('ç³»çµ±', `âŒ æ‰¾ä¸åˆ°è§€çœ¾ ${viewerId.substr(-3)} çš„é€£æ¥`);
        return;
    }
    
    try {
        console.log('ç‚ºè§€çœ¾', viewerId, 'å‰µå»º WebRTC offer');
        addMessage('ç³»çµ±', `ğŸ”„ æ­£åœ¨ç‚ºè§€çœ¾ ${viewerId.substr(-3)} å‰µå»ºé€£æ¥...`);
        
        // å‰µå»º offer
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        console.log('Offer å‰µå»ºæˆåŠŸï¼Œæº–å‚™ç™¼é€çµ¦è§€çœ¾:', viewerId);
        
        // ç™¼é€ offer çµ¦è§€çœ¾
        if (streamingSocket && streamingSocket.readyState === WebSocket.OPEN) {
            const offerMessage = {
                type: 'offer',
                offer: offer,
                broadcasterId: getBroadcasterId(),
                viewerId: viewerId
            };
            console.log('ç™¼é€ offer çµ¦è§€çœ¾:', viewerId, '- Offer SDP é•·åº¦:', offer.sdp.length);
            streamingSocket.send(JSON.stringify(offerMessage));
            addMessage('ç³»çµ±', `ğŸ“¤ å·²å‘è§€çœ¾ ${viewerId.substr(-3)} ç™¼é€é€£æ¥è«‹æ±‚`);
        } else {
            console.error('WebSocket é€£æ¥ä¸å¯ç”¨ï¼Œç„¡æ³•ç™¼é€ offer');
            addMessage('ç³»çµ±', `âŒ ç„¡æ³•ç™¼é€é€£æ¥è«‹æ±‚ï¼šWebSocket æœªé€£æ¥`);
        }
        
    } catch (error) {
        console.error('ç™¼é€ä¸²æµå¤±æ•—:', error);
        addMessage('ç³»çµ±', `âŒ ç™¼é€ä¸²æµçµ¦è§€çœ¾ ${viewerId.substr(-3)} å¤±æ•—: ${error.message}`);
    }
}

// è™•ç†è§€çœ¾çš„ answer
async function handleAnswer(data) {
    console.log('æ”¶åˆ°è§€çœ¾ answer:', data.viewerId);
    const peerConnection = peerConnections.get(data.viewerId);
    
    if (peerConnection) {
        try {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            console.log('å·²è¨­ç½®è§€çœ¾ answer ç‚ºé ç«¯æè¿°');
            console.log(`âœ… è§€çœ¾ ${data.viewerId.substr(-3)} é€£æ¥å›æ‡‰å·²è™•ç†`);
        } catch (error) {
            console.log('è¨­ç½®è§€çœ¾ answer å¤±æ•—:', error);
            console.log(`âŒ è™•ç†è§€çœ¾ ${data.viewerId.substr(-3)} å›æ‡‰å¤±æ•—`);
        }
    } else {
        console.error('æ‰¾ä¸åˆ°è§€çœ¾çš„ WebRTC é€£æ¥:', data.viewerId);
        addMessage('ç³»çµ±', `âŒ æ‰¾ä¸åˆ°è§€çœ¾ ${data.viewerId.substr(-3)} çš„é€£æ¥`);
    }
}

// è™•ç† ICE å€™é¸
async function handleIceCandidate(data) {
    console.log('æ”¶åˆ°è§€çœ¾ ICE å€™é¸:', data.viewerId);
    const peerConnection = peerConnections.get(data.viewerId);
    
    if (peerConnection && data.candidate) {
        try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            console.log('å·²æ·»åŠ è§€çœ¾ ICE å€™é¸');
        } catch (error) {
            console.error('æ·»åŠ è§€çœ¾ ICE å€™é¸å¤±æ•—:', error);
            addMessage('ç³»çµ±', `âŒ è™•ç†è§€çœ¾ ${data.viewerId.substr(-3)} ICE å€™é¸å¤±æ•—`);
        }
    } else {
        console.error('ç„¡æ³•è™•ç† ICE å€™é¸:', data);
    }
}

// è™•ç†èŠå¤©è¨Šæ¯
function handleChatMessage(data) {
    // ç²å–æ¶ˆæ¯æ–‡æœ¬ï¼ˆæ”¯æŒæ–°èˆŠæ ¼å¼ï¼‰
    const messageText = data.text || data.message || '';
    const userName = data.username || 'æœªçŸ¥ç”¨æˆ¶';
    
    if (data.viewerId && data.viewerId !== 'system') { 
        // ä¾†è‡ªè§€çœ¾çš„è¨Šæ¯
        const viewerName = data.username || `è§€çœ¾${data.viewerId.substr(-3)}`;
        addMessage(viewerName, messageText);
        console.log('æ”¶åˆ°è§€çœ¾è¨Šæ¯:', viewerName, messageText);
    } else if (data.isStreamer) {
        // ä¾†è‡ªä¸»æ’­çš„è¨Šæ¯ï¼ˆå›é¡¯ç¢ºèªï¼‰
        console.log('æ”¶åˆ°ä¸»æ’­è¨Šæ¯å›é¡¯:', userName, messageText);
        // ä¸»æ’­çš„æ¶ˆæ¯å·²ç¶“åœ¨ç™¼é€æ™‚æœ¬åœ°é¡¯ç¤ºäº†ï¼Œä¸éœ€è¦é‡è¤‡é¡¯ç¤º
    } else if (data.isSystemMessage || data.viewerId === 'system') {
        // ç³»çµ±æ¶ˆæ¯
        addMessage('ç³»çµ±', messageText);
        console.log('æ”¶åˆ°ç³»çµ±è¨Šæ¯:', messageText);
    } else {
        // å…¶ä»–æ¶ˆæ¯
        addMessage(userName, messageText);
        console.log('æ”¶åˆ°å…¶ä»–è¨Šæ¯:', userName, messageText);
    }
}

// æ›´æ–°è§€çœ¾æ•¸é‡
function updateViewerCount(count) {
    viewerCount = count;
    document.getElementById('viewerCount').textContent = count;
    document.getElementById('chatViewerCount').textContent = count;
}

// æ›´æ–°æ‰€æœ‰ WebRTC é€£æ¥çš„è»Œé“
async function updateAllPeerConnections() {
    if (!localStream) return;
    
    try {
        addMessage('ç³»çµ±', 'ğŸ”„ æ­£åœ¨æ›´æ–°æ‰€æœ‰è§€çœ¾çš„è¦–è¨Šè»Œé“...');
        
        // ç‚ºæ¯å€‹è§€çœ¾é‡æ–°å»ºç«‹é€£æ¥
        const viewerIds = Array.from(peerConnections.keys());
        
        for (const viewerId of viewerIds) {
            // é—œé–‰èˆŠé€£æ¥
            const oldConnection = peerConnections.get(viewerId);
            if (oldConnection) {
                oldConnection.close();
                peerConnections.delete(viewerId);
            }
            
            // å»ºç«‹æ–°é€£æ¥
            createPeerConnection(viewerId);
            await sendStreamToViewer(viewerId);
        }
        
        addMessage('ç³»çµ±', 'âœ… æ‰€æœ‰è§€çœ¾çš„è¦–è¨Šè»Œé“å·²æ›´æ–°');
    } catch (error) {
        console.error('æ›´æ–° WebRTC é€£æ¥å¤±æ•—:', error);
        addMessage('ç³»çµ±', 'âŒ æ›´æ–°è¦–è¨Šè»Œé“å¤±æ•—');
    }
}

// æ›´æ–°å–®å€‹ WebRTC é€£æ¥çš„è»Œé“ï¼ˆç”¨æ–¼è¦–è¨Šé–‹é—œç­‰ï¼‰
async function updatePeerConnectionTracks(viewerId) {
    const peerConnection = peerConnections.get(viewerId);
    if (!peerConnection || !localStream) return;
    
    try {
        console.log('æ­£åœ¨æ›´æ–°è§€çœ¾', viewerId, 'çš„è»Œé“...');
        
        // ç²å–ç•¶å‰è»Œé“
        const currentTracks = localStream.getTracks();
        const currentSenders = peerConnection.getSenders();
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°è»Œé“
        let needsUpdate = false;
        
        // æª¢æŸ¥è»Œé“æ•¸é‡æ˜¯å¦åŒ¹é…
        if (currentTracks.length !== currentSenders.length) {
            needsUpdate = true;
        } else {
            // æª¢æŸ¥è»Œé“å…§å®¹æ˜¯å¦åŒ¹é…
            for (let i = 0; i < currentTracks.length; i++) {
                if (currentSenders[i] && currentSenders[i].track) {
                    if (currentSenders[i].track.id !== currentTracks[i].id) {
                        needsUpdate = true;
                        break;
                    }
                } else {
                    needsUpdate = true;
                    break;
                }
            }
        }
        
        if (!needsUpdate) {
            console.log('è§€çœ¾', viewerId, 'çš„è»Œé“å·²æ˜¯æœ€æ–°ï¼Œç„¡éœ€æ›´æ–°');
            return;
        }
        
        // æ™ºèƒ½è»Œé“æ›´æ–°ï¼šåªæ›´æ–°è®ŠåŒ–çš„è»Œé“ï¼Œä¿æŒéŸ³è¨Šè»Œé“
        const audioTrack = currentTracks.find(track => track.kind === 'audio');
        const videoTrack = currentTracks.find(track => track.kind === 'video');
        
        // æ‰¾åˆ°ç¾æœ‰çš„è»Œé“ç™¼é€å™¨
        const existingAudioSender = currentSenders.find(sender => 
            sender.track && sender.track.kind === 'audio'
        );
        const existingVideoSender = currentSenders.find(sender => 
            sender.track && sender.track.kind === 'video'
        );
        
        // åªæ›´æ–°è¦–è¨Šè»Œé“ï¼Œä¿æŒéŸ³è¨Šè»Œé“
        if (videoTrack && videoTrack.readyState === 'live') {
            if (existingVideoSender) {
                // æ›¿æ›ç¾æœ‰è¦–è¨Šè»Œé“
                await existingVideoSender.replaceTrack(videoTrack);
                console.log('å·²æ›¿æ›è¦–è¨Šè»Œé“ï¼Œè»Œé“ID:', videoTrack.id);
            } else {
                // æ·»åŠ æ–°è¦–è¨Šè»Œé“
                peerConnection.addTrack(videoTrack, localStream);
                console.log('å·²æ·»åŠ æ–°è¦–è¨Šè»Œé“ï¼Œè»Œé“ID:', videoTrack.id);
            }
        }
        
        // ç¢ºä¿éŸ³è¨Šè»Œé“å­˜åœ¨ä¸”å•Ÿç”¨
        if (audioTrack && audioTrack.readyState === 'live') {
            if (!existingAudioSender) {
                peerConnection.addTrack(audioTrack, localStream);
                console.log('å·²æ·»åŠ éŸ³è¨Šè»Œé“ï¼Œè»Œé“ID:', audioTrack.id);
            } else if (existingAudioSender.track !== audioTrack) {
                // éŸ³è¨Šè»Œé“å·²æ›´æ”¹ï¼Œæ›¿æ›å®ƒ
                await existingAudioSender.replaceTrack(audioTrack);
                console.log('å·²æ›¿æ›éŸ³è¨Šè»Œé“ï¼Œè»Œé“ID:', audioTrack.id);
            } else {
                console.log('éŸ³è¨Šè»Œé“ä¿æŒä¸è®Šï¼Œè»Œé“ID:', audioTrack.id);
            }
        }
        
        // é‡æ–°å”å•†é€£æ¥
        try {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            // ç™¼é€æ–°çš„ offer çµ¦è§€çœ¾
            if (streamingSocket) {
                const offerMessage = {
                    type: 'offer',
                    offer: offer,
                    broadcasterId: getBroadcasterId(),
                    viewerId: viewerId
                };
                console.log('ç™¼é€æ›´æ–°å¾Œçš„ offer çµ¦è§€çœ¾:', viewerId);
                streamingSocket.send(JSON.stringify(offerMessage));
            }
            
            console.log('å·²æ›´æ–°è§€çœ¾', viewerId, 'çš„è»Œé“ä¸¦é‡æ–°å”å•†');
        } catch (error) {
            console.error('é‡æ–°å”å•†å¤±æ•—:', error);
        }
        
    } catch (error) {
        console.error('æ›´æ–°è»Œé“å¤±æ•—:', error);
    }
}

// é é¢å¸è¼‰æ™‚æ¸…ç†è³‡æº
window.addEventListener('beforeunload', function() {
    if (streamingSocket) {
        streamingSocket.close();
    }
    
    // é—œé–‰æ‰€æœ‰ WebRTC é€£æ¥
    peerConnections.forEach(connection => {
        connection.close();
    });
    peerConnections.clear();
});

// åˆå§‹åŒ–èŠå¤©å®¤åŠŸèƒ½
function initializeChat() {
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    
    if (chatMessages) {
        console.log('åˆå§‹åŒ–èŠå¤©å®¤å®¹å™¨');
        
        // ç¢ºä¿å®¹å™¨æœ‰æ­£ç¢ºçš„æ»¾å‹•å±¬æ€§
        chatMessages.style.overflowY = 'auto';
        chatMessages.style.overflowX = 'hidden';
        
        // ç¢ºä¿èŠå¤©å®¤åˆå§‹å°±æ»¾å‹•åˆ°åº•éƒ¨
        scrollChatToBottom();
        
        // ç›£è½æ–°è¨Šæ¯æ·»åŠ ï¼Œè‡ªå‹•æ»¾å‹•
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    console.log('æª¢æ¸¬åˆ°æ–°è¨Šæ¯ï¼Œè‡ªå‹•æ»¾å‹•');
                    scrollChatToBottom();
                }
            });
        });
        
        observer.observe(chatMessages, {
            childList: true,
            subtree: false
        });
        
        // ç›£è½æ»¾å‹•äº‹ä»¶ï¼Œç”¨æ–¼èª¿è©¦
        chatMessages.addEventListener('scroll', () => {
            console.log('èŠå¤©å®¤æ»¾å‹•ä½ç½®:', chatMessages.scrollTop, '/', chatMessages.scrollHeight);
        });
    }
    
    // ç‚ºè¼¸å…¥æ¡†æ·»åŠ å¯¦æ™‚æ»¾å‹•
    if (messageInput) {
        messageInput.addEventListener('input', () => {
            // ç•¶ç”¨æˆ¶æ­£åœ¨è¼¸å…¥æ™‚ä¹Ÿä¿æŒåœ¨åº•éƒ¨
            setTimeout(scrollChatToBottom, 50);
        });
        
        // ç•¶è¼¸å…¥æ¡†ç²å¾—ç„¦é»æ™‚ï¼Œæ»¾å‹•åˆ°åº•éƒ¨
        messageInput.addEventListener('focus', () => {
            setTimeout(scrollChatToBottom, 100);
        });
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeChat();
    console.log('èŠå¤©å®¤åŠŸèƒ½å·²åˆå§‹åŒ–');
});

// åˆ†é éŸ³è¨Šæ•ç²åŠŸèƒ½
async function captureTabWithAudio() {
    try {
        console.log('é–‹å§‹æ•ç²åˆ†é éŸ³è¨Š...');
        addMessage('ç³»çµ±', 'ğŸµ æ­£åœ¨å•Ÿç”¨åˆ†é éŸ³è¨Šåˆ†äº«...');
        
        // è«‹æ±‚åˆ†é è¢å¹•å…±äº«ï¼ˆåŒ…å«éŸ³è¨Šï¼‰
        const stream = await navigator.mediaDevices.getDisplayMedia({ 
            video: {
                mediaSource: 'tab'
            },
            audio: {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false,
                googEchoCancellation: false,
                googAutoGainControl: false,
                googNoiseSuppression: false,
                googHighpassFilter: false,
                googAudioMirroring: false
            }
        });
        
        // æª¢æŸ¥æ˜¯å¦åŒ…å«éŸ³è¨Šè»Œé“
        const audioTracks = stream.getAudioTracks();
        if (audioTracks.length === 0) {
            addMessage('ç³»çµ±', 'âš ï¸ æ‰€é¸åˆ†é æ²’æœ‰éŸ³è¨Šï¼Œè«‹é¸æ“‡åŒ…å«éŸ³è¨Šçš„åˆ†é ï¼ˆå¦‚YouTubeç­‰éŸ³æ¨‚ç¶²ç«™ï¼‰');
            stream.getTracks().forEach(track => track.stop());
            return null;
        }
        
        console.log('åˆ†é éŸ³è¨Šè»Œé“ä¿¡æ¯:', audioTracks[0].getSettings());
        
        // åœæ­¢è¦–è¨Šè»Œé“ï¼ˆæˆ‘å€‘åªéœ€è¦éŸ³è¨Šï¼‰
        stream.getVideoTracks().forEach(track => track.stop());
        
        addMessage('ç³»çµ±', 'âœ… åˆ†é éŸ³è¨Šå·²æˆåŠŸå•Ÿç”¨ï¼Œè§€çœ¾ç¾åœ¨å¯ä»¥è½åˆ°èƒŒæ™¯éŸ³æ¨‚');
        return stream;
    } catch (error) {
        console.error('æ•ç²åˆ†é éŸ³è¨Šå¤±æ•—:', error);
        if (error.name === 'NotAllowedError') {
            addMessage('ç³»çµ±', 'âŒ ç”¨æˆ¶æ‹’çµ•äº†åˆ†é éŸ³è¨Šæ¬Šé™ï¼Œè«‹é‡è©¦ä¸¦å…è¨±éŸ³è¨Šåˆ†äº«');
        } else if (error.name === 'NotFoundError') {
            addMessage('ç³»çµ±', 'âŒ æœªæ‰¾åˆ°éŸ³è¨Šæºï¼Œè«‹ç¢ºä¿é¸æ“‡çš„åˆ†é æœ‰éŸ³è¨Šæ’­æ”¾');
        } else {
            addMessage('ç³»çµ±', 'âŒ å•Ÿç”¨åˆ†é éŸ³è¨Šå¤±æ•—ï¼Œè«‹ç¢ºä¿ä½¿ç”¨æ”¯æ´çš„ç€è¦½å™¨');
        }
        return null;
    }
}

// å‰µå»ºæ··éŸ³éŸ³è¨Šæµ
async function createMixedStream(tabStream) {
    try {
        console.log('é–‹å§‹å‰µå»ºæ··éŸ³éŸ³è¨Šæµ...');
        
        // é—œé–‰ä¹‹å‰çš„éŸ³è¨Šä¸Šä¸‹æ–‡
        if (audioContext && audioContext.state !== 'closed') {
            await audioContext.close();
        }
        
        // å‰µå»ºæ–°çš„éŸ³è¨Šä¸Šä¸‹æ–‡
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const destination = audioContext.createMediaStreamDestination();
        
        let hasAudio = false;
        
        // è™•ç†åˆ†é éŸ³è¨Šï¼ˆèƒŒæ™¯éŸ³æ¨‚ï¼‰
        if (tabStream) {
            const tabAudioTracks = tabStream.getAudioTracks();
            if (tabAudioTracks.length > 0) {
                const tabSource = audioContext.createMediaStreamSource(tabStream);
                const tabGain = audioContext.createGain();
                tabGain.gain.value = 0.8; // è¨­ç½®èƒŒæ™¯éŸ³æ¨‚éŸ³é‡
                tabSource.connect(tabGain);
                tabGain.connect(destination);
                hasAudio = true;
                
                console.log('åˆ†é éŸ³è¨Šå·²é€£æ¥åˆ°æ··éŸ³å™¨ï¼ŒéŸ³é‡è¨­ç‚º 80%');
                addMessage('ç³»çµ±', 'ğŸµ èƒŒæ™¯éŸ³æ¨‚å·²åŠ å…¥ç›´æ’­ä¸²æµ');
            }
        }
        
        // è™•ç†éº¥å…‹é¢¨éŸ³è¨Š
        if (localStream) {
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                const micStream = new MediaStream(audioTracks);
                const micSource = audioContext.createMediaStreamSource(micStream);
                const micGain = audioContext.createGain();
                micGain.gain.value = 1.0; // ä¿æŒéº¥å…‹é¢¨åŸéŸ³é‡
                micSource.connect(micGain);
                micGain.connect(destination);
                hasAudio = true;
                
                console.log('éº¥å…‹é¢¨éŸ³è¨Šå·²é€£æ¥åˆ°æ··éŸ³å™¨');
                addMessage('ç³»çµ±', 'ğŸ¤ éº¥å…‹é¢¨éŸ³è¨Šå·²åŠ å…¥æ··éŸ³');
            }
        }
        
        if (!hasAudio) {
            console.warn('æ²’æœ‰å¯ç”¨çš„éŸ³è¨Šæº');
            addMessage('ç³»çµ±', 'âš ï¸ æ²’æœ‰æª¢æ¸¬åˆ°éŸ³è¨Šæº');
            return null;
        }
        
        console.log('æ··éŸ³éŸ³è¨Šæµå‰µå»ºæˆåŠŸ');
        addMessage('ç³»çµ±', 'âœ… éŸ³è¨Šæ··éŸ³å®Œæˆï¼Œè§€çœ¾ç¾åœ¨å¯ä»¥åŒæ™‚è½åˆ°æ‚¨çš„è²éŸ³å’ŒèƒŒæ™¯éŸ³æ¨‚');
        return destination.stream;
    } catch (error) {
        console.error('å‰µå»ºæ··éŸ³éŸ³è¨Šæµå¤±æ•—:', error);
        addMessage('ç³»çµ±', 'âŒ éŸ³è¨Šæ··éŸ³å¤±æ•—: ' + error.message);
        return null;
    }
}

// æ›´æ–°WebRTCé€£æ¥ä¸­çš„éŸ³è¨Šè»Œé“
async function updateAudioTracks(newAudioStream) {
    try {
        console.log('æ›´æ–°WebRTCéŸ³è¨Šè»Œé“...');
        
        const audioTracks = newAudioStream.getAudioTracks();
        if (audioTracks.length === 0) {
            console.warn('æ–°éŸ³è¨Šæµæ²’æœ‰éŸ³è¨Šè»Œé“');
            return;
        }
        
        const newAudioTrack = audioTracks[0];
        
        // æ›´æ–°æ‰€æœ‰è§€çœ¾çš„WebRTCé€£æ¥
        for (const [viewerId, peerConnection] of peerConnections) {
            try {
                // æ‰¾åˆ°ç¾æœ‰çš„éŸ³è¨Šç™¼é€å™¨
                const audioSender = peerConnection.getSenders().find(sender => 
                    sender.track && sender.track.kind === 'audio'
                );
                
                if (audioSender) {
                    // æ›¿æ›éŸ³è¨Šè»Œé“
                    await audioSender.replaceTrack(newAudioTrack);
                    console.log(`å·²ç‚ºè§€çœ¾ ${viewerId} æ›´æ–°éŸ³è¨Šè»Œé“`);
                } else {
                    // æ·»åŠ æ–°çš„éŸ³è¨Šè»Œé“
                    peerConnection.addTrack(newAudioTrack, newAudioStream);
                    console.log(`å·²ç‚ºè§€çœ¾ ${viewerId} æ·»åŠ éŸ³è¨Šè»Œé“`);
                }
            } catch (error) {
                console.error(`æ›´æ–°è§€çœ¾ ${viewerId} çš„éŸ³è¨Šè»Œé“å¤±æ•—:`, error);
            }
        }
        
        addMessage('ç³»çµ±', 'ğŸ”„ éŸ³è¨Šè»Œé“å·²æ›´æ–°çµ¦æ‰€æœ‰è§€çœ¾');
    } catch (error) {
        console.error('æ›´æ–°éŸ³è¨Šè»Œé“å¤±æ•—:', error);
        addMessage('ç³»çµ±', 'âŒ éŸ³è¨Šè»Œé“æ›´æ–°å¤±æ•—');
    }
}

// åˆ‡æ›åˆ†é éŸ³è¨ŠåŠŸèƒ½
async function toggleTabAudio() {
    const tabAudioBtn = document.getElementById('tabAudioBtn');
    
    if (!tabAudioBtn) {
        console.error('æ‰¾ä¸åˆ°åˆ†é éŸ³è¨ŠæŒ‰éˆ•');
        return;
    }
    
    if (!isTabAudioEnabled) {
        // å•Ÿç”¨åˆ†é éŸ³è¨Š
        try {
            // æª¢æŸ¥æ˜¯å¦æ­£åœ¨ç›´æ’­
            if (!isStreaming) {
                addMessage('ç³»çµ±', 'âš ï¸ è«‹å…ˆé–‹å§‹ç›´æ’­å†å•Ÿç”¨èƒŒæ™¯éŸ³æ¨‚åˆ†äº«');
                return;
            }
            
            addMessage('ç³»çµ±', 'ğŸ“» æº–å‚™å•Ÿç”¨èƒŒæ™¯éŸ³æ¨‚åˆ†äº«...');
            tabAudioStream = await captureTabWithAudio();
            
            if (tabAudioStream) {
                isTabAudioEnabled = true;
                tabAudioBtn.classList.add('active');
                tabAudioBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                tabAudioBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                
                // å‰µå»ºæ··éŸ³éŸ³è¨Šæµ
                mixedAudioStream = await createMixedStream(tabAudioStream);
                
                if (mixedAudioStream && isStreaming) {
                    // æ›´æ–°WebRTCé€£æ¥ä¸­çš„éŸ³è¨Šè»Œé“
                    await updateAudioTracks(mixedAudioStream);
                    addMessage('ç³»çµ±', 'ğŸ‰ èƒŒæ™¯éŸ³æ¨‚åˆ†äº«å·²æˆåŠŸå•Ÿç”¨ï¼è§€çœ¾ç¾åœ¨å¯ä»¥è½åˆ°éŸ³æ¨‚äº†');
                } else {
                    throw new Error('æ··éŸ³éŸ³è¨Šæµå‰µå»ºå¤±æ•—');
                }
            } else {
                throw new Error('ç„¡æ³•æ•ç²åˆ†é éŸ³è¨Š');
            }
        } catch (error) {
            console.error('å•Ÿç”¨åˆ†é éŸ³è¨Šå¤±æ•—:', error);
            addMessage('ç³»çµ±', 'âŒ å•Ÿç”¨èƒŒæ™¯éŸ³æ¨‚åˆ†äº«å¤±æ•—: ' + error.message);
            
            // é‡ç½®ç‹€æ…‹
            isTabAudioEnabled = false;
            if (tabAudioStream) {
                tabAudioStream.getTracks().forEach(track => track.stop());
                tabAudioStream = null;
            }
            tabAudioBtn.classList.remove('active');
            tabAudioBtn.style.background = '';
            tabAudioBtn.innerHTML = '<i class="fas fa-volume-off"></i>';
        }
    } else {
        // åœç”¨åˆ†é éŸ³è¨Š
        try {
            addMessage('ç³»çµ±', 'ğŸ”‡ æ­£åœ¨åœç”¨èƒŒæ™¯éŸ³æ¨‚åˆ†äº«...');
            
            if (tabAudioStream) {
                tabAudioStream.getTracks().forEach(track => track.stop());
                tabAudioStream = null;
            }
            
            if (audioContext && audioContext.state !== 'closed') {
                await audioContext.close();
                audioContext = null;
            }
            
            if (mixedAudioStream) {
                mixedAudioStream.getTracks().forEach(track => track.stop());
                mixedAudioStream = null;
            }
            
            isTabAudioEnabled = false;
            tabAudioBtn.classList.remove('active');
            tabAudioBtn.style.background = '';
            tabAudioBtn.innerHTML = '<i class="fas fa-volume-off"></i>';
            
            // æ¢å¾©åˆ°åŸå§‹éº¥å…‹é¢¨éŸ³è¨Š
            if (localStream && isStreaming) {
                await updateAudioTracks(localStream);
            }
            
            addMessage('ç³»çµ±', 'âœ… èƒŒæ™¯éŸ³æ¨‚åˆ†äº«å·²åœç”¨ï¼Œæ¢å¾©ç‚ºç´”éº¥å…‹é¢¨éŸ³è¨Š');
        } catch (error) {
            console.error('åœç”¨åˆ†é éŸ³è¨Šå¤±æ•—:', error);
            addMessage('ç³»çµ±', 'âŒ åœç”¨èƒŒæ™¯éŸ³æ¨‚åˆ†äº«æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
        }
    }
}

// ========== è¦–é »ç·¨ç¢¼å„ªåŒ–åŠŸèƒ½ ==========

// å„ªåŒ–è¦–é »ç·¨ç¢¼å™¨è¨­å®šï¼Œæé«˜è§€çœ¾ç«¯è§£ç¢¼æˆåŠŸç‡
function optimizeVideoEncodingForCompatibility() {
    console.log('ğŸ”§ [ç·¨ç¢¼å„ªåŒ–] é–‹å§‹å„ªåŒ–è¦–é »ç·¨ç¢¼è¨­å®š...');
    
    // æª¢æŸ¥ç™¼é€ç«¯èƒ½åŠ›
    if (window.RTCRtpSender && RTCRtpSender.getCapabilities) {
        const videoCapabilities = RTCRtpSender.getCapabilities('video');
        if (videoCapabilities && videoCapabilities.codecs) {
            console.log('ğŸ¥ [ç™¼é€ç«¯] æ”¯æ´çš„è¦–é »ç·¨è§£ç¢¼å™¨:');
            videoCapabilities.codecs.forEach(codec => {
                console.log(`  ${codec.mimeType} - ${codec.clockRate || 'N/A'}Hz`);
            });
            
            // å°‹æ‰¾æœ€ä½³ç·¨è§£ç¢¼å™¨
            const preferredCodecs = [
                'video/H264', // æœ€å»£æ³›æ”¯æ´
                'video/VP8',  // WebRTC æ¨™æº–
                'video/VP9'   // è¼ƒæ–°ä½†æ”¯æ´è‰¯å¥½
            ];
            
            const availableCodecs = videoCapabilities.codecs.filter(codec => 
                preferredCodecs.some(preferred => codec.mimeType.includes(preferred))
            );
            
            console.log('ğŸ¯ [ç·¨ç¢¼å„ªåŒ–] å¯ç”¨çš„é¦–é¸ç·¨è§£ç¢¼å™¨:', availableCodecs.length);
            availableCodecs.forEach(codec => {
                console.log(`  âœ… ${codec.mimeType}`);
            });
            
            addMessage('ç³»çµ±', `ğŸ¥ æª¢æ¸¬åˆ° ${availableCodecs.length} å€‹å…¼å®¹çš„è¦–é »ç·¨è§£ç¢¼å™¨`);
        }
    }
    
    return true;
}

// ç‚º PeerConnection è¨­å®šé¦–é¸ç·¨è§£ç¢¼å™¨
function setPreferredVideoCodecs(peerConnection) {
    if (!peerConnection || !RTCRtpSender.getCapabilities) {
        return;
    }
    
    try {
        const transceivers = peerConnection.getTransceivers();
        const videoTransceiver = transceivers.find(t => 
            t.sender && t.sender.track && t.sender.track.kind === 'video'
        );
        
        if (videoTransceiver) {
            const capabilities = RTCRtpSender.getCapabilities('video');
            if (capabilities && capabilities.codecs) {
                // æŒ‰åå¥½æ’åºç·¨è§£ç¢¼å™¨
                const sortedCodecs = capabilities.codecs.sort((a, b) => {
                    const preferenceOrder = [
                        'video/H264',
                        'video/VP8', 
                        'video/VP9',
                        'video/AV1'
                    ];
                    
                    const aIndex = preferenceOrder.findIndex(p => a.mimeType.includes(p));
                    const bIndex = preferenceOrder.findIndex(p => b.mimeType.includes(p));
                    
                    if (aIndex === -1) return 1;
                    if (bIndex === -1) return -1;
                    
                    return aIndex - bIndex;
                });
                
                // è¨­å®šç·¨è§£ç¢¼å™¨åå¥½
                videoTransceiver.setCodecPreferences(sortedCodecs);
                console.log('âœ… [ç·¨ç¢¼å„ªåŒ–] å·²è¨­å®šç·¨è§£ç¢¼å™¨åå¥½é †åº');
                addMessage('ç³»çµ±', 'âœ… è¦–é »ç·¨ç¢¼å™¨å·²å„ªåŒ–');
            }
        }
    } catch (error) {
        console.warn('âš ï¸ [ç·¨ç¢¼å„ªåŒ–] è¨­å®šç·¨è§£ç¢¼å™¨åå¥½å¤±æ•—:', error);
        // ä¸å½±éŸ¿ä¸»è¦åŠŸèƒ½ï¼Œç¹¼çºŒåŸ·è¡Œ
    }
}

// åœ¨å»ºç«‹ PeerConnection å¾Œå‘¼å«ç·¨ç¢¼å„ªåŒ–
function createOptimizedPeerConnection(viewerId) {
    try {
        console.log('ç‚ºè§€çœ¾', viewerId, 'å»ºç«‹å„ªåŒ–çš„ WebRTC é€£æ¥');
        const peerConnection = new RTCPeerConnection(rtcConfiguration);
        
        // æ·»åŠ æœ¬åœ°ä¸²æµè»Œé“
        if (localStream) {
            console.log('æœ¬åœ°ä¸²æµè»Œé“æ•¸é‡:', localStream.getTracks().length);
            
            const videoTracks = localStream.getVideoTracks();
            const audioTracks = localStream.getAudioTracks();
            
            console.log(`è¦–è¨Šè»Œé“: ${videoTracks.length}, éŸ³è¨Šè»Œé“: ${audioTracks.length}`);
            
            // æ·»åŠ è¦–è¨Šè»Œé“
            videoTracks.forEach((track, index) => {
                try {
                    const sender = peerConnection.addTrack(track, localStream);
                    console.log(`âœ… å·²æ·»åŠ è¦–è¨Šè»Œé“ ${index}:`, track.readyState, track.id);
                    
                    // å˜—è©¦å„ªåŒ–æ­¤ç™¼é€å™¨çš„ç·¨ç¢¼åƒæ•¸
                    if (sender.setParameters) {
                        sender.getParameters().then(params => {
                            if (params.encodings && params.encodings.length > 0) {
                                // è¨­å®šé©ä¸­çš„ç¢¼ç‡ï¼Œç¢ºä¿å…¼å®¹æ€§
                                params.encodings[0].maxBitrate = 2500000; // 2.5 Mbps
                                params.encodings[0].maxFramerate = 30;
                                
                                return sender.setParameters(params);
                            }
                        }).then(() => {
                            console.log(`âœ… å·²å„ªåŒ–è¦–è¨Šè»Œé“ ${index} ç·¨ç¢¼åƒæ•¸`);
                        }).catch(error => {
                            console.warn(`âš ï¸ å„ªåŒ–è¦–è¨Šè»Œé“ ${index} ç·¨ç¢¼åƒæ•¸å¤±æ•—:`, error);
                        });
                    }
                } catch (error) {
                    console.error(`âŒ æ·»åŠ è¦–è¨Šè»Œé“ ${index} å¤±æ•—:`, error);
                }
            });
            
            // æ·»åŠ éŸ³è¨Šè»Œé“
            audioTracks.forEach((track, index) => {
                try {
                    const sender = peerConnection.addTrack(track, localStream);
                    console.log(`âœ… å·²æ·»åŠ éŸ³è¨Šè»Œé“ ${index}:`, track.readyState, track.id);
                } catch (error) {
                    console.error(`âŒ æ·»åŠ éŸ³è¨Šè»Œé“ ${index} å¤±æ•—:`, error);
                }
            });
            
            addMessage('ç³»çµ±', `ğŸ“¹ å·²ç‚ºè§€çœ¾ ${viewerId.substr(-3)} æ·»åŠ  ${videoTracks.length} å€‹è¦–è¨Šè»Œé“å’Œ ${audioTracks.length} å€‹éŸ³è¨Šè»Œé“`);
            
            // å»¶é²è¨­å®šç·¨è§£ç¢¼å™¨åå¥½ï¼Œç¢ºä¿è»Œé“å·²æ·»åŠ 
            setTimeout(() => {
                setPreferredVideoCodecs(peerConnection);
            }, 100);
            
        } else {
            console.error('âŒ æœ¬åœ°ä¸²æµä¸å­˜åœ¨');
            addMessage('ç³»çµ±', `âŒ ç„¡æ³•ç‚ºè§€çœ¾ ${viewerId.substr(-3)} å»ºç«‹é€£æ¥ï¼šæœ¬åœ°ä¸²æµä¸å­˜åœ¨`);
            return null;
        }
        
        return peerConnection;
        
    } catch (error) {
        console.error('å»ºç«‹å„ªåŒ– WebRTC é€£æ¥å¤±æ•—:', error);
        addMessage('ç³»çµ±', `âŒ ç‚ºè§€çœ¾ ${viewerId.substr(-3)} å»ºç«‹å„ªåŒ–é€£æ¥å¤±æ•—`);
        return null;
    }
}

// åœ¨æ‡‰ç”¨å•Ÿå‹•æ™‚åŸ·è¡Œç·¨ç¢¼å„ªåŒ–æª¢æ¸¬
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        optimizeVideoEncodingForCompatibility();
    }, 3000);
});

console.log('âœ… è¦–é »ç·¨ç¢¼å„ªåŒ–åŠŸèƒ½å·²è¼‰å…¥');
