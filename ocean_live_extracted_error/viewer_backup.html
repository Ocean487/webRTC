<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è§€çœ‹ç›´æ’­ - VibeLo</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* é ‚éƒ¨å°èˆªæ¬„ */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.8rem;
            font-weight: 700;
            color: #667eea;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-link {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            padding: 0.5rem 0;
        }

        .nav-link:hover,
        .nav-link.active {
            color: #667eea;
        }

        /* ç§»å‹•ç«¯èœå–®æŒ‰éˆ• */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #333;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            /* å¯è¨ªå•æ€§æ”¹é€² */
            min-width: 44px;
            min-height: 44px;
        }

        .mobile-menu-toggle:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .mobile-menu-toggle:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* ç§»å‹•ç«¯ä¸‹æ‹‰èœå–® */
        .mobile-nav {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding: 1rem;
            z-index: 1000;
        }

        .mobile-nav.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mobile-nav .nav-link {
            display: block;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 1.1rem;
        }

        .mobile-nav .nav-link:last-child {
            border-bottom: none;
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s ease;
            position: relative; /* ç¢ºä¿ç›¸å°å®šä½ */
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* ç”¨æˆ¶ä¸‹æ‹‰é¸å–® */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            min-width: 200px;
            z-index: 9999;
            margin-top: 0.5rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.15s ease-out;
            pointer-events: auto;
        }

        .user-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 16px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid white;
        }

        .menu-user-info {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 0.5rem;
        }

        .menu-user-name {
            font-weight: 600;
            color: #1f2937;
        }

        .menu-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            color: #4b5563;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .menu-link:hover {
            background: #f3f4f6;
            color: #667eea;
        }

        .menu-link.logout {
            color: #dc2626;
        }

        .menu-link.logout:hover {
            background: #fef2f2;
        }

        /* ä¸»è¦å…§å®¹ */
        .viewer-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        /* è¦–é »å€åŸŸ */
        .video-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stream-video {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .stream-video video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #videoPlaceholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }

        .play-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .play-prompt:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translate(-50%, -50%) scale(1.05);
        }

        /* ç›´æ’­ä¿¡æ¯ */
        .stream-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .streamer-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .streamer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .streamer-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .streamer-details h3 {
            color: white;
            margin-bottom: 0.5rem;
        }

        .stream-title {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            text-align: center;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(236, 72, 153, 0.15));
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            min-height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stream-title.updating {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(59, 130, 246, 0.2));
            border-color: rgba(34, 197, 94, 0.3);
            color: rgba(255, 255, 255, 1);
        }

        .stream-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            padding: 0.2rem 0.6rem;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
        }

        .status-text.status-starting {
            background: rgba(255, 165, 0, 0.3);
            color: #ffa500;
        }

        .status-text.status-live {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .status-text.status-stopped {
            background: rgba(158, 158, 158, 0.3);
            color: #9e9e9e;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #e74c3c;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .viewer-count {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        /* èŠå¤©å€åŸŸ */
        .chat-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            height: fit-content;
            max-height: 80vh;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 600;
        }

        .viewer-counter {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            max-height: 500px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .chat-message {
            display: flex;
            gap: 0.8rem;
            align-items: flex-start;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.2rem;
        }

        .message-user {
            font-weight: 600;
            color: #4ecdc4;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .message-text {
            color: white;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* ChatSystem æ¶ˆæ¯æ¨£å¼ - èˆ‡åŸæœ‰æ¨£å¼ä¿æŒä¸€è‡´ */
        .message {
            display: flex;
            gap: 0.8rem;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .message .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.broadcaster .message-avatar {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .message.viewer .message-avatar {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .message.system .message-avatar {
            background: linear-gradient(135deg, #feca57, #ff9ff3);
        }

        .message .message-content-wrapper {
            flex: 1;
        }

        .message .message-bubble {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 0.8rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .message.broadcaster .message-bubble {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(255, 107, 107, 0.4);
        }

        .message.viewer .message-bubble {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(78, 205, 196, 0.4);
        }

        .message.system .message-bubble {
            background: rgba(255, 255, 255, 0.85);
            border-color: rgba(254, 202, 87, 0.4);
        }

        .message .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .message .username {
            font-weight: 600;
            color: #4ecdc4;
            font-size: 0.9rem;
        }

        .message.broadcaster .username {
            color: #ff6b6b;
        }

        .message.viewer .username {
            color: #4ecdc4;
        }

        .message.system .username {
            color: #feca57;
        }

        .message .timestamp {
            font-size: 0.7rem;
            color: rgba(0, 0, 0, 0.5);
        }

        .message .message-content {
            color: #333;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .chat-input-container {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 0.8rem;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9rem;
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .chat-input:focus {
            outline: none;
            border-color: #4ecdc4;
            background: rgba(255, 255, 255, 0.15);
        }

        .send-button {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        /* å¤§å¹³æ¿ (1024px ä»¥ä¸‹) */
        @media (max-width: 1024px) {
            .viewer-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
                gap: 1.5rem;
                max-width: 100%;
            }

            .chat-section {
                max-height: 450px;
                height: 450px;
                overflow: hidden;
            }

            .chat-container {
                height: 100%;
                max-height: 100%;
                overflow: hidden;
            }

            .nav-container {
                padding: 0 1.5rem;
            }

            .video-section {
                padding: 1.5rem;
            }
        }

        /* å¹³æ¿ (768px ä»¥ä¸‹) */
        @media (max-width: 768px) {
            .nav-container {
                padding: 0 1rem;
                flex-wrap: wrap;
                gap: 1rem;
                position: relative;
            }

            .nav-links {
                display: none;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .logo {
                font-size: 1.5rem;
            }

            .viewer-container {
                margin: 1rem auto;
                padding: 0 1rem;
                gap: 1rem;
            }

            .video-section,
            .chat-section {
                padding: 1rem;
                border-radius: 15px;
            }

            .stream-video {
                margin-bottom: 1rem;
                border-radius: 10px;
            }

            .stream-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .streamer-info {
                width: 100%;
            }

            .streamer-avatar {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .chat-section {
                max-height: 400px;
                height: 400px;
                overflow: hidden;
            }

            .chat-container {
                height: 100%;
                max-height: 100%;
                overflow: hidden;
            }

            .chat-messages {
                padding: 1rem;
            }

            .chat-input-container {
                padding: 1rem;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
                background: rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                position: sticky;
                bottom: 0;
                width: 100%;
                box-sizing: border-box;
                z-index: 100;
                margin: 0;
                border-radius: 0 0 15px 15px;
                /* ä¿®å¾©å¹³æ¿è·‘ç‰ˆå•é¡Œ */
                display: flex;
                flex-direction: column;
                min-height: auto;
                flex-shrink: 0;
            }

            .chat-input-wrapper {
                display: flex;
                gap: 0.75rem;
                align-items: center;
            }

            .chat-input {
                flex: 1;
                font-size: 16px; /* é˜²æ­¢ iOS Safari ç¸®æ”¾ */
                padding: 0.8rem 1rem;
                border-radius: 22px;
                min-height: 44px;
                box-sizing: border-box;
            }
        }

        /* æ‰‹æ©Ÿ (480px ä»¥ä¸‹) */
        @media (max-width: 480px) {
            .navbar {
                padding: 0.75rem 0;
            }

            .nav-container {
                padding: 0 0.75rem;
            }

            .logo {
                font-size: 1.3rem;
                gap: 0.5rem;
            }

            .logo img {
                height: 35px !important;
            }

            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }

            .viewer-container {
                margin: 0.75rem auto;
                padding: 0 0.75rem;
                gap: 0.75rem;
            }

            .video-section,
            .chat-section {
                padding: 0.75rem;
                border-radius: 12px;
            }

            .stream-video {
                border-radius: 8px;
                margin-bottom: 0.75rem;
            }

            .streamer-avatar {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }

            .streamer-details h3 {
                font-size: 1rem;
            }

            .streamer-details p {
                font-size: 0.85rem;
            }

            .chat-section {
                max-height: 350px;
                height: 350px;
                overflow: hidden;
            }

            .chat-container {
                height: 100%;
                max-height: 100%;
                overflow: hidden;
            }

            .chat-header h3 {
                font-size: 1.1rem;
            }

            .chat-messages {
                padding: 0.75rem;
            }

            .message {
                margin-bottom: 0.75rem;
                gap: 0.6rem;
            }

            .message-avatar {
                width: 30px !important;
                height: 30px !important;
                font-size: 0.7rem !important;
            }

            .message-bubble {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
            }

            .message-text {
                font-size: 0.85rem;
                line-height: 1.3;
            }

            .message-time {
                font-size: 0.65rem;
            }

            .chat-input-container {
                padding: 0.75rem;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
                background: rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                position: sticky;
                bottom: 0;
                width: 100%;
                box-sizing: border-box;
                z-index: 100;
                margin: 0;
                border-radius: 0;
                /* ä¿®å¾©è·‘ç‰ˆå•é¡Œ */
                display: flex;
                flex-direction: column;
                min-height: auto;
            }

            .chat-input-wrapper {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }

            .chat-input {
                flex: 1;
                font-size: 16px; /* é˜²æ­¢ iOS Safari ç¸®æ”¾ */
                padding: 0.75rem 1rem;
                border-radius: 20px;
                min-height: 44px; /* ç¢ºä¿è§¸æ‘¸å‹å¥½çš„æœ€å°é«˜åº¦ */
                box-sizing: border-box;
            }

            .send-button {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
            }
        }

        /* è¶…å°æ‰‹æ©Ÿ (360px ä»¥ä¸‹) */
        @media (max-width: 360px) {
            .viewer-container {
                padding: 0 0.5rem;
                gap: 0.5rem;
            }

            .video-section,
            .chat-section {
                padding: 0.5rem;
            }

            .chat-section {
                max-height: 300px;
                height: 300px;
                overflow: hidden;
            }

            .chat-container {
                height: 100%;
                max-height: 100%;
                overflow: hidden;
            }

            .chat-messages {
                padding: 0.5rem;
            }

            .chat-input-container {
                padding: 0.5rem;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
                background: rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(10px);
                position: sticky;
                bottom: 0;
                width: 100%;
                box-sizing: border-box;
                z-index: 100;
                margin: 0;
                border-radius: 0;
                /* ä¿®å¾©è¶…å°è¢å¹•è·‘ç‰ˆå•é¡Œ */
                display: flex;
                flex-direction: column;
                min-height: auto;
                flex-shrink: 0;
            }

            .chat-input-wrapper {
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }

            .chat-input {
                flex: 1;
                padding: 0.6rem 0.8rem;
                border-radius: 18px;
                min-height: 40px;
                box-sizing: border-box;
            }

            .message {
                margin-bottom: 0.5rem;
                gap: 0.5rem;
            }

            .message-avatar {
                width: 28px !important;
                height: 28px !important;
                font-size: 0.65rem !important;
            }

            .message-bubble {
                padding: 0.5rem 0.7rem;
                font-size: 0.8rem;
            }
        }

        /* æ©«å±æ¨¡å¼å„ªåŒ– */
        @media (max-width: 768px) and (orientation: landscape) {
            .viewer-container {
                grid-template-columns: 1.5fr 1fr;
                grid-template-rows: 1fr;
                gap: 1rem;
                height: calc(100vh - 80px);
            }

            .video-section {
                height: 100%;
                display: flex;
                flex-direction: column;
            }

            .stream-video {
                flex: 1;
                margin-bottom: 1rem;
            }

            .chat-section {
                height: 100%;
                min-height: auto;
            }
        }

        /* è§¸æ‘¸å‹å¥½çš„æ¨£å¼ */
        @media (hover: none) and (pointer: coarse) {
            /* ç§»å‹•è¨­å‚™è§¸æ‘¸å„ªåŒ– */
            .nav-link,
            .user-avatar,
            .send-button,
            .play-prompt {
                min-height: 44px; /* iOS æ¨è–¦çš„æœ€å°è§¸æ‘¸å€åŸŸ */
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .nav-link {
                padding: 0.75rem 0;
            }

            .mobile-menu-toggle {
                min-height: 44px;
                min-width: 44px;
            }

            .chat-input {
                padding: 0.75rem 1rem;
                border-radius: 12px; /* æ›´åœ“æ½¤çš„é‚Šè§’ */
            }

            .send-button {
                width: 44px;
                height: 44px;
                border-radius: 12px;
            }

            /* ç§»é™¤æ‡¸åœæ•ˆæœï¼Œå› ç‚ºè§¸æ‘¸è¨­å‚™æ²’æœ‰æ‡¸åœç‹€æ…‹ */
            .nav-link:hover,
            .user-avatar:hover,
            .send-button:hover,
            .mobile-menu-toggle:hover {
                transform: none;
                box-shadow: none;
                background-color: initial;
            }

            /* æ·»åŠ è§¸æ‘¸åé¥‹ */
            .nav-link:active,
            .user-avatar:active,
            .send-button:active,
            .mobile-menu-toggle:active,
            .play-prompt:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
        }

        /* é˜²æ­¢æ–‡å­—é¸æ“‡ï¼ˆåœ¨è§¸æ‘¸è¨­å‚™ä¸Šæ”¹å–„é«”é©—ï¼‰ */
        .navbar,
        .send-button,
        .mobile-menu-toggle,
        .user-avatar {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* é‡å° iPhone X ç³»åˆ—çš„å®‰å…¨å€åŸŸ */
        @supports (padding: max(0px)) {
            .viewer-container {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
            }

            @media (max-width: 768px) {
                .viewer-container {
                    padding-left: max(0.75rem, env(safe-area-inset-left));
                    padding-right: max(0.75rem, env(safe-area-inset-right));
                    padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
                }
            }
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="images/vibelo-logo.png" alt="VibeLo" style="height: 45px; width: auto;">
                
            </a>
            
            <div class="nav-links">
                <a href="index.html" class="nav-link">é¦–é </a>
                <a href="browse.html" class="nav-link">ç€è¦½ç›´æ’­</a>
                <a href="livestream_platform.html" class="nav-link">é–‹å§‹ç›´æ’­</a>
                <a href="viewer.html" class="nav-link active">è§€çœ‹ç›´æ’­</a>
                <a href="contact.html" class="nav-link">è¯çµ¡æˆ‘å€‘</a>
            </div>

            <button class="mobile-menu-toggle" id="mobileMenuToggle" 
                    aria-label="é–‹å•Ÿé¸å–®" 
                    aria-expanded="false" 
                    aria-controls="mobileNav">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">
                    <i class="fas fa-user"></i>
                </div>
            </div>

            <!-- ç§»å‹•ç«¯ä¸‹æ‹‰èœå–® -->
            <div class="mobile-nav" id="mobileNav">
                <a href="index.html" class="nav-link">é¦–é </a>
                <a href="livestream_platform.html" class="nav-link">é–‹å§‹ç›´æ’­</a>
                <a href="viewer.html" class="nav-link active">è§€çœ‹ç›´æ’­</a>
                <a href="contact.html" class="nav-link">è¯çµ¡æˆ‘å€‘</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="viewer-container">
        <!-- è¦–é »å€åŸŸ -->
        <div class="video-section">
            <div class="stream-video" id="streamVideo">
                <div id="videoPlaceholder">
                    <h3>ğŸ“º ç­‰å¾…ä¸»æ’­é–‹å§‹ç›´æ’­</h3>
                    <p>ä¸»æ’­ä¸Šç·šå¾Œï¼Œç›´æ’­ç•«é¢æœƒè‡ªå‹•é¡¯ç¤ºåœ¨é€™è£¡</p>
                </div>
                <video id="remoteVideo" 
                       autoplay 
                       playsinline 
                       webkit-playsinline="true"
                       controls
                       style="display: none;"></video>
                <div class="play-prompt" id="playPrompt" onclick="enableAutoplay()" style="display: none;">
                    <i class="fas fa-play"></i> é»æ“Šé–‹å§‹è§€çœ‹
                </div>
            </div>

            <!-- ç›´æ’­ä¿¡æ¯ -->
            <div class="stream-header">
                <div class="streamer-info">
                    <div class="streamer-avatar" id="streamerAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="streamer-details">
                        <h3 id="streamerName">ç­‰å¾…ç›´æ’­ä¸­...</h3>
                        <p class="stream-title" id="streamTitle">ç­‰å¾…ç²¾å½©ç›´æ’­...</p>
                    </div>
                </div>
                <div class="stream-status">
                    <div class="status-text" id="statusText">ç­‰å¾…ç›´æ’­ä¸­</div>
                    <div class="live-indicator" id="liveIndicator" style="display: none;">
                        <div class="live-dot"></div>
                        <span>ç›´æ’­ä¸­</span>
                    </div>
                    <div class="viewer-count">
                        <i class="fas fa-eye"></i>
                        <span id="viewerCount">0</span> è§€çœ‹
                    </div>
                </div>
            </div>
        </div>

        <!-- èŠå¤©å€åŸŸ -->
        <div class="chat-section">
            <div class="chat-header">
                ğŸ’¬ å³æ™‚èŠå¤©å®¤
                <div class="viewer-counter">
                    ğŸ‘¥ <span id="chatViewerCount">0</span>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- èŠå¤©æ¶ˆæ¯å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
                
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <input type="text" class="chat-input" id="chatInput" placeholder="èªªé»ä»€éº¼..." maxlength="200">
                        <button class="send-button" id="sendButton">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        let currentUser = null;
        let socket = null;
        let peerConnection = null;
        let isConnected = false;
        let viewerId = 'viewer_' + Math.random().toString(36).substr(2, 9);

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentUser();
            connectWebSocket();
            setupEventListeners();
            setupMobileMenu();
            
            // é¡¯ç¤ºæ­¡è¿æ¶ˆæ¯
            displaySystemMessage('æ­¡è¿ä¾†åˆ°ç›´æ’­é–“ï¼ç­‰å¾…ä¸»æ’­é–‹å§‹ç›´æ’­...');
        });

        // è¨ºæ–·å‡½æ•¸ - æª¢æŸ¥è§€çœ¾ç«¯æ¥æ”¶ç‹€æ…‹
        function diagnoseViewerIssue() {
            console.log('=== è§€çœ¾ç«¯è¨ºæ–· ===');
            console.log('1. WebSocketé€£æ¥ç‹€æ…‹:', socket ? socket.readyState : 'æœªå»ºç«‹');
            console.log('2. WebRTCé€£æ¥ç‹€æ…‹:', peerConnection ? peerConnection.connectionState : 'æœªå»ºç«‹');
            
            const remoteVideo = document.getElementById('remoteVideo');
            console.log('3. é ç¨‹è¦–é »å…ƒç´ :', remoteVideo ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
            console.log('4. è¦–é »æµç‹€æ…‹:', remoteVideo && remoteVideo.srcObject ? 'å·²æ¥æ”¶' : 'æœªæ¥æ”¶');
            console.log('5. è¦–é »å…ƒç´ é¡¯ç¤º:', remoteVideo ? remoteVideo.style.display : 'N/A');
            console.log('6. è¦–é »æ˜¯å¦æº–å‚™å¥½:', remoteVideo ? remoteVideo.readyState : 'N/A');
            console.log('7. è¦–é »æ˜¯å¦æš«åœ:', remoteVideo ? remoteVideo.paused : 'N/A');
            console.log('8. è¦–é »æ˜¯å¦éœéŸ³:', remoteVideo ? remoteVideo.muted : 'N/A');
            console.log('9. é€£æ¥ç‹€æ…‹:', isConnected ? 'å·²é€£æ¥' : 'æœªé€£æ¥');
            console.log('10. è§€çœ¾ID:', viewerId);
            
            if (remoteVideo && remoteVideo.srcObject) {
                const stream = remoteVideo.srcObject;
                console.log('11. è¦–é »è»Œé“æ•¸é‡:', stream.getVideoTracks().length);
                console.log('12. éŸ³é »è»Œé“æ•¸é‡:', stream.getAudioTracks().length);
                
                stream.getVideoTracks().forEach((track, index) => {
                    console.log(`    è¦–é »è»Œé“ ${index}:`, {
                        readyState: track.readyState,
                        enabled: track.enabled,
                        muted: track.muted,
                        label: track.label
                    });
                });
                
                stream.getAudioTracks().forEach((track, index) => {
                    console.log(`    éŸ³é »è»Œé“ ${index}:`, {
                        readyState: track.readyState,
                        enabled: track.enabled,
                        muted: track.muted,
                        label: track.label
                    });
                });
                
                // æª¢æŸ¥è¦–é »å°ºå¯¸
                if (remoteVideo.videoWidth && remoteVideo.videoHeight) {
                    console.log('13. è¦–é »å°ºå¯¸:', `${remoteVideo.videoWidth}x${remoteVideo.videoHeight}`);
                } else {
                    console.log('13. è¦–é »å°ºå¯¸: æœªçŸ¥æˆ–æœªè¼‰å…¥');
                }
            }
            
            // æª¢æŸ¥ WebRTC é€£æ¥è©³ç´°ç‹€æ…‹
            if (peerConnection) {
                console.log('14. WebRTC è©³ç´°ç‹€æ…‹:', {
                    connectionState: peerConnection.connectionState,
                    iceConnectionState: peerConnection.iceConnectionState,
                    iceGatheringState: peerConnection.iceGatheringState,
                    signalingState: peerConnection.signalingState
                });
            }
            
            // æª¢æŸ¥é é¢å…ƒç´ ç‹€æ…‹
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            const playPrompt = document.getElementById('playPrompt');
            console.log('15. videoPlaceholder é¡¯ç¤º:', videoPlaceholder ? videoPlaceholder.style.display : 'N/A');
            console.log('16. playPrompt é¡¯ç¤º:', playPrompt ? playPrompt.style.display : 'N/A');
            
            console.log('=== è§€çœ¾ç«¯è¨ºæ–·å®Œæˆ ===');
            
            // æä¾›ä¿®å¾©å»ºè­°
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                console.warn('å»ºè­°: WebSocketé€£æ¥æœ‰å•é¡Œï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
            
            if (!peerConnection) {
                console.warn('å»ºè­°: WebRTCé€£æ¥æœªå»ºç«‹ï¼Œè«‹ç­‰å¾…ä¸»æ’­é–‹å§‹ç›´æ’­');
            }
            
            if (remoteVideo && remoteVideo.srcObject && remoteVideo.paused) {
                console.warn('å»ºè­°: è¦–é »å·²æ¥æ”¶ä½†æš«åœï¼Œè«‹é»æ“Šæ’­æ”¾æŒ‰éˆ•');
            }
            
            if (remoteVideo && !remoteVideo.srcObject) {
                console.warn('å»ºè­°: æœªæ¥æ”¶åˆ°è¦–é »æµï¼Œè«‹æª¢æŸ¥ä¸»æ’­æ˜¯å¦æ­£åœ¨ç›´æ’­');
            }
        }

        // åœ¨æ§åˆ¶å°ä¸­å¯ä»¥èª¿ç”¨ diagnoseViewerIssue() ä¾†è¨ºæ–·å•é¡Œ
        window.diagnoseViewerIssue = diagnoseViewerIssue;

        // å¼·åˆ¶é‡æ–°é€£æ¥å‡½æ•¸ - ç”¨æ–¼èª¿è©¦
        function forceReconnect() {
            console.log('å¼·åˆ¶é‡æ–°é€£æ¥...');
            
            // é—œé–‰ç¾æœ‰é€£æ¥
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // é‡ç½®è¦–é »å…ƒç´ 
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo) {
                remoteVideo.srcObject = null;
                remoteVideo.style.display = 'none';
            }
            
            // é¡¯ç¤ºç­‰å¾…ç•«é¢
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            if (videoPlaceholder) {
                videoPlaceholder.style.display = 'block';
            }
            
            // éš±è—æ’­æ”¾æŒ‰éˆ•
            const playPrompt = document.getElementById('playPrompt');
            if (playPrompt) {
                playPrompt.style.display = 'none';
            }
            
            // é‡æ–°åˆå§‹åŒ–é€£æ¥
            setTimeout(() => {
                if (socket && isConnected) {
                    socket.send(JSON.stringify({
                        type: 'viewer_join',
                        viewerId: viewerId,
                        streamerId: targetStreamerId,
                        userInfo: currentUser || { displayName: `è§€çœ¾${viewerId.substr(-3)}`, avatarUrl: null }
                    }));
                    console.log('å·²ç™¼é€é‡æ–°åŠ å…¥è«‹æ±‚');
                }
            }, 1000);
            
            displaySystemMessage('ğŸ”„ æ­£åœ¨é‡æ–°é€£æ¥...');
        }
        
        window.forceReconnect = forceReconnect;

        // ç²å–URLåƒæ•¸ä¸­çš„ä¸»æ’­ID
        function getStreamerIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('streamer') || 'default';
        }

        // å…¨å±€è®Šæ•¸å­˜å„²ä¸»æ’­ID
        let targetStreamerId = getStreamerIdFromUrl();

        // è¼‰å…¥ç•¶å‰ç”¨æˆ¶
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/user/current');
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    updateUserDisplay(currentUser);
                } else {
                    showGuestMode();
                }
            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:', error);
                showGuestMode();
            }
        }

        // æ›´æ–°ç”¨æˆ¶é¡¯ç¤º
        function updateUserDisplay(user) {
            const userAvatar = document.getElementById('userAvatar');
            
            if (user.avatarUrl) {
                userAvatar.innerHTML = `<img src="${user.avatarUrl}" alt="${user.displayName}">`;
            } else {
                const initial = user.displayName.charAt(0).toUpperCase();
                userAvatar.innerHTML = initial;
            }
        }

        // è¨ªå®¢æ¨¡å¼
        function showGuestMode() {
            const userAvatar = document.getElementById('userAvatar');
            userAvatar.innerHTML = '<i class="fas fa-user"></i>';
        }

        // é€£æ¥ WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                console.log('WebSocket é€£æ¥æˆåŠŸ');
                isConnected = true;
                
                // ä½œç‚ºè§€çœ¾åŠ å…¥
                socket.send(JSON.stringify({
                    type: 'viewer_join',
                    viewerId: viewerId,
                    streamerId: targetStreamerId,
                    userInfo: currentUser || { displayName: `è§€çœ¾${viewerId.substr(-3)}`, avatarUrl: null }
                }));
                
                displaySystemMessage('å·²é€£æ¥åˆ°ç›´æ’­é–“');
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            socket.onclose = function() {
                console.log('WebSocket é€£æ¥é—œé–‰');
                isConnected = false;
                displaySystemMessage('é€£æ¥å·²æ–·é–‹ï¼Œæ­£åœ¨é‡æ–°é€£æ¥...');
                // å˜—è©¦é‡æ–°é€£æ¥
                setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket éŒ¯èª¤:', error);
                displaySystemMessage('é€£æ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
            };
        }

        // è™•ç† WebSocket æ¶ˆæ¯
        function handleWebSocketMessage(data) {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
            
            switch(data.type) {
                case 'viewer_joined':
                    displaySystemMessage('å·²æˆåŠŸåŠ å…¥ç›´æ’­é–“');
                    
                    // ä¿å­˜æœå‹™å™¨åˆ†é…çš„ç”¨æˆ¶ä¿¡æ¯
                    if (data.userInfo) {
                        if (data.userInfo.isGuest && data.userInfo.displayName) {
                            window.assignedGhostName = data.userInfo.displayName;
                            console.log('æ”¶åˆ°æœå‹™å™¨åˆ†é…çš„Ghoståç¨±:', window.assignedGhostName);
                            
                            // æ›´æ–°èŠå¤©ç³»çµ±ç”¨æˆ¶å
                            if (window.updateChatSystemUsername) {
                                window.updateChatSystemUsername();
                            }
                            
                            // æ›´æ–°é é¢é¡¯ç¤ºçš„ç”¨æˆ¶å
                            updateDisplayedUserName();
                        }
                    }
                    
                    // è™•ç†ä¸»æ’­ä¿¡æ¯
                    if (data.broadcasterInfo) {
                        updateBroadcasterInfo(data.broadcasterInfo);
                    }
                    break;
                case 'broadcaster_info':
                    // è™•ç†ä¸»æ’­ä¿¡æ¯ï¼ˆç•¶ä¸»æ’­æœªåœ¨ç›´æ’­æ™‚ï¼‰
                    if (data.broadcasterInfo) {
                        updateBroadcasterInfo(data.broadcasterInfo);
                        displaySystemMessage(data.message || 'ç­‰å¾…ä¸»æ’­é–‹å§‹ç›´æ’­');
                    }
                    break;
                case 'stream_start':
                    handleStreamStarted(data);
                    break;
                case 'stream_status':
                    handleStreamStatus(data);
                    break;
                case 'stream_end':
                    handleStreamEnded();
                    break;
                case 'title_update':
                    handleTitleUpdate(data);
                    break;
                case 'chat_message':
                    // èˆŠæ ¼å¼çš„èŠå¤©æ¶ˆæ¯ï¼Œè½‰æ›ç‚ºæ–°æ ¼å¼å¾Œç”±ChatSystemè™•ç†
                    if (window.chatSystem && window.chatSystem.handleMessage) {
                        window.chatSystem.handleMessage({
                            type: 'chat',
                            role: data.isStreamer ? 'broadcaster' : 'viewer',
                            username: data.username || 'åŒ¿åç”¨æˆ¶',
                            message: data.text || data.message || '',
                            timestamp: data.timestamp
                        });
                    } else {
                        displayChatMessage(data);
                    }
                    break;
                case 'chat':
                    // æ–°çš„çµ±ä¸€èŠå¤©å”è­° - ä¸åœ¨é€™è£¡è™•ç†ï¼Œå®Œå…¨äº¤çµ¦ChatSystem
                    // ChatSystemå·²ç¶“é€šéè‡ªå·±çš„WebSocketç›£è½å™¨è™•ç†äº†é€™äº›æ¶ˆæ¯
                    console.log('[VIEWER] chaté¡å‹æ¶ˆæ¯ç”±ChatSystemç›´æ¥è™•ç†ï¼Œè·³éé‡è¤‡è™•ç†');
                    break;
                    break;
                case 'viewer_count_update':
                    updateViewerCount(data.count);
                    break;
                case 'offer':
                    handleOffer(data.offer);
                    break;
                case 'ice_candidate':
                    handleIceCandidate(data.candidate);
                    break;
                case 'ack':
                    console.log('æ”¶åˆ°ç¢ºèª:', data);
                    break;
                default:
                    console.log('æœªçŸ¥æ¶ˆæ¯é¡å‹:', data.type);
            }
        }

        // è™•ç†ç›´æ’­é–‹å§‹
        function handleStreamStarted(data) {
            console.log('ç›´æ’­é–‹å§‹:', data);
            
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            const liveIndicator = document.getElementById('liveIndicator');
            const streamTitle = document.getElementById('streamTitle');
            const streamerName = document.getElementById('streamerName');
            const statusText = document.getElementById('statusText');
            
            if (videoPlaceholder) videoPlaceholder.style.display = 'none';
            if (liveIndicator) liveIndicator.style.display = 'flex';
            
            // æ›´æ–°ä¸»æ’­åç¨±ç‚ºç›´æ’­ç‹€æ…‹
            if (streamerName) {
                // å˜—è©¦å¾å·²å­˜å„²çš„ä¸»æ’­ä¿¡æ¯ç²å–åç¨±ï¼Œæˆ–ä½¿ç”¨é è¨­å€¼
                const broadcasterName = window.currentBroadcasterName || 'ä¸»æ’­';
                streamerName.textContent = `${broadcasterName} æ­£åœ¨ç›´æ’­`;
            }
            
            // æ›´æ–°ç‹€æ…‹æ–‡å­—
            if (statusText) {
                statusText.textContent = 'ç›´æ’­ä¸­';
                statusText.className = 'status-text live';
            }
            
            // æ›´æ–°ç›´æ’­æ¨™é¡Œ
            if (streamTitle) {
                if (data.title && data.title.trim() !== '') {
                    streamTitle.textContent = data.title;
                    console.log('ç›´æ’­é–‹å§‹ï¼Œæ¨™é¡Œ:', data.title);
                } else {
                    streamTitle.textContent = 'ç²¾å½©ç›´æ’­ä¸­';
                    console.log('ç›´æ’­é–‹å§‹ï¼Œä½¿ç”¨é è¨­æ¨™é¡Œ');
                }
                
                // ç‚ºç›´æ’­é–‹å§‹æ·»åŠ ä¸€å€‹ç‰¹æ®Šçš„å‹•ç•«æ•ˆæœ
                streamTitle.classList.add('updating');
                streamTitle.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    streamTitle.style.transform = 'scale(1)';
                    streamTitle.classList.remove('updating');
                }, 500);
            }
            
            displaySystemMessage('ğŸ‰ ä¸»æ’­å·²é–‹å§‹ç›´æ’­ï¼');
            
            // åˆå§‹åŒ– WebRTC é€£æ¥
            initializePeerConnection();
        }

        // è™•ç†ç›´æ’­æ¨™é¡Œæ›´æ–°
        function handleTitleUpdate(data) {
            console.log('æ”¶åˆ°æ¨™é¡Œæ›´æ–°:', data);
            
            const streamTitle = document.getElementById('streamTitle');
            if (streamTitle) {
                // æ·»åŠ æ›´æ–°å‹•ç•«é¡
                streamTitle.classList.add('updating');
                
                if (data.title && data.title.trim() !== '') {
                    streamTitle.textContent = data.title;
                    console.log('æ¨™é¡Œå·²æ›´æ–°ç‚º:', data.title);
                    
                    // é¡¯ç¤ºä¸€å€‹ç°¡çŸ­çš„é€šçŸ¥
                    displaySystemMessage(`ğŸ“ ç›´æ’­æ¨™é¡Œå·²æ›´æ–°: ${data.title}`);
                } else {
                    streamTitle.textContent = 'ç›´æ’­é€²è¡Œä¸­';
                    console.log('æ¨™é¡Œå·²é‡ç½®ç‚ºé è¨­å€¼');
                    displaySystemMessage('ğŸ“ ç›´æ’­æ¨™é¡Œå·²é‡ç½®');
                }
                
                // æ·»åŠ ä¸€å€‹æ›´æ˜é¡¯çš„å‹•ç•«æ•ˆæœ
                streamTitle.style.transform = 'scale(1.05)';
                
                // 300mså¾Œç§»é™¤å‹•ç•«æ•ˆæœ
                setTimeout(() => {
                    streamTitle.style.transform = 'scale(1)';
                    streamTitle.classList.remove('updating');
                }, 300);
            }
        }

        // è™•ç†ç›´æ’­ç‹€æ…‹æ›´æ–°
        function handleStreamStatus(data) {
            console.log('æ”¶åˆ°ç›´æ’­ç‹€æ…‹æ›´æ–°:', data);
            
            const statusText = document.getElementById('statusText');
            const streamTitle = document.getElementById('streamTitle');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            const liveIndicator = document.getElementById('liveIndicator');
            
            if (data.status === 'live') {
                // ç›´æ’­é€²è¡Œä¸­
                if (statusText) statusText.textContent = '';
                if (videoPlaceholder) videoPlaceholder.style.display = 'none';
                if (liveIndicator) liveIndicator.style.display = 'flex';
                
                // æ›´æ–°æ¨™é¡Œ
                if (streamTitle && data.title) {
                    streamTitle.textContent = data.title;
                    
                    // æ·»åŠ ç‹€æ…‹æ›´æ–°å‹•ç•«
                    streamTitle.classList.add('updating');
                    streamTitle.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        streamTitle.style.transform = 'scale(1)';
                        streamTitle.classList.remove('updating');
                    }, 300);
                }
                
                displaySystemMessage('ğŸ”´ ç›´æ’­æ­£åœ¨é€²è¡Œä¸­ï¼');
                
                // å¦‚æœé‚„æ²’æœ‰ WebRTC é€£æ¥ï¼Œå˜—è©¦åˆå§‹åŒ–
                if (!peerConnection || peerConnection.connectionState === 'closed') {
                    initializePeerConnection();
                }
            } else if (data.status === 'starting') {
                // ç›´æ’­æº–å‚™ä¸­
                if (statusText) statusText.textContent = 'ç›´æ’­æº–å‚™ä¸­...';
                if (streamTitle && data.title) {
                    streamTitle.textContent = data.title;
                }
                displaySystemMessage('â³ ç›´æ’­å³å°‡é–‹å§‹...');
            }
        }

        // æ›´æ–°ä¸»æ’­ä¿¡æ¯é¡¯ç¤º
        function updateBroadcasterInfo(broadcasterInfo) {
            console.log('æ›´æ–°ä¸»æ’­ä¿¡æ¯:', broadcasterInfo);
            
            // å­˜å„²ä¸»æ’­åç¨±åˆ°å…¨å±€è®Šé‡
            window.currentBroadcasterName = broadcasterInfo.displayName || 'ä¸»æ’­';
            
            const streamerName = document.getElementById('streamerName');
            const streamerAvatar = document.getElementById('streamerAvatar');
            const statusText = document.getElementById('statusText');
            
            if (streamerName && broadcasterInfo.displayName) {
                // é¡¯ç¤º"ç­‰å¾…ä¸»æ’­XXXé–‹å§‹ç›´æ’­"è€Œä¸æ˜¯"ç­‰å¾…ç›´æ’­ä¸­"
                streamerName.textContent = `ç­‰å¾…ä¸»æ’­ ${broadcasterInfo.displayName} é–‹å§‹ç›´æ’­`;
            }
            
            if (streamerAvatar) {
                if (broadcasterInfo.avatarUrl) {
                    streamerAvatar.innerHTML = `<img src="${broadcasterInfo.avatarUrl}" alt="${broadcasterInfo.displayName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                } else {
                    streamerAvatar.innerHTML = '<i class="fas fa-user"></i>';
                }
            }
            
            if (statusText) {
                statusText.textContent = `ç­‰å¾… ${broadcasterInfo.displayName} é–‹å§‹ç›´æ’­`;
                statusText.className = 'status-text waiting';
            }
        }

        // è™•ç†ç›´æ’­çµæŸ
        function handleStreamEnded() {
            console.log('ç›´æ’­çµæŸ');
            
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            const liveIndicator = document.getElementById('liveIndicator');
            const remoteVideo = document.getElementById('remoteVideo');
            const playPrompt = document.getElementById('playPrompt');
            const streamTitle = document.getElementById('streamTitle');
            
            if (videoPlaceholder) videoPlaceholder.style.display = 'block';
            if (liveIndicator) liveIndicator.style.display = 'none';
            if (remoteVideo) remoteVideo.style.display = 'none';
            if (playPrompt) playPrompt.style.display = 'none';
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            displaySystemMessage('ğŸ“º ç›´æ’­å·²çµæŸï¼Œæ„Ÿè¬è§€çœ‹ï¼');
            
            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            const statusText = document.getElementById('statusText');
            if (statusText) {
                statusText.textContent = 'ç­‰å¾…ç›´æ’­ä¸­';
                statusText.className = 'status-text';
            }
            
            // é‡ç½®ä¸»æ’­ä¿¡æ¯å’Œæ¨™é¡Œ
            document.getElementById('streamerName').textContent = 'ç­‰å¾…ç›´æ’­ä¸­...';
            document.getElementById('streamerAvatar').innerHTML = '<i class="fas fa-user"></i>';
            
            // é‡ç½®æ¨™é¡Œæ™‚æ·»åŠ å‹•ç•«æ•ˆæœ
            if (streamTitle) {
                streamTitle.classList.add('updating');
                streamTitle.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    streamTitle.textContent = 'ç­‰å¾…ç²¾å½©ç›´æ’­...';
                    streamTitle.style.transform = 'scale(1)';
                    streamTitle.classList.remove('updating');
                }, 300);
            }
        }

        // åˆå§‹åŒ– WebRTC é€£æ¥
        function initializePeerConnection() {
            console.log('åˆå§‹åŒ– WebRTC é€£æ¥');
            
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(configuration);
            
            peerConnection.ontrack = function(event) {
                console.log('æ”¶åˆ°é ç¨‹è¦–é »æµ', event);
                const remoteVideo = document.getElementById('remoteVideo');
                const videoPlaceholder = document.getElementById('videoPlaceholder');
                const playPrompt = document.getElementById('playPrompt');
                
                if (remoteVideo && event.streams && event.streams[0]) {
                    console.log('è¨­ç½®è¦–é »æµåˆ° video å…ƒç´ ');
                    remoteVideo.srcObject = event.streams[0];
                    
                    // ç¢ºä¿è¦–é »å…ƒç´ é¡¯ç¤º
                    remoteVideo.style.display = 'block';
                    if (videoPlaceholder) videoPlaceholder.style.display = 'none';
                    
                    // ç›£è½è¦–é »å…ƒç´ çš„äº‹ä»¶
                    remoteVideo.onloadedmetadata = function() {
                        console.log('è¦–é »å…ƒæ•¸æ“šå·²è¼‰å…¥');
                        console.log('è¦–é »å°ºå¯¸:', remoteVideo.videoWidth, 'x', remoteVideo.videoHeight);
                    };
                    
                    remoteVideo.onloadeddata = function() {
                        console.log('è¦–é »æ•¸æ“šå·²è¼‰å…¥ï¼Œæº–å‚™æ’­æ”¾');
                    };
                    
                    remoteVideo.oncanplay = function() {
                        console.log('è¦–é »å¯ä»¥é–‹å§‹æ’­æ”¾');
                    };
                    
                    remoteVideo.onplay = function() {
                        console.log('è¦–é »é–‹å§‹æ’­æ”¾');
                        if (playPrompt) playPrompt.style.display = 'none';
                    };
                    
                    remoteVideo.onerror = function(error) {
                        console.error('è¦–é »æ’­æ”¾éŒ¯èª¤:', error);
                        displaySystemMessage('è¦–é »æ’­æ”¾éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                    };
                    
                    // å˜—è©¦è‡ªå‹•æ’­æ”¾
                    remoteVideo.play().then(() => {
                        console.log('è‡ªå‹•æ’­æ”¾æˆåŠŸ');
                        displaySystemMessage('ğŸ¬ è¦–é »å·²é–‹å§‹æ’­æ”¾');
                    }).catch(error => {
                        console.log('è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œé¡¯ç¤ºæ’­æ”¾æç¤º:', error);
                        if (playPrompt) {
                            playPrompt.style.display = 'block';
                            displaySystemMessage('è«‹é»æ“Šæ’­æ”¾æŒ‰éˆ•é–‹å§‹è§€çœ‹');
                        }
                    });
                } else {
                    console.error('æœªæ”¶åˆ°æœ‰æ•ˆçš„è¦–é »æµ');
                }
            };
            
            peerConnection.onicecandidate = function(event) {
                if (event.candidate && socket && isConnected) {
                    socket.send(JSON.stringify({
                        type: 'ice_candidate',
                        candidate: event.candidate,
                        viewerId: viewerId
                    }));
                }
            };
            
            peerConnection.onconnectionstatechange = function() {
                console.log('WebRTC é€£æ¥ç‹€æ…‹:', peerConnection.connectionState);
                if (peerConnection.connectionState === 'connected') {
                    displaySystemMessage('è¦–é »ä¸²æµå·²é€£æ¥');
                } else if (peerConnection.connectionState === 'disconnected') {
                    displaySystemMessage('è¦–é »ä¸²æµå·²æ–·é–‹');
                }
            };
        }

        // è™•ç† WebRTC Offer
        async function handleOffer(offer) {
            console.log('è™•ç† WebRTC Offer');
            
            if (!peerConnection) {
                initializePeerConnection();
            }
            
            try {
                await peerConnection.setRemoteDescription(offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                if (socket && isConnected) {
                    socket.send(JSON.stringify({
                        type: 'answer',
                        answer: answer,
                        viewerId: viewerId
                    }));
                }
            } catch (error) {
                console.error('è™•ç† offer å¤±æ•—:', error);
                displaySystemMessage('è¦–é »é€£æ¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
            }
        }

        // è™•ç† ICE Candidate
        async function handleIceCandidate(candidate) {
            if (peerConnection) {
                try {
                    await peerConnection.addIceCandidate(candidate);
                } catch (error) {
                    console.error('æ·»åŠ  ICE candidate å¤±æ•—:', error);
                }
            }
        }

        // å•Ÿç”¨è‡ªå‹•æ’­æ”¾
        function enableAutoplay() {
            const remoteVideo = document.getElementById('remoteVideo');
            const playPrompt = document.getElementById('playPrompt');
            
            console.log('ç”¨æˆ¶é»æ“Šæ’­æ”¾æŒ‰éˆ•');
            
            if (remoteVideo && remoteVideo.srcObject) {
                console.log('å˜—è©¦æ’­æ”¾è¦–é »');
                
                // ç¢ºä¿è¦–é »ä¸æ˜¯éœéŸ³çš„
                remoteVideo.muted = false;
                
                remoteVideo.play().then(() => {
                    console.log('æ‰‹å‹•æ’­æ”¾æˆåŠŸ');
                    if (playPrompt) playPrompt.style.display = 'none';
                    displaySystemMessage('ğŸ¬ è¦–é »å·²é–‹å§‹æ’­æ”¾');
                }).catch(error => {
                    console.error('æ‰‹å‹•æ’­æ”¾å¤±æ•—:', error);
                    displaySystemMessage('æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­ç½®');
                });
            } else {
                console.error('æ²’æœ‰å¯æ’­æ”¾çš„è¦–é »æµ');
                displaySystemMessage('æ²’æœ‰å¯æ’­æ”¾çš„è¦–é »æµï¼Œè«‹ç­‰å¾…ä¸»æ’­é–‹å§‹ç›´æ’­');
            }
        }

        // ç™¼é€èŠå¤©æ¶ˆæ¯
        // åŸç”ŸsendMessageå‡½æ•¸å·²ç¦ç”¨ï¼Œå®Œå…¨ä½¿ç”¨ChatSystem
        /*
        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            if (!socket || !isConnected) {
                displaySystemMessage('é€£æ¥å·²æ–·é–‹ï¼Œè«‹åˆ·æ–°é é¢é‡æ–°é€£æ¥');
                return;
            }
            
            const userName = currentUser ? currentUser.displayName : `è§€çœ¾${viewerId.substr(-3)}`;
            const userAvatar = currentUser ? currentUser.avatarUrl : null;
            
            // ä½¿ç”¨çµ±ä¸€çš„ chat å”è­°
            socket.send(JSON.stringify({
                type: 'chat',
                role: 'viewer',
                username: userName,
                message: message,
                userAvatar: userAvatar,
                timestamp: new Date().toISOString(),
                viewerId: viewerId
            }));
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            chatInput.value = '';
        }
        */

        // é¡¯ç¤ºèŠå¤©æ¶ˆæ¯
        function displayChatMessage(data) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            const time = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageElement.innerHTML = `
                <div class="message-avatar">
                    ${data.userAvatar ? 
                        `<img src="${data.userAvatar}" alt="${data.username}">` : 
                        (data.username.charAt(0).toUpperCase())
                    }
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-user">${data.username}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${data.text}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // é¡¯ç¤ºç³»çµ±æ¶ˆæ¯
        function displaySystemMessage(text) {
            displayChatMessage({
                username: 'ç³»çµ±',
                text: text,
                userAvatar: null,
                timestamp: new Date().toISOString()
            });
        }

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨ - ä¸å†è¨­ç½®èŠå¤©ç›¸é—œäº‹ä»¶ï¼Œäº¤çµ¦ChatSystemè™•ç†
        function setupEventListeners() {
            // èŠå¤©äº‹ä»¶ç›£è½å™¨å·²ç§»é™¤ï¼Œç”±ChatSystemå®Œå…¨è™•ç†
        }

        // è¨­ç½®ç§»å‹•ç«¯èœå–®
        function setupMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const mobileNav = document.getElementById('mobileNav');
            
            if (mobileMenuToggle && mobileNav) {
                mobileMenuToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isActive = mobileNav.classList.toggle('active');
                    
                    // æ›´æ–°å¯è¨ªå•æ€§å±¬æ€§
                    mobileMenuToggle.setAttribute('aria-expanded', isActive);
                    mobileMenuToggle.setAttribute('aria-label', isActive ? 'é—œé–‰é¸å–®' : 'é–‹å•Ÿé¸å–®');
                    
                    // åˆ‡æ›åœ–æ¨™
                    const icon = mobileMenuToggle.querySelector('i');
                    if (isActive) {
                        icon.className = 'fas fa-times';
                    } else {
                        icon.className = 'fas fa-bars';
                    }
                });

                // é»æ“Šé é¢å…¶ä»–åœ°æ–¹é—œé–‰èœå–®
                document.addEventListener('click', function() {
                    if (mobileNav.classList.contains('active')) {
                        mobileNav.classList.remove('active');
                        mobileMenuToggle.setAttribute('aria-expanded', 'false');
                        mobileMenuToggle.setAttribute('aria-label', 'é–‹å•Ÿé¸å–®');
                        const icon = mobileMenuToggle.querySelector('i');
                        icon.className = 'fas fa-bars';
                    }
                });

                // é˜»æ­¢èœå–®å…§éƒ¨é»æ“Šå†’æ³¡
                mobileNav.addEventListener('click', function(e) {
                    e.stopPropagation();
                });

                // çª—å£å¤§å°æ”¹è®Šæ™‚éš±è—ç§»å‹•ç«¯èœå–®
                window.addEventListener('resize', function() {
                    if (window.innerWidth > 768 && mobileNav.classList.contains('active')) {
                        mobileNav.classList.remove('active');
                        mobileMenuToggle.setAttribute('aria-expanded', 'false');
                        mobileMenuToggle.setAttribute('aria-label', 'é–‹å•Ÿé¸å–®');
                        const icon = mobileMenuToggle.querySelector('i');
                        icon.className = 'fas fa-bars';
                    }
                });

                // ESC éµé—œé–‰èœå–®
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && mobileNav.classList.contains('active')) {
                        mobileNav.classList.remove('active');
                        mobileMenuToggle.setAttribute('aria-expanded', 'false');
                        mobileMenuToggle.setAttribute('aria-label', 'é–‹å•Ÿé¸å–®');
                        const icon = mobileMenuToggle.querySelector('i');
                        icon.className = 'fas fa-bars';
                        mobileMenuToggle.focus(); // è¿”å›ç„¦é»åˆ°æŒ‰éˆ•
                    }
                });
            }
        }

        // æ›´æ–°è§€çœ‹äººæ•¸
        function updateViewerCount(count) {
            const viewerCountEl = document.getElementById('viewerCount');
            const chatViewerCountEl = document.getElementById('chatViewerCount');
            
            if (viewerCountEl) viewerCountEl.textContent = count;
            if (chatViewerCountEl) chatViewerCountEl.textContent = count;
        }

        // ç”¨æˆ¶é¸å–®åŠŸèƒ½
        // currentUser è®Šæ•¸å·²åœ¨å‰é¢è²æ˜

        // åˆ‡æ›ç”¨æˆ¶é¸å–®
        function toggleUserMenu() {
            console.log('toggleUserMenu è¢«èª¿ç”¨ï¼ŒcurrentUser:', currentUser);
            
            // å¦‚æœç”¨æˆ¶æœªç™»å…¥ï¼Œç›´æ¥é‡å®šå‘åˆ°ç™»å…¥é é¢
            if (!currentUser) {
                console.log('æœªç™»å…¥ç”¨æˆ¶é»æ“Šé ­åƒï¼Œé‡å®šå‘åˆ°ç™»å…¥é é¢');
                window.location.href = 'login.html';
                return;
            }
            
            // ç§»é™¤ç¾æœ‰é¸å–®
            const existingMenu = document.querySelector('.user-dropdown');
            if (existingMenu) {
                console.log('ç§»é™¤ç¾æœ‰é¸å–®');
                existingMenu.style.opacity = '0';
                existingMenu.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (existingMenu.parentNode) {
                        existingMenu.remove();
                    }
                }, 150);
                return;
            }
            
            // ç²å–ç•¶å‰ç”¨æˆ¶åç¨±
            const userAvatar = document.getElementById('userAvatar');
            if (!userAvatar) {
                console.error('ç”¨æˆ¶é ­åƒå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            console.log('å‰µå»ºæ–°çš„ä¸‹æ‹‰é¸å–®');
            
            const currentUserName = getCurrentUserName() || 'Ghost_è§€çœ¾';
            
            // å‰µå»ºä¸‹æ‹‰é¸å–® - å·²ç™»å…¥è§€çœ¾ç‰ˆæœ¬
            const menu = document.createElement('div');
            menu.className = 'user-dropdown';
            menu.style.opacity = '0';
            menu.style.transform = 'translateY(-10px)';
            menu.style.transition = 'all 0.15s ease-out';
            
            // å·²ç™»å…¥è§€çœ¾é¸å–®
            menu.innerHTML = `
                <div class="menu-user-info">
                    <div class="menu-user-name">${currentUserName}</div>
                </div>
                <a href="livestream_platform.html" class="menu-link">
                    <i class="fas fa-video"></i>
                    æˆ‘è¦ç›´æ’­
                </a>
                <a href="index.html" class="menu-link">
                    <i class="fas fa-home"></i>
                    å›åˆ°é¦–é 
                </a>
                <a href="#" onclick="logout(); event.preventDefault();" class="menu-link logout">
                    <i class="fas fa-sign-out-alt"></i>
                    ç™»å‡º
                </a>
            `;
            
            // ç¢ºä¿userAvataræ˜¯ä¸€å€‹å®¹å™¨ï¼Œå¦‚æœä¸æ˜¯å‰‡åŒ…è£å®ƒ
            let container = userAvatar;
            if (userAvatar.style.position !== 'relative') {
                userAvatar.style.position = 'relative';
            }
            
            container.appendChild(menu);
            console.log('é¸å–®å·²æ·»åŠ åˆ°DOM');
            
            // é¡¯ç¤ºå‹•ç•«
            setTimeout(() => {
                menu.style.opacity = '1';
                menu.style.transform = 'translateY(0)';
                console.log('é¸å–®å‹•ç•«å·²è§¸ç™¼');
            }, 10);
            
            // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
            setTimeout(() => {
                function closeMenu(e) {
                    if (!menu.contains(e.target) && !container.contains(e.target)) {
                        console.log('é—œé–‰é¸å–®');
                        menu.style.opacity = '0';
                        menu.style.transform = 'translateY(-10px)';
                        setTimeout(() => {
                            if (menu.parentNode) {
                                menu.remove();
                            }
                        }, 150);
                        document.removeEventListener('click', closeMenu);
                    }
                }
                document.addEventListener('click', closeMenu);
            }, 100);
        }

        // ç²å–ç•¶å‰ç”¨æˆ¶åç¨±
        function getCurrentUserName() {
            if (currentUser) {
                return currentUser.displayName || currentUser.username || 'è§€çœ¾';
            }
            return 'Ghost_è§€çœ¾';
        }

        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = '/login.html';
                } else {
                    alert('ç™»å‡ºå¤±æ•—ï¼š' + data.message);
                }
            } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
                alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // é é¢å¸è¼‰æ™‚æ¸…ç†é€£æ¥
        window.addEventListener('beforeunload', function() {
            if (peerConnection) {
                peerConnection.close();
            }
            if (socket) {
                socket.close();
            }
            if (window.chatSystem) {
                window.chatSystem.destroy();
            }
        });
    </script>
    <script src="chat-system.js"></script>
    <script>
        // åˆå§‹åŒ–èŠå¤©ç³»çµ±ç‚ºè§€çœ¾æ¨¡å¼ - å»¶é²åˆ°WebSocketé€£æ¥å»ºç«‹å¾Œ
        function initChatSystemWhenReady() {
            // æª¢æŸ¥ WebSocket æ˜¯å¦å·²é€£æ¥
            if (socket && socket.readyState === WebSocket.OPEN) {
                console.log('WebSocket å·²é€£æ¥ï¼Œåˆå§‹åŒ–èŠå¤©ç³»çµ±');
                
                if (window.initChatSystem) {
                    // ç²å–ç”¨æˆ¶çœŸå¯¦å§“åæˆ–Ghoståç¨±
                    let username = 'è§€çœ¾';
                    
                    // å„ªå…ˆä½¿ç”¨ç™»å…¥ç”¨æˆ¶çš„çœŸå¯¦å§“å
                    if (window.currentUser && window.currentUser.displayName) {
                        username = window.currentUser.displayName;
                    } 
                    // å¦‚æœæ˜¯è¨ªå®¢ï¼Œä½¿ç”¨æœå‹™å™¨åˆ†é…çš„Ghoståç¨±
                    else if (window.assignedGhostName) {
                        username = window.assignedGhostName;
                        console.log('ä½¿ç”¨æœå‹™å™¨åˆ†é…çš„Ghoståç¨±:', username);
                    }
                    // å¦å‰‡ä½¿ç”¨é€šç”¨è§€çœ¾åç¨±
                    else if (window.getCurrentUser && typeof window.getCurrentUser === 'function') {
                        const user = window.getCurrentUser();
                        if (user && user !== 'ä¸»æ’­') {
                            username = user;
                        }
                    }
                    
                    console.log('èŠå¤©ç³»çµ±ç”¨æˆ¶å:', username);
                    
                    // ä½¿ç”¨ç¾æœ‰çš„ WebSocket é€£æ¥
                    window.initChatSystem({
                        isStreamer: false,
                        username: username,
                        socket: socket,  // å‚³å…¥ç¾æœ‰çš„ WebSocket é€£æ¥
                        selectors: {
                            chatContainer: '#chatMessages',
                            messageInput: '#chatInput',
                            sendButton: '#sendButton'
                        }
                    });
                }
            } else {
                console.log('WebSocket å°šæœªé€£æ¥ï¼Œ500ms å¾Œé‡è©¦...');
                setTimeout(initChatSystemWhenReady, 500);
            }
        }

        // æ›´æ–°é é¢é¡¯ç¤ºçš„ç”¨æˆ¶å
        function updateDisplayedUserName() {
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar && window.assignedGhostName) {
                // æ›´æ–°ç”¨æˆ¶é ­åƒé¡¯ç¤ºç‚ºGhoståç¨±çš„ç¬¬ä¸€å€‹å­—æ¯
                const initial = window.assignedGhostName.charAt(0).toUpperCase();
                userAvatar.innerHTML = initial;
                userAvatar.title = window.assignedGhostName; // æ·»åŠ hoveræç¤º
                console.log('å·²æ›´æ–°é é¢é¡¯ç¤ºçš„ç”¨æˆ¶åç‚º:', window.assignedGhostName);
            }
        }

        // æ›´æ–°èŠå¤©ç³»çµ±ç”¨æˆ¶åï¼ˆç•¶ç²å¾—Ghoståç¨±å¾Œèª¿ç”¨ï¼‰
        function updateChatSystemUsername() {
            if (window.chatSystem && window.assignedGhostName) {
                // æ›´æ–°ChatSystemçš„ç”¨æˆ¶å
                window.chatSystem.username = window.assignedGhostName;
                console.log('å·²æ›´æ–°èŠå¤©ç³»çµ±ç”¨æˆ¶åç‚º:', window.assignedGhostName);
                
                // é‡æ–°ç™¼é€èº«ä»½è­˜åˆ¥
                if (window.chatSystem.sendIdentification) {
                    window.chatSystem.sendIdentification();
                }
            }
        }

        // åœ¨é é¢åŠ è¼‰å’Œ WebSocket é€£æ¥å¾Œåˆå§‹åŒ–èŠå¤©ç³»çµ±
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶é²åˆå§‹åŒ–ï¼Œç­‰å¾… WebSocket é€£æ¥
            setTimeout(initChatSystemWhenReady, 1000);
        });
    </script>
</body>
</html>